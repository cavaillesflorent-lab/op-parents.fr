<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation - OP! √âducation financi√®re des parents</title>
    <meta name="description" content="D√©couvrez cette formation sur la gestion financi√®re familiale.">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <!-- HEADER -->
    <div id="header-placeholder"></div>

    <main>
        <!-- HERO (charg√© dynamiquement) -->
        <section class="page-hero" id="formation-hero">
            <div class="page-hero-content">
                <span class="page-hero-badge">üìö Formation</span>
                <h1 id="hero-title">Chargement...</h1>
                <p id="hero-description"></p>
            </div>
            <div class="page-hero-decoration">
                <div class="hero-circle circle-1"></div>
                <div class="hero-circle circle-2"></div>
                <div class="hero-circle circle-3"></div>
            </div>
        </section>

        <!-- BREADCRUMB + CONTENU -->
        <section class="formation-detail-section">
            <div class="container">
                <nav class="breadcrumb">
                    <a href="index.html">Accueil</a>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <a href="formations.html">Formations</a>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span id="breadcrumb-title">Chargement...</span>
                </nav>

                <div class="formation-detail" id="formation-detail">
                    <div class="loading-state">
                        <div class="quiz-loading-spinner"></div>
                        <p>Chargement de la formation...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA -->
        <section class="page-cta-section">
            <div class="container">
                <div class="page-cta-card">
                    <div class="page-cta-content">
                        <h2>Cette formation t'a plu ?</h2>
                        <p>D√©couvre nos autres formations et webinaires pour continuer ta progression.</p>
                    </div>
                    <a href="formations.html" class="page-cta-btn">
                        Voir toutes les formations
                        <span class="arrow">‚Üí</span>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/components.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const formationId = urlParams.get('id');

        document.addEventListener('componentsLoaded', () => {
            initSupabase();
            loadFormation();
        });

        async function loadFormation() {
            if (!formationId) {
                window.location.href = 'formations.html';
                return;
            }

            try {
                const { data: formation, error } = await supabaseClient
                    .from('formations')
                    .select('*')
                    .eq('id', formationId)
                    .eq('published', true)
                    .single();

                if (error || !formation) throw new Error('Formation non trouv√©e');

                const { data: modules } = await supabaseClient
                    .from('modules')
                    .select('*')
                    .eq('formation_id', formationId)
                    .order('ordre', { ascending: true });

                displayFormation(formation, modules || []);
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('hero-title').textContent = 'Formation non trouv√©e';
                document.getElementById('formation-detail').innerHTML = `
                    <div class="page-empty">
                        <div class="page-empty-icon">üòï</div>
                        <h3>Formation introuvable</h3>
                        <p>Cette formation n'existe pas ou n'est plus disponible.</p>
                        <a href="formations.html" class="retry-btn">Voir toutes les formations</a>
                    </div>
                `;
            }
        }

        function displayFormation(formation, modules) {
            // Mettre √† jour le titre et la meta
            document.title = `${formation.titre} - OP!`;
            document.getElementById('hero-title').textContent = formation.titre;
            document.getElementById('hero-description').textContent = formation.description || '';
            document.getElementById('breadcrumb-title').textContent = formation.titre;

            const container = document.getElementById('formation-detail');
            container.innerHTML = `
                <div class="formation-content-wrapper">
                    ${formation.image_url ? `
                        <div class="formation-cover">
                            <img src="${formation.image_url}" alt="${formation.titre}">
                        </div>
                    ` : ''}

                    <div class="formation-info-card">
                        <div class="formation-info-item">
                            <span class="info-icon">üéØ</span>
                            <div>
                                <strong>${modules.length}</strong>
                                <span>modules</span>
                            </div>
                        </div>
                        <div class="formation-info-item">
                            <span class="info-icon">‚è±Ô∏è</span>
                            <div>
                                <strong>√Ä ton rythme</strong>
                                <span>Sans limite</span>
                            </div>
                        </div>
                        <div class="formation-info-item">
                            <span class="info-icon">üÜì</span>
                            <div>
                                <strong>Gratuit</strong>
                                <span>100% accessible</span>
                            </div>
                        </div>
                    </div>

                    <div class="modules-section">
                        <h2>üìñ Contenu de la formation</h2>
                        ${modules.length === 0 
                            ? '<p class="modules-empty">Aucun module disponible pour le moment.</p>' 
                            : `<div class="modules-list">
                                ${modules.map((module, index) => `
                                    <div class="module-item" data-index="${index}">
                                        <div class="module-header" onclick="toggleModule(${index})">
                                            <div class="module-number">${index + 1}</div>
                                            <div class="module-info">
                                                <h3>${module.titre}</h3>
                                                <span class="module-type">${getTypeLabel(module.type)}</span>
                                            </div>
                                            <span class="module-toggle">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </span>
                                        </div>
                                        <div class="module-content" id="module-content-${index}">
                                            ${renderModuleContent(module)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                </div>
            `;
        }

        function getTypeLabel(type) {
            const labels = {
                'video': 'üé• Vid√©o',
                'pdf': 'üìÑ PDF',
                'texte': 'üìù Texte'
            };
            return labels[type] || type;
        }

        function renderModuleContent(module) {
            switch (module.type) {
                case 'video':
                    let embedUrl = module.contenu_url || '';
                    if (embedUrl.includes('youtube.com/watch')) {
                        const videoId = new URL(embedUrl).searchParams.get('v');
                        embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    } else if (embedUrl.includes('youtu.be/')) {
                        const videoId = embedUrl.split('youtu.be/')[1];
                        embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    }
                    return `
                        <div class="video-container">
                            <iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                        </div>
                    `;
                case 'pdf':
                    return `
                        <div class="pdf-download">
                            <a href="${module.contenu_url}" target="_blank" class="pdf-btn">
                                <span class="pdf-icon">üìÑ</span>
                                <span>T√©l√©charger le PDF</span>
                                <span class="arrow">‚Üì</span>
                            </a>
                        </div>
                    `;
                case 'texte':
                    return `<div class="text-content">${module.contenu_texte || ''}</div>`;
                default:
                    return '<p>Contenu non disponible</p>';
            }
        }

        function toggleModule(index) {
            const content = document.getElementById(`module-content-${index}`);
            const item = document.querySelector(`.module-item[data-index="${index}"]`);
            
            content.classList.toggle('open');
            item.classList.toggle('expanded');
        }
    </script>
</body>
</html>