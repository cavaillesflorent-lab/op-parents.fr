<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - OP! Parents</title>
    <meta name="description" content="D√©couvre ton profil financier gr√¢ce √† nos quiz interactifs. Teste ton mindset et progresse √† ton rythme.">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/quizzes-page.css">
</head>
<body>
    <!-- HEADER -->
    <div id="header-placeholder"></div>

    <main class="quiz-page">
        <!-- Hero Section -->
        <section class="quiz-hero">
            <div class="quiz-hero-content">
                <span class="quiz-hero-badge">üß† Quiz interactifs</span>
                <h1>D√©couvre ton profil financier</h1>
                <p>Des quiz con√ßus pour t'aider √† comprendre ta relation √† l'argent et identifier tes axes de progression.</p>
            </div>
            <div class="quiz-hero-decoration">
                <div class="hero-circle circle-1"></div>
                <div class="hero-circle circle-2"></div>
                <div class="hero-circle circle-3"></div>
            </div>
        </section>

        <!-- Stats utilisateur -->
        <section class="quiz-stats-section">
            <div class="container">
                <div class="quiz-stats">
                    <div class="quiz-stat">
                        <div class="quiz-stat-icon">‚úÖ</div>
                        <div class="quiz-stat-info">
                            <span class="quiz-stat-value" id="stat-completed">0</span>
                            <span class="quiz-stat-label">Termin√©s</span>
                        </div>
                    </div>
                    <div class="quiz-stat-divider"></div>
                    <div class="quiz-stat">
                        <div class="quiz-stat-icon">‚è≥</div>
                        <div class="quiz-stat-info">
                            <span class="quiz-stat-value" id="stat-in-progress">0</span>
                            <span class="quiz-stat-label">En cours</span>
                        </div>
                    </div>
                    <div class="quiz-stat-divider"></div>
                    <div class="quiz-stat">
                        <div class="quiz-stat-icon">üìö</div>
                        <div class="quiz-stat-info">
                            <span class="quiz-stat-value" id="stat-total">0</span>
                            <span class="quiz-stat-label">Disponibles</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Filtres -->
        <section class="quiz-filters-section">
            <div class="container">
                <div class="quiz-filters">
                    <button class="quiz-filter-btn active" data-filter="all">
                        Tous les quiz
                    </button>
                    <button class="quiz-filter-btn" data-filter="in-progress">
                        En cours
                    </button>
                    <button class="quiz-filter-btn" data-filter="completed">
                        Termin√©s
                    </button>
                </div>
            </div>
        </section>

        <!-- Liste des quiz -->
        <section class="quiz-list-section">
            <div class="container">
                <div class="quiz-grid" id="quiz-list">
                    <!-- Loading state -->
                    <div class="quiz-loading">
                        <div class="quiz-loading-spinner"></div>
                        <p>Chargement des quiz...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA Footer -->
        <section class="quiz-cta-section">
            <div class="container">
                <div class="quiz-cta-card">
                    <div class="quiz-cta-content">
                        <h2>Tu veux aller plus loin ?</h2>
                        <p>D√©couvre nos webinaires pour approfondir ta transformation financi√®re avec des experts.</p>
                    </div>
                    <a href="webinaires.html" class="quiz-cta-btn">
                        Voir les webinaires
                        <span class="arrow">‚Üí</span>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/components.js"></script>
    <script>
        // ============================================
        // QUIZ LIST - OP! Parents
        // ============================================

        const STORAGE_KEY = 'op_quiz_progress';

        // R√©cup√©rer la progression sauvegard√©e
        function getProgress() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            } catch {
                return {};
            }
        }

        // Calculer le pourcentage de progression
        function getQuizProgress(quizSlug, totalQuestions) {
            const progress = getProgress()[quizSlug];
            if (!progress) return { percent: 0, status: 'not-started', currentQuestion: 0 };
            
            if (progress.completed) {
                return { percent: 100, status: 'completed', currentQuestion: totalQuestions };
            }
            
            const answered = progress.answeredQuestions || 0;
            const percent = totalQuestions > 0 ? Math.round((answered / totalQuestions) * 100) : 0;
            
            return {
                percent,
                status: answered > 0 ? 'in-progress' : 'not-started',
                currentQuestion: answered
            };
        }

        // Cr√©er le cercle de progression SVG
        function createProgressCircle(percent) {
            const radius = 20;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            
            const color = percent === 100 ? '#2D5A3D' : percent > 0 ? '#D4A574' : '#e0e0e0';
            
            return `
                <div class="quiz-card-progress">
                    <svg class="progress-ring" width="52" height="52" viewBox="0 0 52 52">
                        <circle class="progress-ring-bg" cx="26" cy="26" r="${radius}" 
                            fill="none" stroke="#e8e8e8" stroke-width="4"/>
                        <circle class="progress-ring-fill" cx="26" cy="26" r="${radius}"
                            fill="none" stroke="${color}" stroke-width="4"
                            stroke-linecap="round"
                            stroke-dasharray="${circumference}"
                            stroke-dashoffset="${offset}"
                            transform="rotate(-90 26 26)"/>
                    </svg>
                    <span class="progress-percent">${percent}%</span>
                </div>
            `;
        }

        // Cr√©er une carte de quiz
        function createQuizCard(quiz, questionCount) {
            const progress = getQuizProgress(quiz.slug, questionCount);
            
            const statusLabels = {
                'not-started': { text: 'Nouveau', class: 'new', btn: 'Commencer' },
                'in-progress': { text: 'En cours', class: 'progress', btn: 'Continuer' },
                'completed': { text: 'Termin√©', class: 'done', btn: 'Refaire' }
            };
            const status = statusLabels[progress.status];

            const imageHtml = quiz.image_url 
                ? `<img src="${quiz.image_url}" alt="${quiz.titre}" loading="lazy">`
                : `<div class="quiz-card-placeholder"><span>üß†</span></div>`;

            return `
                <article class="quiz-card" data-slug="${quiz.slug}" data-status="${progress.status}">
                    <div class="quiz-card-image">
                        ${imageHtml}
                        <span class="quiz-card-badge ${status.class}">${status.text}</span>
                    </div>
                    <div class="quiz-card-body">
                        <h3 class="quiz-card-title">${quiz.titre}</h3>
                        ${quiz.sous_titre ? `<p class="quiz-card-subtitle">${quiz.sous_titre}</p>` : ''}
                        <div class="quiz-card-meta">
                            <span><i>‚ùì</i> ${questionCount} questions</span>
                            <span><i>‚è±Ô∏è</i> ${quiz.duree || '5 min'}</span>
                        </div>
                        <div class="quiz-card-footer">
                            ${createProgressCircle(progress.percent)}
                            <a href="quiz.html?quiz=${quiz.slug}" class="quiz-card-btn ${status.class}">
                                ${status.btn}
                                <span class="arrow">‚Üí</span>
                            </a>
                        </div>
                    </div>
                </article>
            `;
        }

        // Charger les quiz
        async function loadQuizzes() {
            try {
                initSupabase();
                
                const { data: quizzes, error } = await supabaseClient
                    .from('quizzes')
                    .select('*')
                    .eq('published', true)
                    .order('ordre', { ascending: true });

                if (error) throw error;

                const { data: questions } = await supabaseClient
                    .from('quiz_questions')
                    .select('quiz_id');

                const questionCounts = {};
                questions?.forEach(q => {
                    questionCounts[q.quiz_id] = (questionCounts[q.quiz_id] || 0) + 1;
                });

                const container = document.getElementById('quiz-list');
                
                if (!quizzes || quizzes.length === 0) {
                    container.innerHTML = `
                        <div class="quiz-empty">
                            <div class="quiz-empty-icon">üß†</div>
                            <h3>Aucun quiz disponible</h3>
                            <p>Les quiz arrivent tr√®s bient√¥t, reste connect√© !</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = quizzes.map(quiz => 
                    createQuizCard(quiz, questionCounts[quiz.id] || 0)
                ).join('');

                updateStats(quizzes, questionCounts);
                setupFilters();

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('quiz-list').innerHTML = `
                    <div class="quiz-empty error">
                        <div class="quiz-empty-icon">üòï</div>
                        <h3>Oups, une erreur</h3>
                        <p>Impossible de charger les quiz. R√©essaie plus tard.</p>
                        <button onclick="loadQuizzes()" class="retry-btn">R√©essayer</button>
                    </div>
                `;
            }
        }

        // Mettre √† jour les stats
        function updateStats(quizzes, questionCounts) {
            let completed = 0;
            let inProgress = 0;

            quizzes.forEach(quiz => {
                const p = getQuizProgress(quiz.slug, questionCounts[quiz.id] || 0);
                if (p.status === 'completed') completed++;
                else if (p.status === 'in-progress') inProgress++;
            });

            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-in-progress').textContent = inProgress;
            document.getElementById('stat-total').textContent = quizzes.length;
        }

        // Filtres
        function setupFilters() {
            document.querySelectorAll('.quiz-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.quiz-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const filter = btn.dataset.filter;
                    let hasVisible = false;
                    
                    document.querySelectorAll('.quiz-card').forEach(card => {
                        const status = card.dataset.status;
                        const show = filter === 'all' || 
                            (filter === 'in-progress' && status === 'in-progress') ||
                            (filter === 'completed' && status === 'completed');
                        
                        card.style.display = show ? '' : 'none';
                        if (show) hasVisible = true;
                    });

                    // Message si aucun r√©sultat
                    const container = document.getElementById('quiz-list');
                    const existingEmpty = container.querySelector('.filter-empty');
                    if (existingEmpty) existingEmpty.remove();

                    if (!hasVisible && filter !== 'all') {
                        const msg = filter === 'in-progress' 
                            ? "Tu n'as aucun quiz en cours. Commence-en un !" 
                            : "Tu n'as pas encore termin√© de quiz. Lance-toi !";
                        container.insertAdjacentHTML('beforeend', `
                            <div class="filter-empty">
                                <p>${msg}</p>
                            </div>
                        `);
                    }
                });
            });
        }

        // Init
        document.addEventListener('componentsLoaded', loadQuizzes);
        setTimeout(() => {
            if (document.getElementById('quiz-list').innerHTML.includes('Chargement')) {
                loadQuizzes();
            }
        }, 1500);
    </script>
</body>
</html>