<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formations - OP! Éducation financière des parents</title>
    <meta name="description" content="Découvrez nos formations gratuites sur la gestion financière familiale. Des contenus pédagogiques pour comprendre et agir.">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <!-- HEADER (chargé dynamiquement) -->
    <div id="header-placeholder"></div>

    <!-- HERO -->
    <section class="page-hero">
        <div class="container">
            <h1>Nos Formations</h1>
            <p>Des contenus pédagogiques pour comprendre, organiser et anticiper les finances de votre famille.</p>
        </div>
    </section>

    <!-- LISTE FORMATIONS -->
    <section class="formations-list-section">
        <div class="container">
            <div class="formations-grid" id="formations-grid">
                <div class="loading-state">
                    <p>Chargement des formations...</p>
                </div>
            </div>
            
            <div class="empty-state" id="empty-state" style="display: none;">
                <p>Aucune formation disponible pour le moment.</p>
                <p>Revenez bientôt !</p>
            </div>
        </div>
    </section>

    <!-- FOOTER (chargé dynamiquement) -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/components.js"></script>
    <script>
        // Attendre que les composants soient chargés
        document.addEventListener('componentsLoaded', () => {
            initSupabase();
            loadFormations();
        });

        // Charger les formations
        async function loadFormations() {
            const { data: formations, error } = await supabaseClient
                .from('formations')
                .select('*')
                .eq('published', true)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Erreur:', error);
                document.getElementById('formations-grid').innerHTML = '<p class="error">Erreur de chargement</p>';
                return;
            }

            // Charger les modules pour chaque formation
            const { data: modules } = await supabaseClient
                .from('modules')
                .select('formation_id');

            // Compter les modules par formation
            const moduleCounts = {};
            modules?.forEach(m => {
                moduleCounts[m.formation_id] = (moduleCounts[m.formation_id] || 0) + 1;
            });

            displayFormations(formations || [], moduleCounts);
        }

        // Afficher les formations
        function displayFormations(formations, moduleCounts) {
            const grid = document.getElementById('formations-grid');
            const emptyState = document.getElementById('empty-state');
            
            if (formations.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.innerHTML = formations.map(formation => `
                <a href="formation.html?id=${formation.id}" class="formation-card-link">
                    <div class="formation-card">
                        ${formation.image_url ? `<img src="${formation.image_url}" alt="${formation.titre}" class="formation-image">` : ''}
                        <div class="formation-content">
                            <h3>${formation.titre}</h3>
                            <p>${formation.description || ''}</p>
                            <div class="formation-meta">
                                <span class="module-count">${moduleCounts[formation.id] || 0} module(s)</span>
                            </div>
                        </div>
                    </div>
                </a>
            `).join('');
        }
    </script>
</body>
</html>