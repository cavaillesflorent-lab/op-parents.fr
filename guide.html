<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2D403B">
    <title>Guide - OP! Parents</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="assets/css/style-responsive.css">
    
    <style>
        :root {
            --vert-fonce: #2D403B;
            --vert-clair: #DFF2B6;
            --dore: #F0D075;
            --peche: #F5E1DA;
            --blanc: #FFFFFF;
            --gris-50: #F9FAFB;
            --gris-100: #F3F4F6;
            --gris-200: #E5E7EB;
            --gris-300: #D1D5DB;
            --gris-400: #9CA3AF;
            --gris-500: #6B7280;
            --gris-600: #4B5563;
            --gris-700: #374151;
            --gris-800: #1F2937;
            --corail: #BF604B;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-serif: 'Playfair Display', Georgia, serif;
            --max-width: 640px;
            --header-height: 56px;
            --nav-height: 80px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-sans);
            background: var(--gris-50);
            color: var(--gris-800);
            line-height: 1.6;
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
        }
        
        /* Loading */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--vert-fonce);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loading-logo { font-family: var(--font-serif); font-size: 3rem; font-weight: 700; color: var(--dore); margin-bottom: 1.5rem; }
        .loading-spinner { width: 36px; height: 36px; border: 3px solid rgba(255,255,255,0.2); border-top-color: var(--dore); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Header */
        .guide-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--header-height);
            background: var(--blanc);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 8px 12px;
            border-bottom: 1px solid var(--gris-200);
        }
        .progress-segments { display: flex; gap: 4px; margin-bottom: 8px; }
        .progress-segment { flex: 1; height: 3px; background: var(--gris-200); border-radius: 2px; overflow: hidden; }
        .progress-segment-fill { height: 100%; background: var(--vert-fonce); width: 0%; transition: width 0.3s ease; }
        .progress-segment.completed .progress-segment-fill { width: 100%; }
        .progress-segment.current .progress-segment-fill { width: 50%; background: var(--dore); }
        .header-row { display: flex; align-items: center; gap: 12px; }
        .header-back { width: 36px; height: 36px; border-radius: var(--radius-full); background: transparent; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--gris-600); }
        .header-back:active { background: var(--gris-100); }
        .header-back svg { width: 22px; height: 22px; }
        .header-title { flex: 1; font-size: 0.95rem; font-weight: 600; color: var(--gris-800); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-counter { font-size: 0.8rem; font-weight: 600; color: var(--gris-500); white-space: nowrap; }
        
        /* === AJOUT: Indicateur s√©quence dans header === */
        .header-sequence {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: var(--vert-clair);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--vert-fonce);
        }
        .header-sequence.visible { display: flex; }
        
        /* Hero */
        .guide-hero {
            position: fixed;
            inset: 0;
            background: #FDF8F3;
            z-index: 50;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }
        .guide-hero.hidden { display: none; }
        .hero-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem 1.5rem; text-align: center; max-width: var(--max-width); margin: 0 auto; }
        .hero-icon { width: 80px; height: 80px; background: var(--dore); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-lg); }
        .hero-category { display: inline-block; padding: 0.375rem 1rem; background: var(--vert-fonce); border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; color: var(--blanc); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem; }
        .hero-title { font-family: var(--font-serif); font-size: clamp(1.75rem, 6vw, 2.25rem); font-weight: 700; color: var(--vert-fonce); line-height: 1.2; margin-bottom: 0.75rem; }
        .hero-subtitle { font-size: 1rem; color: var(--gris-600); margin-bottom: 1.5rem; max-width: 400px; }
        .hero-meta { display: flex; justify-content: center; gap: 1.5rem; font-size: 0.9rem; color: var(--gris-500); margin-bottom: 2rem; flex-wrap: wrap; }
        .hero-meta span { color: var(--gris-700); font-weight: 600; }
        .hero-image-container { width: 100%; max-width: 400px; border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-lg); margin-bottom: 2rem; }
        .hero-image-container img { width: 100%; height: 180px; object-fit: cover; }
        .hero-start-btn { display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; max-width: 280px; padding: 1rem 2rem; background: var(--dore); color: var(--vert-fonce); border: none; border-radius: var(--radius-lg); font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
        .hero-start-btn:active { transform: scale(0.98); }
        .hero-start-btn svg { width: 20px; height: 20px; }
        
        /* === AJOUT: Sommaire des s√©quences === */
        .sequence-sommaire {
            position: fixed;
            inset: 0;
            background: var(--gris-50);
            z-index: 45;
            display: none;
            flex-direction: column;
            overflow: auto;
        }
        .sequence-sommaire.visible { display: flex; }
        
        .sommaire-header {
            padding: 1rem 1.5rem;
            background: var(--blanc);
            border-bottom: 1px solid var(--gris-200);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .sommaire-back {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--gris-100);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--gris-600);
        }
        .sommaire-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gris-800);
        }
        
        .sommaire-content {
            flex: 1;
            padding: 1.5rem;
            max-width: var(--max-width);
            margin: 0 auto;
            width: 100%;
        }
        
        .sommaire-intro {
            text-align: center;
            margin-bottom: 2rem;
        }
        .sommaire-intro-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
        .sommaire-intro-title { font-family: var(--font-serif); font-size: 1.5rem; font-weight: 700; color: var(--vert-fonce); margin-bottom: 0.5rem; }
        .sommaire-intro-text { color: var(--gris-600); font-size: 0.95rem; }
        
        .sequence-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .sequence-card {
            background: var(--blanc);
            border-radius: var(--radius-xl);
            padding: 1.25rem;
            box-shadow: var(--shadow-sm);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .sequence-card:hover { border-color: var(--vert-clair); transform: translateY(-2px); }
        .sequence-card.locked { opacity: 0.6; cursor: not-allowed; }
        .sequence-card.locked:hover { border-color: transparent; transform: none; }
        .sequence-card.completed { border-color: var(--vert-clair); background: linear-gradient(135deg, var(--blanc), rgba(223, 242, 182, 0.3)); }
        .sequence-card.current { border-color: var(--dore); }
        
        .sequence-card-icon {
            width: 56px;
            height: 56px;
            background: var(--gris-100);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            flex-shrink: 0;
        }
        .sequence-card.completed .sequence-card-icon { background: var(--vert-clair); }
        .sequence-card.current .sequence-card-icon { background: var(--dore); }
        
        .sequence-card-content { flex: 1; min-width: 0; }
        .sequence-card-number { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gris-500); margin-bottom: 0.25rem; }
        .sequence-card.current .sequence-card-number { color: var(--dore); }
        .sequence-card-title { font-size: 1rem; font-weight: 700; color: var(--gris-800); margin-bottom: 0.25rem; }
        .sequence-card-desc { font-size: 0.85rem; color: var(--gris-500); }
        
        .sequence-card-status {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        .sequence-card.completed .sequence-card-status { background: var(--vert-fonce); color: var(--blanc); }
        .sequence-card.current .sequence-card-status { background: var(--dore); color: var(--vert-fonce); }
        .sequence-card.locked .sequence-card-status { background: var(--gris-200); color: var(--gris-400); }
        
        /* === AJOUT: Overlay fin de s√©quence === */
        .sequence-complete-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 180;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .sequence-complete-overlay.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        
        .sequence-complete-card {
            background: var(--blanc);
            border-radius: var(--radius-xl);
            padding: 2rem;
            text-align: center;
            max-width: 360px;
            width: 100%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .sequence-complete-overlay.visible .sequence-complete-card { transform: scale(1); }
        
        .sequence-complete-icon { font-size: 3rem; margin-bottom: 1rem; }
        .sequence-complete-title { font-family: var(--font-serif); font-size: 1.5rem; font-weight: 700; color: var(--vert-fonce); margin-bottom: 0.5rem; }
        .sequence-complete-text { color: var(--gris-600); margin-bottom: 1.5rem; }
        .sequence-complete-actions { display: flex; flex-direction: column; gap: 0.75rem; }
        .sequence-complete-btn { padding: 0.875rem 1.5rem; border-radius: var(--radius-lg); font-size: 1rem; font-weight: 600; cursor: pointer; border: none; }
        .sequence-complete-btn.primary { background: var(--vert-fonce); color: var(--blanc); }
        .sequence-complete-btn.secondary { background: var(--gris-100); color: var(--gris-700); }
        
        /* Main Content */
        .guide-content { position: fixed; top: var(--header-height); left: 0; right: 0; bottom: var(--nav-height); display: none; overflow: hidden; }
        .guide-content.active { display: block; }
        .slides-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .slide { position: absolute; width: calc(100% - 2rem); max-width: var(--max-width); max-height: 100%; overflow-y: auto; opacity: 0; transform: translateX(100%); transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; }
        .slide.active { opacity: 1; transform: translateX(0); pointer-events: auto; }
        .slide.prev { opacity: 0; transform: translateX(-100%); }
        .slide-blocks { display: flex; flex-direction: column; gap: 1rem; }
        
        /* Tap zones */
        .tap-zone { position: fixed; top: var(--header-height); bottom: var(--nav-height); width: 20%; z-index: 10; }
        .tap-zone-left { left: 0; }
        .tap-zone-right { right: 0; }
        
        /* Nav Bottom */
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: var(--blanc); border-top: 1px solid var(--gris-200); display: none; align-items: center; justify-content: center; padding: 0 1rem; padding-bottom: env(safe-area-inset-bottom, 0); gap: 0.75rem; z-index: 100; }
        .nav-bottom.active { display: flex; }
        .nav-btn { height: 48px; border-radius: var(--radius-lg); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; border: none; }
        .nav-btn svg { width: 20px; height: 20px; }
        .nav-btn-prev { width: 48px; background: var(--gris-100); color: var(--gris-600); }
        .nav-btn-prev:active { background: var(--gris-200); }
        .nav-btn-prev:disabled { opacity: 0.3; cursor: not-allowed; }
        .nav-btn-next { flex: 1; max-width: 280px; background: var(--vert-fonce); color: var(--blanc); padding: 0 1.5rem; }
        .nav-btn-next:active { opacity: 0.9; }
        .nav-btn-next.golden { background: var(--dore); color: var(--vert-fonce); }
        
        /* Block Styles */
        .block-section-title { padding: 2rem 0; text-align: center; }
        .section-title-text { font-family: var(--font-serif); font-size: 1.5rem; font-weight: 700; color: var(--vert-fonce); position: relative; display: inline-block; }
        .section-title-text::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 50px; height: 4px; background: var(--dore); border-radius: 2px; }
        
        .block-narrative { background: var(--blanc); border-radius: var(--radius-xl); padding: 1.5rem; box-shadow: var(--shadow-sm); }
        .narrative-title { font-size: 1.1rem; font-weight: 700; color: var(--gris-800); margin-bottom: 1rem; }
        .narrative-content { font-size: 1rem; color: var(--gris-700); line-height: 1.8; }
        .narrative-content p { margin-bottom: 1rem; }
        .narrative-content p:last-child { margin-bottom: 0; }
        .narrative-content .dialogue { font-style: italic; color: var(--corail); padding-left: 1rem; border-left: 3px solid var(--peche); margin: 1rem 0; }
        
        .block-info-box { background: linear-gradient(135deg, var(--vert-clair) 0%, rgba(223, 242, 182, 0.5) 100%); border-radius: var(--radius-xl); padding: 1.5rem; border-left: 4px solid var(--vert-fonce); }
        .block-info-box.style-warning { background: linear-gradient(135deg, #FEF3C7 0%, rgba(254, 243, 199, 0.5) 100%); border-left-color: #F59E0B; }
        .block-info-box.style-tip { background: linear-gradient(135deg, var(--peche) 0%, rgba(245, 225, 218, 0.5) 100%); border-left-color: var(--corail); }
        .info-box-title { font-size: 1rem; font-weight: 700; color: var(--vert-fonce); margin-bottom: 0.75rem; }
        .block-info-box.style-warning .info-box-title { color: #92400E; }
        .block-info-box.style-tip .info-box-title { color: var(--corail); }
        .info-box-content { font-size: 0.95rem; color: var(--gris-700); line-height: 1.7; }
        
        .block-stat { background: var(--vert-fonce); border-radius: var(--radius-xl); padding: 2rem 1.5rem; text-align: center; }
        .stat-text { font-size: 1.15rem; color: var(--blanc); line-height: 1.6; }
        .stat-source { font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-top: 1rem; font-style: italic; }
        
        .block-quiz, .block-poll { background: var(--blanc); border-radius: var(--radius-xl); padding: 1.5rem; box-shadow: var(--shadow-sm); }
        .block-quiz { border: 2px solid var(--dore); }
        .block-poll { border: 2px solid var(--gris-200); }
        .quiz-header, .poll-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
        .quiz-badge { padding: 0.25rem 0.75rem; background: var(--dore); color: var(--vert-fonce); border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .poll-badge { padding: 0.25rem 0.75rem; background: var(--peche); color: var(--corail); border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .quiz-question, .poll-question { font-size: 1.1rem; font-weight: 700; color: var(--gris-800); margin-bottom: 1.25rem; line-height: 1.4; }
        .quiz-options, .poll-options { display: flex; flex-direction: column; gap: 0.6rem; }
        .quiz-option, .poll-option { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; background: var(--gris-50); border: 2px solid var(--gris-200); border-radius: var(--radius-md); cursor: pointer; transition: all 0.15s ease; }
        .quiz-option:active, .poll-option:active { transform: scale(0.98); }
        .quiz-option.correct { border-color: #10B981; background: rgba(16, 185, 129, 0.1); }
        .quiz-option.incorrect { border-color: #EF4444; background: rgba(239, 68, 68, 0.1); }
        .quiz-option.disabled, .poll-option.disabled { cursor: default; opacity: 0.7; }
        .poll-option.selected { border-color: var(--vert-fonce); background: var(--vert-clair); }
        .quiz-option-letter { width: 28px; height: 28px; background: var(--gris-200); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; color: var(--gris-600); flex-shrink: 0; }
        .quiz-option.correct .quiz-option-letter { background: #10B981; color: var(--blanc); }
        .quiz-option.incorrect .quiz-option-letter { background: #EF4444; color: var(--blanc); }
        .poll-option-checkbox { width: 22px; height: 22px; border: 2px solid var(--gris-300); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .poll-option.selected .poll-option-checkbox { background: var(--vert-fonce); border-color: var(--vert-fonce); }
        .poll-option.selected .poll-option-checkbox::after { content: '‚úì'; color: var(--blanc); font-size: 0.75rem; font-weight: 700; }
        .quiz-option-text, .poll-option-text { font-size: 0.95rem; color: var(--gris-700); flex: 1; }
        .quiz-explanation { margin-top: 1rem; padding: 1rem; background: var(--vert-clair); border-radius: var(--radius-md); display: none; }
        .quiz-explanation.visible { display: block; }
        .quiz-explanation-title { font-weight: 700; color: var(--vert-fonce); margin-bottom: 0.5rem; font-size: 0.9rem; }
        .quiz-explanation-text { font-size: 0.9rem; color: var(--gris-700); line-height: 1.6; }
        
        .poll-results { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gris-200); }
        .poll-result-item { margin-bottom: 0.6rem; }
        .poll-result-header { display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.85rem; }
        .poll-result-text { color: var(--gris-700); }
        .poll-result-percent { font-weight: 700; color: var(--vert-fonce); }
        .poll-result-bar { height: 6px; background: var(--gris-200); border-radius: 3px; overflow: hidden; }
        .poll-result-fill { height: 100%; background: var(--vert-fonce); border-radius: 3px; transition: width 0.8s ease; }
        
        .block-focus { background: var(--blanc); border-radius: var(--radius-xl); padding: 1.5rem; border: 2px dashed var(--gris-300); }
        .focus-icon { font-size: 2rem; margin-bottom: 0.75rem; }
        .focus-title { font-size: 1.1rem; font-weight: 700; color: var(--gris-800); margin-bottom: 0.75rem; }
        .focus-content { font-size: 0.95rem; color: var(--gris-600); line-height: 1.7; }
        
        .block-table { background: var(--blanc); border-radius: var(--radius-xl); padding: 1.25rem; overflow-x: auto; }
        .table-title { font-size: 1rem; font-weight: 700; color: var(--gris-800); margin-bottom: 1rem; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .data-table th { background: var(--vert-fonce); color: var(--blanc); padding: 0.6rem 0.75rem; text-align: left; font-weight: 600; }
        .data-table td { padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--gris-200); color: var(--gris-700); }
        .data-table tr:nth-child(even) { background: var(--gris-50); }
        
        .block-exercise { background: linear-gradient(135deg, var(--dore) 0%, #E5C35A 100%); border-radius: var(--radius-xl); padding: 1.5rem; }
        .exercise-title { font-size: 1.1rem; font-weight: 700; color: var(--vert-fonce); margin-bottom: 0.5rem; }
        .exercise-instructions { font-size: 0.9rem; color: var(--gris-700); margin-bottom: 1rem; font-style: italic; }
        .exercise-fields { margin-bottom: 1rem; }
        .exercise-help-text { padding: 0.4rem 0.75rem; font-size: 0.8rem; color: var(--gris-500); font-style: italic; background: none; margin-top: -0.25rem; }
        .exercise-field { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: var(--blanc); border-radius: var(--radius-md); margin-bottom: 0.5rem; font-size: 0.9rem; }
        .exercise-field-label { color: var(--gris-700); flex: 1; font-weight: 500; }
        .exercise-field-input { border: none; border-bottom: 2px dashed var(--gris-300); background: transparent; width: 80px; padding: 0.25rem; font-size: 0.95rem; font-weight: 600; color: var(--vert-fonce); text-align: right; }
        .exercise-field-input:focus { outline: none; border-bottom-color: var(--vert-fonce); }
        .exercise-field-unit { font-size: 0.85rem; color: var(--gris-500); width: 20px; }
        .exercise-calc-btn { display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 0.75rem; background: var(--blanc); border: 2px solid var(--vert-fonce); border-radius: var(--radius-md); color: var(--vert-fonce); font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .exercise-calc-btn:hover { background: var(--vert-fonce); color: var(--blanc); }
        
        /* Exercise Text Block */
        .block-exercise-text { background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%); border-radius: var(--radius-xl); padding: 1.5rem; }
        .exercise-text-header { margin-bottom: 0.75rem; }
        .exercise-text-badge { display: inline-block; background: var(--blanc); color: #4338CA; font-size: 0.75rem; font-weight: 700; padding: 0.35rem 0.75rem; border-radius: var(--radius-full); }
        .exercise-text-title { font-size: 1.1rem; font-weight: 700; color: #312E81; margin-bottom: 1rem; }
        .exercise-text-fields-container { display: flex; flex-direction: column; gap: 1rem; }
        .exercise-text-field { background: rgba(255,255,255,0.5); border-radius: var(--radius-md); padding: 1rem; }
        .exercise-text-question { font-size: 0.95rem; color: #4338CA; margin-bottom: 0.75rem; line-height: 1.5; font-weight: 500; }
        .exercise-text-input { width: 100%; padding: 0.875rem 1rem; border: 2px solid #A5B4FC; border-radius: var(--radius-md); font-size: 0.95rem; font-family: inherit; resize: vertical; min-height: 80px; background: var(--blanc); transition: all 0.2s ease; }
        .exercise-text-input:focus { outline: none; border-color: #4338CA; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }
        .exercise-text-input::placeholder { color: #A5B4FC; }
        .exercise-text-help { margin-top: 1rem; font-size: 0.85rem; color: #6366F1; font-style: italic; background: rgba(255,255,255,0.5); padding: 0.75rem 1rem; border-radius: var(--radius-md); }
        
        /* Newsletter Block */
        .block-newsletter { background: linear-gradient(135deg, #FEF2F2 0%, #FECACA 100%); border-radius: var(--radius-xl); padding: 2rem 1.5rem; text-align: center; border: 2px solid #F87171; }
        .newsletter-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
        .newsletter-title { font-family: var(--font-serif); font-size: 1.4rem; font-weight: 700; color: #991B1B; margin-bottom: 0.5rem; }
        .newsletter-description { font-size: 0.95rem; color: #7F1D1D; margin-bottom: 1.25rem; line-height: 1.5; max-width: 400px; margin-left: auto; margin-right: auto; }
        .newsletter-form { max-width: 360px; margin: 0 auto 1rem; }
        .newsletter-input-group { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; }
        .newsletter-input { flex: 1; min-width: 200px; padding: 0.875rem 1rem; border: 2px solid #FCA5A5; border-radius: var(--radius-lg); font-size: 1rem; background: var(--blanc); transition: all 0.2s ease; }
        .newsletter-input:focus { outline: none; border-color: #F87171; box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2); }
        .newsletter-input::placeholder { color: #FCA5A5; }
        .newsletter-button { padding: 0.875rem 1.5rem; background: #DC2626; color: var(--blanc); border: none; border-radius: var(--radius-lg); font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .newsletter-button:hover { background: #B91C1C; transform: translateY(-1px); }
        .newsletter-button:disabled { background: #9CA3AF; cursor: not-allowed; transform: none; }
        .newsletter-message { margin-top: 0.75rem; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-size: 0.9rem; }
        .newsletter-message-success { background: #D1FAE5; color: #065F46; }
        .newsletter-message-error { background: #FEE2E2; color: #991B1B; }
        .newsletter-message-info { background: #DBEAFE; color: #1E40AF; }
        .newsletter-skip { background: none; border: none; color: #991B1B; font-size: 0.9rem; cursor: pointer; padding: 0.5rem; opacity: 0.7; transition: opacity 0.2s ease; }
        .newsletter-skip:hover { opacity: 1; text-decoration: underline; }
        .newsletter-success { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 1rem; background: #D1FAE5; color: #065F46; border-radius: var(--radius-lg); font-weight: 600; }
        .newsletter-success-icon { font-size: 1.5rem; }
        .newsletter-skipped { opacity: 0.5; pointer-events: none; }
        
        .block-summary { background: var(--blanc); border-radius: var(--radius-xl); padding: 1.5rem; border: 2px solid var(--vert-fonce); }
        .summary-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
        .summary-icon { width: 36px; height: 36px; background: var(--vert-clair); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .summary-title { font-size: 1.05rem; font-weight: 700; color: var(--vert-fonce); }
        .summary-list { list-style: none; }
        .summary-list li { display: flex; align-items: flex-start; gap: 0.6rem; padding: 0.6rem 0; border-bottom: 1px solid var(--gris-100); font-size: 0.9rem; color: var(--gris-700); }
        .summary-list li:last-child { border-bottom: none; }
        .summary-list li::before { content: '‚úì'; color: var(--vert-fonce); font-weight: 700; flex-shrink: 0; }
        
        .block-cta { background: linear-gradient(135deg, var(--vert-fonce) 0%, #1F2E29 100%); border-radius: var(--radius-xl); padding: 2rem 1.5rem; text-align: center; }
        .cta-title { font-family: var(--font-serif); font-size: 1.35rem; font-weight: 700; color: var(--blanc); margin-bottom: 0.75rem; }
        .cta-text { font-size: 0.95rem; color: rgba(255,255,255,0.8); margin-bottom: 1.25rem; }
        .cta-button { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1.5rem; background: var(--dore); color: var(--vert-fonce); border: none; border-radius: var(--radius-lg); font-size: 1rem; font-weight: 700; text-decoration: none; }
        
        .block-image { border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-sm); }
        .block-image img { width: 100%; display: block; }
        .block-image figcaption { padding: 0.6rem 1rem; background: var(--blanc); font-size: 0.8rem; color: var(--gris-500); text-align: center; }
        
        /* Personal Field Block */
        .block-personal-field { background: var(--blanc); border-radius: var(--radius-xl); padding: 1.5rem; border: 2px solid var(--vert-clair); box-shadow: var(--shadow-sm); }
        .personal-field-label { font-size: 1rem; font-weight: 600; color: var(--gris-800); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .personal-field-label::before { content: 'üë§'; font-size: 1.1rem; }
        .personal-field-input { width: 100%; padding: 0.875rem 1rem; border: 2px solid var(--gris-200); border-radius: var(--radius-md); font-size: 1rem; font-family: inherit; transition: all 0.2s ease; background: var(--gris-50); }
        .personal-field-input:focus { outline: none; border-color: var(--vert-fonce); background: var(--blanc); }
        .personal-field-input.has-value { border-color: var(--vert-clair); background: rgba(223, 242, 182, 0.2); }
        .personal-field-textarea { min-height: 100px; resize: vertical; }
        .personal-field-help { font-size: 0.8rem; color: var(--gris-500); margin-top: 0.5rem; }
        .personal-field-saved { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: var(--vert-fonce); margin-top: 0.5rem; opacity: 0; transition: opacity 0.3s ease; }
        .personal-field-saved.visible { opacity: 1; }
        
        /* Calculator Block */
        .block-calculator { background: var(--blanc); border-radius: var(--radius-xl); padding: 1.5rem; border: 2px solid var(--dore); box-shadow: var(--shadow-sm); }
        .calculator-header { margin-bottom: 1rem; }
        .calculator-title { font-size: 1.1rem; font-weight: 700; color: var(--gris-800); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .calculator-title::before { content: 'üßÆ'; }
        .calculator-description { font-size: 0.85rem; color: var(--gris-500); font-style: italic; }
        .calculator-lines { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        .calculator-line { display: flex; align-items: center; gap: 0.75rem; }
        .calculator-line-label { flex: 1; font-size: 0.9rem; color: var(--gris-700); }
        .calculator-line-input { width: 100px; padding: 0.6rem 0.75rem; border: 2px solid var(--gris-200); border-radius: var(--radius-md); font-size: 1rem; font-weight: 600; text-align: right; font-family: inherit; background: var(--gris-50); transition: all 0.2s ease; }
        .calculator-line-input:focus { outline: none; border-color: var(--dore); background: var(--blanc); }
        .calculator-line-input.has-value { border-color: var(--vert-clair); background: rgba(223, 242, 182, 0.15); }
        .calculator-line-unit { font-size: 0.9rem; color: var(--gris-500); width: 20px; }
        .calculator-total { display: flex; align-items: center; justify-content: space-between; padding-top: 1rem; border-top: 2px dashed var(--gris-300); }
        .calculator-total-label { font-size: 1rem; font-weight: 700; color: var(--vert-fonce); }
        .calculator-total-value { font-size: 1.25rem; font-weight: 700; color: var(--vert-fonce); display: flex; align-items: center; gap: 0.5rem; }
        .calculator-total-number { background: var(--vert-clair); padding: 0.4rem 0.75rem; border-radius: var(--radius-md); }
        .calculator-saved { font-size: 0.7rem; color: var(--vert-fonce); opacity: 0; transition: opacity 0.3s ease; }
        .calculator-saved.visible { opacity: 1; }
        
        /* Floating Calculator Button */
        .calc-fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 16px);
            left: 50%;
            transform: translateX(-50%);
            height: 44px;
            padding: 0 1.25rem;
            background: var(--dore);
            border: none;
            border-radius: var(--radius-full);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--vert-fonce);
            cursor: pointer;
            z-index: 80;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        .calc-fab.visible { display: flex; }
        .calc-fab:active { transform: translateX(-50%) scale(0.95); }
        .calc-fab:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
        
        /* Calculator Modal */
        .calc-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 300;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .calc-modal-overlay.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        
        .calc-modal {
            background: var(--blanc);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .calc-modal-overlay.visible .calc-modal { transform: translateY(0); }
        
        .calc-modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--gris-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--dore) 0%, #E5C35A 100%);
        }
        .calc-modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--vert-fonce);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .calc-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--vert-fonce);
        }
        
        .calc-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .calc-add-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--gris-100);
            border: 2px dashed var(--gris-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gris-600);
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        .calc-add-btn:hover { background: var(--gris-200); border-color: var(--gris-400); }
        
        .calc-lines {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .calc-line {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--gris-50);
            border-radius: var(--radius-md);
            animation: slideIn 0.2s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } }
        
        .calc-line-label {
            flex: 1;
            min-width: 0;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gris-200);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            background: var(--blanc);
        }
        .calc-line-label:focus { outline: none; border-color: var(--vert-fonce); }
        
        .calc-line-value {
            width: 90px;
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--gris-200);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            text-align: right;
            background: var(--blanc);
        }
        .calc-line-value:focus { outline: none; border-color: var(--dore); }
        
        .calc-line-unit {
            font-size: 0.9rem;
            color: var(--gris-500);
            width: 20px;
        }
        
        .calc-line-delete {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--gris-400);
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calc-line-delete:hover { background: #FEE2E2; color: #DC2626; }
        
        .calc-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--gris-500);
        }
        .calc-empty-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .calc-empty-text { font-size: 0.9rem; }
        
        .calc-modal-footer {
            padding: 1rem;
            border-top: 2px solid var(--gris-200);
            background: var(--gris-50);
        }
        
        .calc-total-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .calc-total-label {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gris-700);
        }
        .calc-total-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--vert-fonce);
        }
        
        .calc-copy-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--vert-fonce);
            color: var(--blanc);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        .calc-copy-btn:hover { background: #1F2E29; }
        .calc-copy-btn.copied { background: #10B981; }
        
        /* Completion */
        .completion-screen { position: fixed; inset: 0; background: var(--vert-fonce); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 2rem; opacity: 0; visibility: hidden; pointer-events: none; transition: all 0.4s ease; }
        .completion-screen.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        .completion-content { text-align: center; max-width: 360px; }
        .completion-confetti { font-size: 3.5rem; margin-bottom: 1rem; }
        .completion-title { font-family: var(--font-serif); font-size: 1.75rem; font-weight: 700; color: var(--blanc); margin-bottom: 0.75rem; }
        .completion-text { font-size: 1rem; color: rgba(255,255,255,0.8); margin-bottom: 1.5rem; line-height: 1.5; }
        .completion-stats { display: flex; justify-content: center; gap: 2rem; margin-bottom: 1.5rem; }
        .completion-stat { text-align: center; }
        .completion-stat-value { font-size: 1.75rem; font-weight: 700; color: var(--dore); }
        .completion-stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.6); }
        .completion-actions { display: flex; flex-direction: column; gap: 0.75rem; }
        .completion-btn { padding: 0.875rem 1.5rem; border-radius: var(--radius-lg); font-size: 1rem; font-weight: 600; cursor: pointer; text-decoration: none; border: none; text-align: center; }
        .completion-btn.primary { background: var(--dore); color: var(--vert-fonce); }
        .completion-btn.secondary { background: transparent; color: var(--blanc); border: 2px solid rgba(255,255,255,0.3); }
        
        /* Error */
        .error-screen { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; text-align: center; background: var(--gris-50); }
        .error-screen.visible { display: flex; }
        .error-icon { font-size: 3.5rem; margin-bottom: 1rem; }
        .error-title { font-size: 1.35rem; font-weight: 700; color: var(--gris-800); margin-bottom: 0.5rem; }
        .error-text { color: var(--gris-600); margin-bottom: 1.5rem; }
        .error-btn { padding: 0.875rem 1.5rem; background: var(--vert-fonce); color: var(--blanc); border-radius: var(--radius-lg); text-decoration: none; font-weight: 600; }
        
        /* Auth Modal */
        .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 500; display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; pointer-events: none; transition: all 0.3s ease; }
        .auth-overlay.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        .auth-modal { background: var(--blanc); border-radius: var(--radius-xl); width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; transform: translateY(20px); transition: transform 0.3s ease; }
        .auth-overlay.visible .auth-modal { transform: translateY(0); }
        .auth-header { padding: 1.5rem 1.5rem 1rem; text-align: center; background: linear-gradient(135deg, var(--vert-clair) 0%, #c5e89e 100%); }
        .auth-logo { font-family: var(--font-serif); font-size: 2rem; font-weight: 700; color: var(--vert-fonce); margin-bottom: 0.5rem; }
        .auth-title { font-size: 1.1rem; font-weight: 600; color: var(--vert-fonce); }
        .auth-benefits { padding: 1rem 1.5rem; background: var(--gris-50); }
        .auth-benefit { display: flex; align-items: center; gap: 0.75rem; padding: 0.4rem 0; font-size: 0.85rem; color: var(--gris-700); }
        .auth-benefit-icon { font-size: 1rem; }
        .auth-form { padding: 1.5rem; }
        .auth-tabs { display: flex; background: var(--gris-100); border-radius: var(--radius-md); padding: 4px; margin-bottom: 1.25rem; }
        .auth-tab { flex: 1; padding: 0.6rem; border: none; background: transparent; border-radius: var(--radius-sm); font-size: 0.9rem; font-weight: 600; color: var(--gris-500); cursor: pointer; transition: all 0.2s ease; }
        .auth-tab.active { background: var(--blanc); color: var(--vert-fonce); box-shadow: var(--shadow-sm); }
        .auth-input-group { margin-bottom: 1rem; }
        .auth-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--gris-700); margin-bottom: 0.4rem; }
        .auth-input { width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--gris-200); border-radius: var(--radius-md); font-size: 1rem; font-family: inherit; transition: border-color 0.2s ease; }
        .auth-input:focus { outline: none; border-color: var(--vert-fonce); }
        .auth-submit { width: 100%; padding: 0.875rem; background: var(--vert-fonce); color: var(--blanc); border: none; border-radius: var(--radius-md); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .auth-submit:hover { background: #1F2E29; }
        .auth-submit:disabled { opacity: 0.6; cursor: not-allowed; }
        .auth-error { background: #FEE2E2; color: #DC2626; padding: 0.75rem; border-radius: var(--radius-md); font-size: 0.85rem; margin-bottom: 1rem; display: none; }
        .auth-error.visible { display: block; }
        .auth-close { position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border: none; background: rgba(0,0,0,0.1); border-radius: var(--radius-full); cursor: pointer; font-size: 1.25rem; color: var(--gris-600); display: flex; align-items: center; justify-content: center; }
        .auth-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--gris-200); text-align: center; font-size: 0.85rem; color: var(--gris-500); }
        .auth-footer a { color: var(--vert-fonce); font-weight: 600; text-decoration: none; }
        
        /* User Badge */
        .user-badge { position: fixed; top: calc(var(--header-height) + 8px); right: 8px; background: var(--blanc); border: 1px solid var(--gris-200); border-radius: var(--radius-full); padding: 0.35rem 0.75rem; font-size: 0.7rem; color: var(--gris-600); z-index: 90; display: flex; align-items: center; gap: 0.4rem; box-shadow: var(--shadow-sm); }
        .user-badge-dot { width: 6px; height: 6px; background: #10B981; border-radius: 50%; }
        
        /* Preview Badge */
        .preview-badge { position: fixed; top: calc(var(--header-height) + 8px); right: 8px; background: var(--corail); color: white; padding: 0.35rem 0.75rem; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 700; z-index: 150; text-transform: uppercase; }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-logo">OP!</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="guide-header" id="guide-header" style="display: none;">
        <div class="progress-segments" id="progress-segments"></div>
        <div class="header-row">
            <button class="header-back" onclick="handleBackButton()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div class="header-title" id="header-title">Guide</div>
            <!-- AJOUT: Indicateur de s√©quence -->
            <div class="header-sequence" id="header-sequence">
                <span id="header-sequence-emoji">üìö</span>
                <span id="header-sequence-name">Niveau 1</span>
            </div>
            <div class="header-counter" id="header-counter">1/1</div>
        </div>
        <link rel="stylesheet" href="assets/css/style-responsive.css">
    </header>

    <!-- Hero -->
    <section class="guide-hero" id="guide-hero">
        <div class="hero-content">
            <div class="hero-icon" id="hero-icon">üí∞</div>
            <span class="hero-category" id="hero-category">Budget</span>
            <h1 class="hero-title" id="hero-title">Titre du guide</h1>
            <p class="hero-subtitle" id="hero-subtitle"></p>
            <div class="hero-meta">
                <span>‚è±Ô∏è <span id="hero-duration">10 min</span></span>
                <span>üìñ <span id="hero-blocks">0</span> slides</span>
                <!-- AJOUT: Nombre de niveaux -->
                <span id="hero-levels-container" style="display: none;">üìö <span id="hero-levels">1</span> niveaux</span>
            </div>
            <div class="hero-image-container" id="hero-card" style="display: none;">
                <img id="hero-image" src="" alt="">
            </div>
            <button class="hero-start-btn" onclick="handleStartGuide()">
                C'est parti
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
            </button>
        </div>
    </section>

    <!-- AJOUT: Sommaire des s√©quences -->
    <section class="sequence-sommaire" id="sequence-sommaire">
        <header class="sommaire-header">
            <button class="sommaire-back" onclick="backToHero()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <h2 class="sommaire-title" id="sommaire-title">Sommaire</h2>
        </header>
        <div class="sommaire-content">
            <div class="sommaire-intro">
                <div class="sommaire-intro-icon" id="sommaire-icon">üìö</div>
                <h3 class="sommaire-intro-title" id="sommaire-intro-title">Choisis ton niveau</h3>
                <p class="sommaire-intro-text">Progresse √† ton rythme, niveau par niveau</p>
            </div>
            <div class="sequence-list" id="sequence-list">
                <!-- G√©n√©r√© par JS -->
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="guide-content" id="guide-content">
        <div class="tap-zone tap-zone-left" onclick="prevSlide()"></div>
        <div class="tap-zone tap-zone-right" onclick="nextSlide()"></div>
        <div class="slides-container" id="slides-container"></div>
    </main>

    <!-- Navigation -->
    <nav class="nav-bottom" id="nav-bottom">
        <button class="nav-btn nav-btn-prev" id="btn-prev" onclick="prevSlide()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
        </button>
        <button class="nav-btn nav-btn-next" id="btn-next" onclick="nextSlide()">
            Suivant
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
        </button>
    </nav>

    <!-- Error -->
    <div class="error-screen" id="error-screen">
        <div class="error-icon">üòï</div>
        <h1 class="error-title">Guide introuvable</h1>
        <p class="error-text">Ce guide n'existe pas ou n'est pas publi√©.</p>
        <a href="quiz.html" class="error-btn">‚Üê Retour aux guides</a>
    </div>

    <!-- Completion -->
    <!-- Floating Calculator Button (shown only on exercise slides) -->
    <button class="calc-fab" id="calc-fab" onclick="openCalculator()">üßÆ Calculette</button>

    <!-- Calculator Modal -->
    <div class="calc-modal-overlay" id="calc-modal" onclick="if(event.target===this)closeCalculator()">
        <div class="calc-modal">
            <div class="calc-modal-header">
                <div class="calc-modal-title">üßÆ Ma calculette</div>
                <button class="calc-modal-close" onclick="closeCalculator()">√ó</button>
            </div>
            <div class="calc-modal-body">
                <button class="calc-add-btn" onclick="addCalcLine()">+ Ajouter une ligne</button>
                <div class="calc-lines" id="calc-lines">
                    <div class="calc-empty">
                        <div class="calc-empty-icon">üìù</div>
                        <div class="calc-empty-text">Ajoutez des lignes pour calculer</div>
                    </div>
                </div>
            </div>
            <div class="calc-modal-footer">
                <div class="calc-total-row">
                    <span class="calc-total-label">TOTAL</span>
                    <span class="calc-total-value"><span id="calc-total">0</span> ‚Ç¨</span>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button class="calc-copy-btn" id="calc-copy-btn" onclick="copyCalcTotal()" style="flex: 1; background: var(--gris-100); color: var(--gris-700);">
                        <span id="calc-copy-text">üìã Copier</span>
                    </button>
                    <button class="calc-copy-btn" id="calc-validate-btn" onclick="validateAndCloseCalculator()" style="flex: 2;">
                        ‚úì Valider et fermer
                    </button>
                </div>
                <button onclick="clearCalculator()" style="width: 100%; background: none; border: none; color: var(--gris-500); font-size: 0.8rem; cursor: pointer; padding: 0.5rem;">
                    üóëÔ∏è Tout effacer
                </button>
            </div>
        </div>
    </div>

    <!-- AJOUT: Overlay fin de s√©quence -->
    <div class="sequence-complete-overlay" id="sequence-complete-overlay">
        <div class="sequence-complete-card">
            <div class="sequence-complete-icon">üéâ</div>
            <h3 class="sequence-complete-title" id="sequence-complete-title">Niveau termin√© !</h3>
            <p class="sequence-complete-text" id="sequence-complete-text">Bravo, tu as termin√© ce niveau.</p>
            <div class="sequence-complete-actions">
                <button class="sequence-complete-btn primary" id="sequence-next-btn" onclick="goToNextSequence()">
                    Niveau suivant ‚Üí
                </button>
                <button class="sequence-complete-btn secondary" onclick="backToSommaire()">
                    Retour au sommaire
                </button>
            </div>
        </div>
    </div>

    <div class="completion-screen" id="completion-screen">
        <div class="completion-content">
            <div class="completion-confetti">üéâ</div>
            <h2 class="completion-title">Bravo !</h2>
            <p class="completion-text" id="completion-text">Tu as termin√© ce guide !</p>
            <div class="completion-stats">
                <div class="completion-stat">
                    <div class="completion-stat-value" id="stat-blocks">0</div>
                    <div class="completion-stat-label">slides</div>
                </div>
                <div class="completion-stat">
                    <div class="completion-stat-value" id="stat-quiz">0/0</div>
                    <div class="completion-stat-label">quiz r√©ussis</div>
                </div>
            </div>
            <div class="completion-actions">
                <a href="mon-espace.html" class="completion-btn primary">Mon espace ‚Üí</a>
                <a href="quiz.html" class="completion-btn secondary">Autres guides</a>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="auth-overlay" id="auth-overlay" onclick="if(event.target===this && !authRequired)closeAuthModal()">
        <div class="auth-modal">
            <div class="auth-header">
                <div class="auth-logo">OP!</div>
                <div class="auth-title">Cr√©ez votre compte gratuit</div>
            </div>
            <div class="auth-benefits">
                <div class="auth-benefit"><span class="auth-benefit-icon">üìö</span> Acc√®s √† tous les guides interactifs</div>
                <div class="auth-benefit"><span class="auth-benefit-icon">üíæ</span> Sauvegarde de vos donn√©es personnelles</div>
                <div class="auth-benefit"><span class="auth-benefit-icon">üìä</span> Suivi de votre progression</div>
            </div>
            <div class="auth-form">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('signup')">Inscription</button>
                    <button class="auth-tab" onclick="switchAuthTab('login')">Connexion</button>
                </div>
                <div class="auth-error" id="auth-error"></div>
                
                <!-- Signup Form -->
                <form id="signup-form" onsubmit="handleSignup(event)">
                    <div class="auth-input-group">
                        <label class="auth-label">Pr√©nom</label>
                        <input type="text" class="auth-input" id="signup-name" required placeholder="Votre pr√©nom">
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signup-email" required placeholder="votre@email.com">
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-label">Mot de passe</label>
                        <input type="password" class="auth-input" id="signup-password" required minlength="6" placeholder="Minimum 6 caract√®res">
                    </div>
                    <button type="submit" class="auth-submit" id="signup-btn">Cr√©er mon compte</button>
                </form>
                
                <!-- Login Form -->
                <form id="login-form" style="display:none" onsubmit="handleLogin(event)">
                    <div class="auth-input-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="login-email" required placeholder="votre@email.com">
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-label">Mot de passe</label>
                        <input type="password" class="auth-input" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="auth-submit" id="login-btn">Se connecter</button>
                </form>
            </div>
            <div class="auth-footer">
                <a href="mon-espace.html">D√©j√† un compte ? Mon espace ‚Üí</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    
    <script>
        // ============================================
        // STATE
        // ============================================
        let guideData = null;
        let blocks = [];
        let slides = [];
        let currentSlide = 0;
        let quizCorrectCount = 0;
        let quizTotalCount = 0;
        let isPreviewMode = false;
        let currentUser = null;
        let userResponses = {};
        let saveTimeout = null;
        let authRequired = false;
        
        // AJOUT: Variables pour les s√©quences
        let sequences = [];
        let currentSequenceIndex = 0;
        let allBlocks = [];
        let sequenceProgress = {};
        
        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            initSupabase();
            
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');
            isPreviewMode = params.get('preview') === 'true';
            
            if (!slug) { showError(); return; }
            
            // Check auth
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) currentUser = session.user;
            
            // Auth obligatoire sauf en mode aper√ßu
            if (!isPreviewMode && !currentUser) {
                authRequired = true;
                // Charger le guide pour afficher le hero, mais bloquer l'acc√®s
                await loadGuidePreview(slug);
                showAuthModal();
                return;
            }
            
            await loadGuide(slug);
        });
        
        // Charger uniquement le hero sans d√©marrer le guide
        async function loadGuidePreview(slug) {
            try {
                const { data: guide, error } = await supabaseClient
                    .from('quizzes')
                    .select('*')
                    .eq('slug', slug)
                    .eq('published', true)
                    .single();
                
                if (error || !guide) { showError(); return; }
                
                guideData = guide;
                document.title = `${guide.titre} - OP! Parents`;
                renderHero(guide);
                
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 400);
            } catch (e) {
                showError();
            }
        }
        
        // Callback apr√®s connexion r√©ussie
        async function onAuthSuccess() {
            authRequired = false;
            closeAuthModal();
            
            // Charger le guide complet si pas encore fait
            if (!blocks || blocks.length === 0) {
                await loadGuide(guideData.slug);
                // D√©marrer automatiquement apr√®s chargement
                handleStartGuide();
            } else {
                // Guide d√©j√† charg√©, juste charger les r√©ponses et d√©marrer
                await loadUserResponses(guideData.slug);
                handleStartGuide();
            }
        }
        
        // Keyboard & Swipe
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('auth-overlay').classList.contains('visible')) return;
            if (document.getElementById('sequence-sommaire').classList.contains('visible')) return;
            if (document.getElementById('calc-modal').classList.contains('visible')) return;
            if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
            if (e.key === 'ArrowLeft') prevSlide();
        });
        
        let touchStartX = 0;
        document.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; });
        document.addEventListener('touchend', (e) => {
            if (document.getElementById('auth-overlay').classList.contains('visible')) return;
            if (document.getElementById('sequence-sommaire').classList.contains('visible')) return;
            const diff = touchStartX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) nextSlide();
                else prevSlide();
            }
        });
        
        // ============================================
        // LOAD GUIDE
        // ============================================
        async function loadGuide(slug) {
            try {
                let query = supabaseClient.from('quizzes').select('*').eq('slug', slug);
                if (!isPreviewMode) query = query.eq('published', true);
                const { data: guide, error } = await query.single();
                
                if (error || !guide) { showError(); return; }
                
                guideData = guide;
                
                // MODIFI√â: Charger blocks et sequences depuis le guide
                allBlocks = guide.blocks || [];
                sequences = guide.sequences || [];
                
                // Si pas de s√©quences, cr√©er une s√©quence par d√©faut
                if (sequences.length === 0) {
                    sequences = [{ id: 'default', titre: guideData.titre || 'Guide', emoji: guideData.icon || 'üìñ', description: '' }];
                }
                
                // Assigner les blocs sans sequenceId √† la premi√®re s√©quence
                allBlocks = allBlocks.map(b => ({
                    ...b,
                    sequenceId: b.sequenceId || sequences[0]?.id || 'default'
                }));
                
                blocks = allBlocks;
                quizTotalCount = blocks.filter(b => b.type === 'quiz').length;
                slides = groupBlocksIntoSlides(blocks);
                
                // Load existing responses if logged in
                if (currentUser && !isPreviewMode) {
                    await loadUserResponses(slug);
                }
                
                if (!isPreviewMode) {
                    supabaseClient.from('quizzes').update({ view_count: (guide.view_count || 0) + 1 }).eq('id', guide.id);
                }
                
                document.title = `${guide.titre} - OP! Parents`;
                renderHero(guide);
                renderSlides();
                renderProgressSegments();
                
                if (isPreviewMode) showPreviewBadge();
                
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 400);
            } catch (error) {
                console.error('Erreur:', error);
                showError();
            }
        }
        
        async function loadUserResponses(slug) {
            try {
                const { data, error } = await supabaseClient
                    .from('user_responses')
                    .select('responses')
                    .eq('user_id', currentUser.id)
                    .eq('quiz_slug', slug)
                    .single();
                
                if (data && data.responses) {
                    userResponses = data.responses;
                    sequenceProgress = userResponses._sequenceProgress || {};
                }
            } catch (e) {
                // No existing responses
            }
        }
        
        // AJOUT: R√©cup√©rer les blocs d'une s√©quence
        function getBlocksForSequence(sequenceId) {
            return allBlocks.filter(b => b.sequenceId === sequenceId);
        }
        
        // AJOUT: Compter le total de slides
        function getTotalSlideCount() {
            let total = 0;
            sequences.forEach(seq => {
                const seqBlocks = getBlocksForSequence(seq.id);
                const seqSlides = groupBlocksIntoSlides(seqBlocks);
                total += seqSlides.length;
            });
            return total || slides.length;
        }
        
        function groupBlocksIntoSlides(allBlocks) {
            const hasPageBreaks = allBlocks.some(b => b.type === 'page-break');
            if (!hasPageBreaks) return allBlocks.filter(b => b.type !== 'page-break').map(b => [b]);
            
            const result = [];
            let currentGroup = [];
            for (const block of allBlocks) {
                if (block.type === 'page-break') {
                    if (currentGroup.length > 0) { result.push(currentGroup); currentGroup = []; }
                } else {
                    currentGroup.push(block);
                }
            }
            if (currentGroup.length > 0) result.push(currentGroup);
            return result;
        }
        
        // ============================================
        // RENDER
        // ============================================
        function renderHero(guide) {
            document.getElementById('header-title').textContent = guide.titre;
            document.getElementById('hero-icon').textContent = guide.icon || 'üìñ';
            document.getElementById('hero-title').textContent = guide.titre;
            document.getElementById('hero-subtitle').textContent = guide.sous_titre || '';
            document.getElementById('hero-duration').textContent = guide.duree || '10 min';
            document.getElementById('hero-blocks').textContent = getTotalSlideCount();
            
            // AJOUT: Afficher nombre de niveaux si > 1
            if (sequences.length > 1) {
                document.getElementById('hero-levels-container').style.display = '';
                document.getElementById('hero-levels').textContent = sequences.length;
            }
            
            const categories = { 'budget': 'üí∞ Budget', 'epargne': 'üõ°Ô∏è √âpargne', 'investissement': 'üìà Investissement', 'mindset': 'üß† Mindset', 'famille': 'üë®‚Äçüë©‚Äçüëß Famille' };
            document.getElementById('hero-category').textContent = categories[guide.category] || 'üìñ Guide';
            if (guide.image_url) {
                document.getElementById('hero-image').src = guide.image_url;
                document.getElementById('hero-card').style.display = 'block';
            }
        }
        
        // AJOUT: Render du sommaire des s√©quences
        function renderSommaire() {
            document.getElementById('sommaire-icon').textContent = guideData.icon || 'üìö';
            document.getElementById('sommaire-intro-title').textContent = guideData.titre;
            
            const container = document.getElementById('sequence-list');
            container.innerHTML = sequences.map((seq, index) => {
                const seqBlocks = getBlocksForSequence(seq.id);
                const slideCount = groupBlocksIntoSlides(seqBlocks).length;
                const progress = sequenceProgress[seq.id] || {};
                const isCompleted = progress.completed;
                const isPreviousCompleted = index === 0 || sequenceProgress[sequences[index - 1]?.id]?.completed;
                const isLocked = index > 0 && !isPreviousCompleted;
                const isCurrent = isPreviousCompleted && !isCompleted;
                
                let statusClass = isCompleted ? 'completed' : isCurrent ? 'current' : 'locked';
                let statusIcon = isCompleted ? '‚úì' : isCurrent ? '‚Üí' : 'üîí';
                
                const onclick = isLocked ? '' : `startSequence(${index})`;
                
                return `
                    <div class="sequence-card ${statusClass}" onclick="${onclick}" data-index="${index}">
                        <div class="sequence-card-icon">${seq.emoji || 'üìö'}</div>
                        <div class="sequence-card-content">
                            <div class="sequence-card-number">Niveau ${index + 1}</div>
                            <div class="sequence-card-title">${esc(seq.titre)}</div>
                            <div class="sequence-card-desc">${slideCount} slides${seq.description ? ' ‚Ä¢ ' + esc(seq.description) : ''}</div>
                        </div>
                        <div class="sequence-card-status">${statusIcon}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderProgressSegments() {
            const container = document.getElementById('progress-segments');
            container.innerHTML = slides.map((_, i) => `<div class="progress-segment" data-index="${i}"><div class="progress-segment-fill"></div></div>`).join('');
        }
        
        function updateProgressSegments() {
            document.querySelectorAll('.progress-segment').forEach((seg, i) => {
                seg.classList.remove('completed', 'current');
                if (i < currentSlide) seg.classList.add('completed');
                else if (i === currentSlide) seg.classList.add('current');
            });
            document.getElementById('header-counter').textContent = `${currentSlide + 1}/${slides.length}`;
        }
        
        function renderSlides() {
            const container = document.getElementById('slides-container');
            container.innerHTML = slides.map((slideBlocks, slideIndex) => `
                <div class="slide" data-index="${slideIndex}">
                    <div class="slide-blocks">${slideBlocks.map((block, blockIndex) => renderBlock(block, blockIndex)).join('')}</div>
                </div>
            `).join('');
        }
        
        function renderBlock(block, index) {
            const data = block.data || {};
            switch (block.type) {
                case 'section-title':
                    return `<div class="block-section-title"><h2 class="section-title-text">${esc(data.title || '')}</h2></div>`;
                case 'narrative':
                    return `<div class="block-narrative">${data.title ? `<div class="narrative-title">${esc(data.title)}</div>` : ''}<div class="narrative-content">${formatNarrative(data.content || '')}</div></div>`;
                case 'info-box':
                    return `<div class="block-info-box style-${data.style || 'default'}">${data.title ? `<div class="info-box-title">${infoIcon(data.style)} ${esc(data.title)}</div>` : ''}<div class="info-box-content">${fmt(data.content || '')}</div></div>`;
                case 'stat':
                    return `<div class="block-stat"><div class="stat-text">${esc(data.stat || '')}</div>${data.source ? `<div class="stat-source">‚Äî ${esc(data.source)}</div>` : ''}</div>`;
                case 'poll':
                    return renderPoll(data, index);
                case 'quiz':
                    return renderQuiz(data, index);
                case 'focus':
                    return `<div class="block-focus"><div class="focus-icon">üîç</div>${data.title ? `<div class="focus-title">${esc(data.title)}</div>` : ''}<div class="focus-content">${fmt(data.content || '')}</div></div>`;
                case 'table':
                    return renderTable(data);
                case 'exercise':
                    return renderExercise(data);
                case 'exercise-text':
                    return renderExerciseText(data);
                case 'summary':
                    return `<div class="block-summary"><div class="summary-header"><div class="summary-icon">üìù</div><div class="summary-title">${esc(data.title || '√Ä retenir')}</div></div><ul class="summary-list">${(data.points || data.content || '').split('\n').filter(l => l.trim()).map(l => `<li>${esc(l.replace(/^[‚Ä¢\-\*]\s*/, ''))}</li>`).join('')}</ul></div>`;
                case 'cta':
                    return `<div class="block-cta"><h3 class="cta-title">${esc(data.title || 'Passez √† l\'action')}</h3><p class="cta-text">${esc(data.content || '')}</p><a href="${data.button_url || data.link || 'contact.html'}" class="cta-button">${esc(data.button_text || data.buttonText || 'Je me lance')} ‚Üí</a></div>`;
                case 'image':
                    return `<figure class="block-image"><img src="${esc(data.url || '')}" alt="${esc(data.alt || '')}">${data.caption ? `<figcaption>${esc(data.caption)}</figcaption>` : ''}</figure>`;
                case 'personal-field':
                    return renderPersonalField(data);
                case 'calculator':
                    return renderCalculator(data);
                case 'newsletter':
                    return renderNewsletter(data);
                default:
                    return '';
            }
        }
        
        function renderPoll(data, index) {
            const options = data.options || [];
            return `<div class="block-poll" data-answered="false"><div class="poll-header"><span class="poll-badge">üó≥Ô∏è Sondage</span></div><div class="poll-question">${esc(data.question || '')}</div><div class="poll-options">${options.map((o, i) => {
                const text = typeof o === 'string' ? o : o.text;
                return `<div class="poll-option" onclick="selectPoll(this)"><div class="poll-option-checkbox"></div><span class="poll-option-text">${esc(text || '')}</span></div>`;
            }).join('')}</div></div>`;
        }
        
        function renderQuiz(data, index) {
            const options = data.options || [];
            return `<div class="block-quiz" data-answered="false"><div class="quiz-header"><span class="quiz-badge">‚ùì Quiz</span></div><div class="quiz-question">${esc(data.question || '')}</div><div class="quiz-options">${options.map((o, i) => {
                const text = typeof o === 'string' ? o : o.text;
                const correct = typeof o === 'object' ? o.correct : false;
                return `<div class="quiz-option" data-correct="${correct ? 'true' : 'false'}" onclick="selectQuiz(this)"><span class="quiz-option-letter">${String.fromCharCode(65 + i)}</span><span class="quiz-option-text">${esc(text || '')}</span></div>`;
            }).join('')}</div>${data.explanation ? `<div class="quiz-explanation"><div class="quiz-explanation-title">üí° Explication</div><div class="quiz-explanation-text">${fmt(data.explanation)}</div></div>` : ''}</div>`;
        }
        
        function renderTable(data) {
            const rows = (data.data || '').split('\n').filter(r => r.trim());
            if (!rows.length) return '';
            const headers = rows[0].split('|').map(h => h.trim());
            const body = rows.slice(1);
            return `<div class="block-table">${data.title ? `<div class="table-title">${esc(data.title)}</div>` : ''}<table class="data-table"><thead><tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr></thead><tbody>${body.map(r => `<tr>${r.split('|').map(c => `<td>${esc(c.trim())}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
        }
        
        function renderExercise(data) {
            const lines = (data.fields || '').split('\n').filter(f => f.trim());
            let html = `<div class="block-exercise" data-has-calc="true">
                <div class="exercise-title">${esc(data.title || '‚úçÔ∏è Exercice')}</div>
                ${data.instructions ? `<div class="exercise-instructions">${esc(data.instructions)}</div>` : ''}
                <div class="exercise-fields">`;
            
            lines.forEach(line => {
                const trimmed = line.trim();
                // Lignes commen√ßant par ( sont des aides non √©ditables
                if (trimmed.startsWith('(') && trimmed.endsWith(')')) {
                    html += `<div class="exercise-help-text">${esc(trimmed)}</div>`;
                } else {
                    // Champ √† remplir
                    const label = trimmed.replace(/[:Ôºö].*$/, '').trim();
                    html += `<div class="exercise-field">
                        <span class="exercise-field-label">${esc(label)}</span>
                        <input type="text" class="exercise-field-input" placeholder="...">
                        <span class="exercise-field-unit">‚Ç¨</span>
                    </div>`;
                }
            });
            
            html += `</div>
                <button class="exercise-calc-btn" onclick="openCalculator()">üßÆ Ouvrir la calculette</button>
            </div>`;
            return html;
        }
        
        function renderExerciseText(data) {
            const blockKey = 'exercise_text_' + Math.random().toString(36).substr(2, 9);
            const fields = data.fields || [{ question: data.question || '', placeholder: data.placeholder || '' }];
            
            let fieldsHtml = fields.map((field, i) => {
                const fieldKey = `${blockKey}_${i}`;
                return `
                    <div class="exercise-text-field">
                        <div class="exercise-text-question">${esc(field.question || '')}</div>
                        <textarea 
                            class="exercise-text-input" 
                            data-key="${esc(fieldKey)}"
                            placeholder="${esc(field.placeholder || '√âcris ta r√©ponse ici...')}"
                            rows="3"
                            oninput="handleExerciseTextChange(this)"
                        ></textarea>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="block-exercise-text">
                    <div class="exercise-text-header">
                        <span class="exercise-text-badge">üí¨ √Ä toi de r√©pondre</span>
                    </div>
                    ${data.title ? `<div class="exercise-text-title">${esc(data.title)}</div>` : ''}
                    <div class="exercise-text-fields-container">
                        ${fieldsHtml}
                    </div>
                    ${data.help ? `<div class="exercise-text-help">üí° ${esc(data.help)}</div>` : ''}
                </div>
            `;
        }
        
        function renderNewsletter(data) {
            const blockId = 'newsletter_' + Math.random().toString(36).substr(2, 9);
            return `
                <div class="block-newsletter" id="${blockId}">
                    <div class="newsletter-icon">üì¨</div>
                    <h3 class="newsletter-title">${esc(data.title || 'Reste inform√© !')}</h3>
                    <p class="newsletter-description">${esc(data.description || 'Inscris-toi √† notre newsletter pour recevoir nos meilleurs conseils.')}</p>
                    
                    <form class="newsletter-form" onsubmit="return handleNewsletterSubmit(event, '${blockId}')">
                        <div class="newsletter-input-group">
                            <input 
                                type="email" 
                                class="newsletter-input" 
                                placeholder="${esc(data.placeholder || 'ton@email.com')}"
                                required
                            >
                            <button type="submit" class="newsletter-button">
                                ${esc(data.buttonText || 'Je m\'inscris')}
                            </button>
                        </div>
                        <div class="newsletter-message" style="display: none;"></div>
                    </form>
                    
                    <button type="button" class="newsletter-skip" onclick="skipNewsletter('${blockId}')">
                        ${esc(data.skipText || 'Passer cette √©tape')} ‚Üí
                    </button>
                </div>
            `;
        }
        
        function renderPersonalField(data) {
            const key = data.key || 'field_' + Math.random().toString(36).substr(2, 9);
            const existingValue = userResponses[key] || '';
            const inputType = data.fieldType === 'number' || data.fieldType === 'money' || data.fieldType === 'percent' ? 'number' : 'text';
            const suffix = data.fieldType === 'money' ? ' ‚Ç¨' : data.fieldType === 'percent' ? ' %' : '';
            const isTextarea = data.fieldType === 'textarea';
            const hasValue = existingValue ? 'has-value' : '';
            
            return `
                <div class="block-personal-field">
                    <label class="personal-field-label">${esc(data.label || 'Votre r√©ponse')}</label>
                    ${isTextarea 
                        ? `<textarea class="personal-field-input personal-field-textarea ${hasValue}" data-key="${esc(key)}" placeholder="${esc(data.placeholder || '')}" oninput="handlePersonalFieldChange(this)">${esc(existingValue)}</textarea>`
                        : `<input type="${inputType}" class="personal-field-input ${hasValue}" data-key="${esc(key)}" value="${esc(existingValue)}" placeholder="${esc(data.placeholder || '')}${suffix}" oninput="handlePersonalFieldChange(this)">`
                    }
                    ${data.help ? `<div class="personal-field-help">${esc(data.help)}</div>` : ''}
                    <div class="personal-field-saved" id="saved-${key}">‚úì Sauvegard√©</div>
                </div>
            `;
        }
        
        function renderCalculator(data) {
            const key = data.key || 'calc_' + Math.random().toString(36).substr(2, 9);
            const unit = data.unit || '‚Ç¨';
            const lines = (data.lines || '').split('\n').filter(l => l.trim());
            const existingDetails = userResponses[key + '_detail'] || {};
            const existingTotal = userResponses[key] || 0;
            
            return `
                <div class="block-calculator" data-key="${esc(key)}" data-unit="${esc(unit)}">
                    <div class="calculator-header">
                        <div class="calculator-title">${esc(data.title || 'Calculatrice')}</div>
                        ${data.description ? `<div class="calculator-description">${esc(data.description)}</div>` : ''}
                    </div>
                    <div class="calculator-lines">
                        ${lines.map((line, i) => {
                            const lineKey = line.split('(')[0].trim();
                            const existingLineValue = existingDetails[lineKey] || '';
                            const hasValue = existingLineValue ? 'has-value' : '';
                            return `
                                <div class="calculator-line">
                                    <span class="calculator-line-label">${esc(line)}</span>
                                    <input type="number" 
                                           class="calculator-line-input ${hasValue}" 
                                           data-line="${esc(lineKey)}"
                                           value="${existingLineValue}"
                                           placeholder="0"
                                           oninput="handleCalculatorChange(this)"
                                           min="0"
                                           step="0.01">
                                    <span class="calculator-line-unit">${esc(unit)}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="calculator-total">
                        <span class="calculator-total-label">TOTAL</span>
                        <span class="calculator-total-value">
                            <span class="calculator-total-number" id="total-${key}">${existingTotal.toLocaleString('fr-FR')}</span> ${esc(unit)}
                            <span class="calculator-saved" id="calc-saved-${key}">‚úì</span>
                        </span>
                    </div>
                </div>
            `;
        }
        
        function handleCalculatorChange(input) {
            const calculator = input.closest('.block-calculator');
            const key = calculator.dataset.key;
            const lineKey = input.dataset.line;
            const value = parseFloat(input.value) || 0;
            
            // Update input style
            input.classList.toggle('has-value', value > 0);
            
            // Calculate total
            let total = 0;
            const details = {};
            calculator.querySelectorAll('.calculator-line-input').forEach(inp => {
                const lKey = inp.dataset.line;
                const lValue = parseFloat(inp.value) || 0;
                if (lValue > 0) {
                    details[lKey] = lValue;
                    total += lValue;
                }
            });
            
            // Update total display
            document.getElementById(`total-${key}`).textContent = total.toLocaleString('fr-FR');
            
            // Save to userResponses
            userResponses[key] = total;
            userResponses[key + '_detail'] = details;
            
            // Debounced save
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveUserResponses(key);
                const savedEl = document.getElementById(`calc-saved-${key}`);
                if (savedEl) {
                    savedEl.classList.add('visible');
                    setTimeout(() => savedEl.classList.remove('visible'), 2000);
                }
            }, 800);
        }
        
        // ============================================
        // EXERCISE TEXT
        // ============================================
        function handleExerciseTextChange(textarea) {
            const key = textarea.dataset.key;
            const value = textarea.value;
            
            userResponses[key] = value;
            
            // Debounced save
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveUserResponses(key), 1000);
        }
        
        // ============================================
        // NEWSLETTER
        // ============================================
        async function handleNewsletterSubmit(event, blockId) {
            event.preventDefault();
            
            const blockEl = document.getElementById(blockId);
            const form = blockEl.querySelector('.newsletter-form');
            const input = form.querySelector('.newsletter-input');
            const button = form.querySelector('.newsletter-button');
            const messageEl = form.querySelector('.newsletter-message');
            const email = input.value.trim();
            
            if (!email) return false;
            
            // D√©sactiver le bouton
            button.disabled = true;
            button.textContent = '‚è≥ Inscription...';
            messageEl.style.display = 'none';
            
            try {
                // Enregistrer dans Supabase
                const { data, error } = await supabaseClient
                    .from('newsletter_subscribers')
                    .insert({
                        email: email,
                        source: 'guide',
                        guide_slug: guideData?.slug || window.location.pathname,
                        guide_title: guideData?.titre || document.title
                    });
                
                if (error) {
                    // V√©rifier si c'est un doublon
                    if (error.code === '23505' || error.message.includes('duplicate')) {
                        showNewsletterMessage(messageEl, 'Tu es d√©j√† inscrit(e) ! üëç', 'info');
                    } else {
                        throw error;
                    }
                } else {
                    showNewsletterMessage(messageEl, '‚úÖ Inscription r√©ussie ! Bienvenue dans la communaut√© OP!', 'success');
                    
                    // Envoyer l'alerte email via webhook (si configur√©)
                    sendNewsletterAlert(email, guideData?.titre || 'Guide');
                }
                
                // Masquer le formulaire et afficher le message de succ√®s
                setTimeout(() => {
                    form.innerHTML = `
                        <div class="newsletter-success">
                            <span class="newsletter-success-icon">üéâ</span>
                            <span>Merci pour ton inscription !</span>
                        </div>
                    `;
                }, 1500);
                
            } catch (error) {
                console.error('Erreur inscription newsletter:', error);
                showNewsletterMessage(messageEl, '‚ùå Une erreur est survenue. R√©essaie plus tard.', 'error');
                button.disabled = false;
                button.textContent = 'Je m\'inscris';
            }
            
            return false;
        }
        
        function showNewsletterMessage(el, message, type) {
            el.textContent = message;
            el.className = 'newsletter-message newsletter-message-' + type;
            el.style.display = 'block';
        }
        
        function skipNewsletter(blockId) {
            const blockEl = document.getElementById(blockId);
            blockEl.classList.add('newsletter-skipped');
            
            // Passer √† la slide suivante si on est en mode slides
            if (typeof goToSlide === 'function' && currentSlide < totalSlides - 1) {
                goToSlide(currentSlide + 1);
            }
        }
        
        async function sendNewsletterAlert(email, guideName) {
            // Envoyer l'alerte via webhook Make
            try {
                await fetch('https://hook.eu2.make.com/xpabkvk01i54lmnc5mitb0gtw74eoxqi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        guide: guideName,
                        timestamp: new Date().toISOString()
                    })
                });
                console.log('‚úÖ Alerte newsletter envoy√©e');
            } catch (e) {
                // Silencieux si erreur
                console.log('Newsletter alert skipped:', e.message);
            }
        }
        
        // ============================================
        // PERSONAL FIELDS
        // ============================================
        function handlePersonalFieldChange(input) {
            const key = input.dataset.key;
            const value = input.value;
            
            userResponses[key] = value;
            input.classList.toggle('has-value', value.length > 0);
            
            // Debounced save
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveUserResponses(key), 1000);
        }
        
        async function saveUserResponses(lastKey) {
            if (!currentUser || isPreviewMode) return;
            
            try {
                // AJOUT: Sauvegarder aussi la progression des s√©quences
                userResponses._sequenceProgress = sequenceProgress;
                
                const { error } = await supabaseClient
                    .from('user_responses')
                    .upsert({
                        user_id: currentUser.id,
                        quiz_slug: guideData.slug,
                        quiz_title: guideData.titre,
                        quiz_icon: guideData.icon || 'üìñ',
                        responses: userResponses,
                        completed: false
                    }, { onConflict: 'user_id,quiz_slug' });
                
                if (!error && lastKey) {
                    const savedEl = document.getElementById(`saved-${lastKey}`);
                    if (savedEl) {
                        savedEl.classList.add('visible');
                        setTimeout(() => savedEl.classList.remove('visible'), 2000);
                    }
                }
            } catch (e) {
                console.error('Save error:', e);
            }
        }
        
        // ============================================
        // NAVIGATION
        // ============================================
        function handleStartGuide() {
            if (isPreviewMode) {
                // MODIFI√â: G√©rer les s√©quences multiples
                if (sequences.length > 1) {
                    showSommaire();
                } else {
                    startSequence(0);
                }
                return;
            }
            
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            // MODIFI√â: G√©rer les s√©quences multiples
            if (sequences.length > 1) {
                showSommaire();
            } else {
                startSequence(0);
            }
        }
        
        // AJOUT: Afficher le sommaire
        function showSommaire() {
            renderSommaire();
            document.getElementById('guide-hero').classList.add('hidden');
            document.getElementById('sequence-sommaire').classList.add('visible');
        }
        
        // AJOUT: Retour au hero
        function backToHero() {
            document.getElementById('sequence-sommaire').classList.remove('visible');
            document.getElementById('guide-hero').classList.remove('hidden');
        }
        
        // AJOUT: Retour au sommaire
        function backToSommaire() {
            document.getElementById('sequence-complete-overlay').classList.remove('visible');
            document.getElementById('guide-header').style.display = 'none';
            document.getElementById('guide-content').classList.remove('active');
            document.getElementById('nav-bottom').classList.remove('active');
            renderSommaire();
            document.getElementById('sequence-sommaire').classList.add('visible');
        }
        
        // AJOUT: D√©marrer une s√©quence
        function startSequence(index) {
            currentSequenceIndex = index;
            const seq = sequences[index];
            
            // Filtrer les blocs pour cette s√©quence
            blocks = getBlocksForSequence(seq.id);
            slides = groupBlocksIntoSlides(blocks);
            quizTotalCount = blocks.filter(b => b.type === 'quiz').length;
            
            // Mettre √† jour le header avec info s√©quence
            if (sequences.length > 1) {
                document.getElementById('header-sequence').classList.add('visible');
                document.getElementById('header-sequence-emoji').textContent = seq.emoji || 'üìö';
                document.getElementById('header-sequence-name').textContent = seq.titre;
            }
            
            // Masquer sommaire, afficher guide
            document.getElementById('sequence-sommaire').classList.remove('visible');
            document.getElementById('guide-hero').classList.add('hidden');
            document.getElementById('guide-header').style.display = 'flex';
            document.getElementById('guide-content').classList.add('active');
            document.getElementById('nav-bottom').classList.add('active');
            
            if (currentUser && !isPreviewMode) {
                showUserBadge();
            }
            
            renderSlides();
            renderProgressSegments();
            
            // Reprendre l√† o√π on en √©tait
            const savedProgress = sequenceProgress[seq.id];
            currentSlide = savedProgress?.currentSlide || 0;
            if (currentSlide >= slides.length) currentSlide = 0;
            
            showSlide(currentSlide);
        }
        
        // MODIFI√â: Gestion du bouton retour
        function handleBackButton() {
            if (sequences.length > 1) {
                if (confirm('Retourner au sommaire ?')) {
                    backToSommaire();
                }
            } else {
                exitGuide();
            }
        }
        
        function exitGuide() {
            if (confirm('Quitter ce guide ?')) {
                window.location.href = 'quiz.html';
            }
        }
        
        function showSlide(index) {
            const allSlides = document.querySelectorAll('.slide');
            allSlides.forEach((slide, i) => {
                slide.classList.remove('active', 'prev');
                if (i === index) slide.classList.add('active');
                else if (i < index) slide.classList.add('prev');
            });
            currentSlide = index;
            updateProgressSegments();
            updateNavButtons();
            updateCalcButton(index);
            
            // AJOUT: Sauvegarder la progression de la s√©quence
            if (sequences.length > 0 && currentUser) {
                const seq = sequences[currentSequenceIndex];
                if (seq) {
                    sequenceProgress[seq.id] = sequenceProgress[seq.id] || {};
                    sequenceProgress[seq.id].currentSlide = index;
                    saveUserResponses();
                }
            }
        }
        
        function updateCalcButton(slideIndex) {
            const calcFab = document.getElementById('calc-fab');
            if (!calcFab) return;
            
            // Check if current slide has an exercise block
            const slideBlocks = slides[slideIndex] || [];
            const hasExercise = slideBlocks.some(b => b.type === 'exercise');
            
            if (hasExercise) {
                calcFab.classList.add('visible');
            } else {
                calcFab.classList.remove('visible');
            }
        }
        
        function prevSlide() { if (currentSlide > 0) showSlide(currentSlide - 1); }
        
        function nextSlide() {
            if (currentSlide < slides.length - 1) {
                showSlide(currentSlide + 1);
            } else {
                // MODIFI√â: G√©rer la fin de s√©quence
                completeCurrentSequence();
            }
        }
        
        // AJOUT: Compl√©ter la s√©quence courante
        function completeCurrentSequence() {
            const seq = sequences[currentSequenceIndex];
            sequenceProgress[seq.id] = { completed: true, currentSlide: slides.length };
            saveUserResponses();
            
            // V√©rifier si c'est le dernier niveau
            if (currentSequenceIndex >= sequences.length - 1) {
                showCompletion();
            } else {
                showSequenceComplete();
            }
        }
        
        // AJOUT: Afficher l'√©cran de fin de s√©quence
        function showSequenceComplete() {
            const seq = sequences[currentSequenceIndex];
            const nextSeq = sequences[currentSequenceIndex + 1];
            
            document.getElementById('sequence-complete-title').textContent = `${seq.emoji || 'üéâ'} ${seq.titre} termin√© !`;
            document.getElementById('sequence-complete-text').textContent = `Bravo ! Tu peux maintenant passer au niveau suivant.`;
            document.getElementById('sequence-next-btn').textContent = `${nextSeq.emoji || 'üìö'} ${nextSeq.titre} ‚Üí`;
            
            document.getElementById('sequence-complete-overlay').classList.add('visible');
        }
        
        // AJOUT: Passer √† la s√©quence suivante
        function goToNextSequence() {
            document.getElementById('sequence-complete-overlay').classList.remove('visible');
            startSequence(currentSequenceIndex + 1);
        }
        
        function updateNavButtons() {
            const prevBtn = document.getElementById('btn-prev');
            const nextBtn = document.getElementById('btn-next');
            prevBtn.disabled = currentSlide === 0;
            
            const isLastSlide = currentSlide === slides.length - 1;
            const isLastSequence = currentSequenceIndex >= sequences.length - 1;
            
            if (isLastSlide) {
                if (isLastSequence || sequences.length <= 1) {
                    nextBtn.innerHTML = `Terminer <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                } else {
                    nextBtn.innerHTML = `Niveau suivant <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>`;
                }
                nextBtn.classList.add('golden');
            } else {
                nextBtn.innerHTML = `Suivant <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>`;
                nextBtn.classList.remove('golden');
            }
        }
        
        // ============================================
        // QUIZ & POLL
        // ============================================
        function selectQuiz(el) {
            const quiz = el.closest('.block-quiz');
            if (quiz.dataset.answered === 'true') return;
            quiz.dataset.answered = 'true';
            const isCorrect = el.dataset.correct === 'true';
            quiz.querySelectorAll('.quiz-option').forEach(o => o.classList.add('disabled'));
            if (isCorrect) {
                el.classList.add('correct');
                el.querySelector('.quiz-option-letter').textContent = '‚úì';
                quizCorrectCount++;
            } else {
                el.classList.add('incorrect');
                el.querySelector('.quiz-option-letter').textContent = '‚úó';
                const correct = quiz.querySelector('[data-correct="true"]');
                if (correct) { correct.classList.add('correct'); correct.querySelector('.quiz-option-letter').textContent = '‚úì'; }
            }
            const expl = quiz.querySelector('.quiz-explanation');
            if (expl) setTimeout(() => expl.classList.add('visible'), 300);
        }
        
        function selectPoll(el) {
            const poll = el.closest('.block-poll');
            if (poll.dataset.answered === 'true') return;
            poll.dataset.answered = 'true';
            poll.querySelectorAll('.poll-option').forEach(o => o.classList.add('disabled'));
            el.classList.add('selected');
            setTimeout(() => {
                const options = poll.querySelectorAll('.poll-option');
                const results = fakePollResults(options.length);
                let html = '<div class="poll-results">';
                options.forEach((o, i) => {
                    const text = o.querySelector('.poll-option-text').textContent;
                    html += `<div class="poll-result-item"><div class="poll-result-header"><span class="poll-result-text">${esc(text)}</span><span class="poll-result-percent">${results[i]}%</span></div><div class="poll-result-bar"><div class="poll-result-fill" style="width:0%"></div></div></div>`;
                });
                html += '</div>';
                poll.insertAdjacentHTML('beforeend', html);
                setTimeout(() => { poll.querySelectorAll('.poll-result-fill').forEach((f, i) => f.style.width = results[i] + '%'); }, 50);
            }, 300);
        }
        
        function fakePollResults(n) {
            const r = []; let rem = 100;
            for (let i = 0; i < n - 1; i++) { const v = Math.floor(Math.random() * (rem - (n - i) * 5)) + 5; r.push(v); rem -= v; }
            r.push(rem);
            return r;
        }
        
        // ============================================
        // COMPLETION
        // ============================================
        async function showCompletion() {
            document.getElementById('stat-blocks').textContent = getTotalSlideCount();
            document.getElementById('stat-quiz').textContent = `${quizCorrectCount}/${quizTotalCount}`;
            
            // Mark as completed
            if (currentUser && !isPreviewMode) {
                await supabaseClient
                    .from('user_responses')
                    .upsert({
                        user_id: currentUser.id,
                        quiz_slug: guideData.slug,
                        quiz_title: guideData.titre,
                        quiz_icon: guideData.icon || 'üìñ',
                        responses: userResponses,
                        completed: true
                    }, { onConflict: 'user_id,quiz_slug' });
            }
            
            document.getElementById('completion-screen').classList.add('visible');
        }
        
        // ============================================
        // AUTH
        // ============================================
        function showAuthModal() {
            document.getElementById('auth-overlay').classList.add('visible');
        }
        
        function closeAuthModal() {
            document.getElementById('auth-overlay').classList.remove('visible');
            document.getElementById('auth-error').classList.remove('visible');
        }
        
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab:${tab === 'signup' ? 'first-child' : 'last-child'}`).classList.add('active');
            document.getElementById('signup-form').style.display = tab === 'signup' ? 'block' : 'none';
            document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('auth-error').classList.remove('visible');
        }
        
        async function handleSignup(e) {
            e.preventDefault();
            const btn = document.getElementById('signup-btn');
            btn.disabled = true;
            btn.textContent = 'Cr√©ation...';
            
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email, password,
                    options: { data: { name } }
                });
                
                if (error) throw error;
                
                if (data.session) {
                    currentUser = data.user;
                    await onAuthSuccess();
                } else {
                    showAuthError('V√©rifiez votre email pour confirmer votre inscription.');
                }
            } catch (error) {
                showAuthError(getAuthErrorMessage(error));
            } finally {
                btn.disabled = false;
                btn.textContent = 'Cr√©er mon compte';
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            btn.textContent = 'Connexion...';
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                currentUser = data.user;
                await onAuthSuccess();
            } catch (error) {
                showAuthError(getAuthErrorMessage(error));
            } finally {
                btn.disabled = false;
                btn.textContent = 'Se connecter';
            }
        }
        
        function showAuthError(msg) {
            const el = document.getElementById('auth-error');
            el.textContent = msg;
            el.classList.add('visible');
        }
        
        function getAuthErrorMessage(error) {
            const messages = {
                'Invalid login credentials': 'Email ou mot de passe incorrect',
                'User already registered': 'Cet email est d√©j√† utilis√©'
            };
            return messages[error.message] || error.message || 'Une erreur est survenue';
        }
        
        // ============================================
        // HELPERS
        // ============================================
        function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function fmt(t) { return esc(t).replace(/\n/g, '<br>'); }
        function formatNarrative(t) { return t.split('\n').filter(p => p.trim()).map(p => p.startsWith('¬´') || p.startsWith('"') ? `<p class="dialogue">${esc(p)}</p>` : `<p>${esc(p)}</p>`).join(''); }
        function infoIcon(s) { return s === 'warning' ? '‚ö†Ô∏è' : s === 'tip' ? 'üí°' : 'üìã'; }
        
        function showError() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('error-screen').classList.add('visible');
        }
        
        function showPreviewBadge() {
            const b = document.createElement('div');
            b.className = 'preview-badge';
            b.textContent = 'üëÅÔ∏è Preview';
            document.body.appendChild(b);
        }
        
        function showUserBadge() {
            if (document.querySelector('.user-badge')) return;
            const name = currentUser.user_metadata?.name || currentUser.email.split('@')[0];
            const b = document.createElement('div');
            b.className = 'user-badge';
            b.innerHTML = `<span class="user-badge-dot"></span> ${esc(name)}`;
            document.body.appendChild(b);
        }
        
        // ============================================
        // FLOATING CALCULATOR
        // ============================================
        let calcLines = [];
        let calcLineId = 0;
        
        function openCalculator() {
            // Load saved data if exists
            loadCalcFromResponses();
            document.getElementById('calc-modal').classList.add('visible');
        }
        
        function closeCalculator() {
            document.getElementById('calc-modal').classList.remove('visible');
        }
        
        function validateAndCloseCalculator() {
            saveCalcToResponses();
            closeCalculator();
            
            // Show confirmation
            const btn = document.getElementById('calc-validate-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úì Sauvegard√© !';
            btn.style.background = '#10B981';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 1500);
        }
        
        function loadCalcFromResponses() {
            const saved = userResponses['_calculator'];
            if (saved && saved.lines && saved.lines.length > 0) {
                calcLines = saved.lines.map((line, i) => ({
                    id: i + 1,
                    label: line.label || '',
                    value: line.value || 0
                }));
                calcLineId = calcLines.length;
            } else if (calcLines.length === 0) {
                calcLines = [];
                calcLineId = 0;
            }
            renderCalcLines();
            updateCalcTotal();
        }
        
        function saveCalcToResponses() {
            if (!currentUser || isPreviewMode) return;
            
            const total = calcLines.reduce((sum, line) => sum + (line.value || 0), 0);
            const lines = calcLines
                .filter(l => l.label || l.value)
                .map(l => ({ label: l.label, value: l.value }));
            
            userResponses['_calculator'] = { lines, total };
            userResponses['_calculator_total'] = total;
            
            // Debounced save to Supabase
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveUserResponses('_calculator'), 500);
        }
        
        function addCalcLine(label = '', value = '') {
            calcLineId++;
            const id = calcLineId;
            calcLines.push({ id, label, value: parseFloat(value) || 0 });
            renderCalcLines();
            updateCalcTotal();
            
            // Focus on the new label input
            setTimeout(() => {
                const input = document.querySelector(`[data-calc-id="${id}"] .calc-line-label`);
                if (input) input.focus();
            }, 50);
        }
        
        function removeCalcLine(id) {
            calcLines = calcLines.filter(l => l.id !== id);
            renderCalcLines();
            updateCalcTotal();
            saveCalcToResponses();
        }
        
        function updateCalcLine(id, field, value) {
            const line = calcLines.find(l => l.id === id);
            if (line) {
                if (field === 'label') {
                    line.label = value;
                } else if (field === 'value') {
                    line.value = parseFloat(value) || 0;
                }
            }
            updateCalcTotal();
            saveCalcToResponses();
        }
        
        function renderCalcLines() {
            const container = document.getElementById('calc-lines');
            
            if (calcLines.length === 0) {
                container.innerHTML = `
                    <div class="calc-empty">
                        <div class="calc-empty-icon">üìù</div>
                        <div class="calc-empty-text">Ajoutez des lignes pour calculer</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = calcLines.map(line => `
                <div class="calc-line" data-calc-id="${line.id}">
                    <input type="text" 
                           class="calc-line-label" 
                           value="${esc(line.label)}" 
                           placeholder="Libell√©..."
                           oninput="updateCalcLine(${line.id}, 'label', this.value)">
                    <input type="number" 
                           class="calc-line-value" 
                           value="${line.value || ''}" 
                           placeholder="0"
                           min="0"
                           step="0.01"
                           oninput="updateCalcLine(${line.id}, 'value', this.value)">
                    <span class="calc-line-unit">‚Ç¨</span>
                    <button class="calc-line-delete" onclick="removeCalcLine(${line.id})" title="Supprimer">üóëÔ∏è</button>
                </div>
            `).join('');
        }
        
        function updateCalcTotal() {
            const total = calcLines.reduce((sum, line) => sum + (line.value || 0), 0);
            document.getElementById('calc-total').textContent = total.toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        }
        
        function copyCalcTotal() {
            const total = calcLines.reduce((sum, line) => sum + (line.value || 0), 0);
            
            // Copy to clipboard
            navigator.clipboard.writeText(total.toString()).then(() => {
                const btn = document.getElementById('calc-copy-btn');
                const text = document.getElementById('calc-copy-text');
                btn.classList.add('copied');
                text.textContent = '‚úì Copi√© !';
                
                setTimeout(() => {
                    btn.classList.remove('copied');
                    text.textContent = 'üìã Copier';
                }, 2000);
            });
        }
        
        function clearCalculator() {
            if (confirm('Effacer toutes les lignes ?')) {
                calcLines = [];
                calcLineId = 0;
                renderCalcLines();
                updateCalcTotal();
                saveCalcToResponses();
            }
        }
    </script>
</body>
</html>