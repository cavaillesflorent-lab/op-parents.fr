<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guides - OP! Parents</title>
    <meta name="description" content="D√©couvre ton profil financier gr√¢ce √† nos guides interactifs. Teste ton mindset et progresse √† ton rythme.">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/style-responsive.css">
    <style>
        /* Fix: √âviter que la transition ne fasse rater les clics */
        .quiz-card {
            transition: box-shadow 0.3s ease !important;
            transform: none !important;
        }
        .quiz-card:hover {
            transform: none !important;
            box-shadow: var(--shadow-xl);
        }
        .quiz-card-btn {
            position: relative;
            z-index: 10;
        }
        
        /* Modal d'authentification */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .auth-overlay.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .auth-modal {
            background: var(--white, #fff);
            border-radius: 24px;
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            position: relative;
        }
        .auth-overlay.visible .auth-modal {
            transform: translateY(0);
        }
        /* Bouton fermeture ‚Üí retour accueil */
        .auth-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
            text-decoration: none;
            color: white;
            backdrop-filter: blur(4px);
        }
        .auth-close:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }
        .auth-close svg {
            width: 18px;
            height: 18px;
            stroke: white;
            stroke-width: 2.5;
        }
        /* Responsive */
        @media (max-width: 480px) {
            .auth-close {
                width: 32px;
                height: 32px;
                top: 0.75rem;
                right: 0.75rem;
            }
            .auth-close svg {
                width: 16px;
                height: 16px;
            }
        }
        @media (max-width: 360px) {
            .auth-close {
                width: 30px;
                height: 30px;
                top: 0.6rem;
                right: 0.6rem;
            }
            .auth-close svg {
                width: 14px;
                height: 14px;
            }
        }
        .auth-header {
            background: linear-gradient(135deg, #2D403B 0%, #3D5550 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            border-radius: 24px 24px 0 0;
        }
        .auth-logo {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #F2D680;
            margin-bottom: 0.5rem;
        }
        .auth-title {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .auth-benefits {
            padding: 1.5rem 2rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e9eceb;
        }
        .auth-benefit {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            font-size: 0.95rem;
            color: #2D403B;
        }
        .auth-benefit-icon {
            font-size: 1.2rem;
        }
        .auth-form {
            padding: 1.5rem 2rem 2rem;
        }
        .auth-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: #f1f3f2;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        .auth-tab.active {
            background: #2D403B;
            color: white;
        }
        .auth-input-group {
            margin-bottom: 1rem;
        }
        .auth-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #2D403B;
            margin-bottom: 0.4rem;
        }
        .auth-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e9eceb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }
        .auth-input:focus {
            outline: none;
            border-color: #2D403B;
        }
        .auth-submit {
            width: 100%;
            padding: 1rem;
            background: #2D403B;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            margin-top: 0.5rem;
        }
        .auth-submit:hover {
            background: #3D5550;
        }
        .auth-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .auth-error {
            background: #fef2f2;
            color: #BF604B;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: none;
        }
        .auth-error.visible {
            display: block;
        }
        
        /* User bar quand connect√© */
        .user-bar {
            background: linear-gradient(135deg, #DFF2B6 0%, #c5e090 100%);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #2D403B;
            font-weight: 500;
        }
        .user-logout {
            background: none;
            border: none;
            color: #2D403B;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: underline;
            font-family: inherit;
        }
        .user-logout:hover {
            color: #BF604B;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div id="header-placeholder"></div>
    
    <!-- USER BAR (affich√© quand connect√©) -->
    <div class="user-bar" id="user-bar" style="display: none;">
        <div class="user-info">
            <span>üëã</span>
            <span>Bonjour <strong id="user-name">!</strong></span>
        </div>
        <button class="user-logout" onclick="handleLogout()">D√©connexion</button>
    </div>

    <main>
        <!-- HERO -->
        <section class="page-hero">
            <div class="page-hero-content">
                <h1>Quel parent √™tes-vous face √† l'argent ?</h1>
                <p>Des guides interactifs pour comprendre vos r√©flexes financiers et savoir par o√π commencer.</p>
            </div>
        </section>

        <!-- STATS -->
        <section class="page-stats-section">
            <div class="page-stats">
                <div class="page-stat">
                    <div class="page-stat-icon">‚úÖ</div>
                    <div class="page-stat-info">
                        <span class="page-stat-value" id="stat-completed">0</span>
                        <span class="page-stat-label">Termin√©s</span>
                    </div>
                </div>
                <div class="page-stat-divider"></div>
                <div class="page-stat">
                    <div class="page-stat-icon">‚è≥</div>
                    <div class="page-stat-info">
                        <span class="page-stat-value" id="stat-in-progress">0</span>
                        <span class="page-stat-label">En cours</span>
                    </div>
                </div>
                <div class="page-stat-divider"></div>
                <div class="page-stat">
                    <div class="page-stat-icon">üìö</div>
                    <div class="page-stat-info">
                        <span class="page-stat-value" id="stat-total">0</span>
                        <span class="page-stat-label">Disponibles</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- FILTRES -->
        <section class="page-filters-section">
            <div class="container">
                <div class="page-filters">
                    <button class="page-filter-btn active" data-filter="all">Tous les guides</button>
                    <button class="page-filter-btn" data-filter="in-progress">En cours</button>
                    <button class="page-filter-btn" data-filter="completed">Termin√©s</button>
                </div>
            </div>
        </section>

        <!-- LISTE -->
        <section class="page-list-section">
            <div class="container">
                <div class="quiz-grid" id="quiz-list">
                    <div class="loading-state">
                        <div class="quiz-loading-spinner"></div>
                        <p>Chargement des guides...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA -->
        <section class="page-cta-section">
            <div class="container">
                <div class="page-cta-card">
                    <div class="page-cta-content">
                        <h2>Tu veux aller plus loin ?</h2>
                        <p>D√©couvre nos webinaires pour approfondir ta transformation financi√®re avec des experts.</p>
                    </div>
                    <a href="webinaires.html" class="page-cta-btn">
                        Voir les webinaires
                        <span class="arrow">‚Üí</span>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <div id="footer-placeholder"></div>
    
    <!-- MODAL AUTH -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-modal">
            <!-- Bouton fermeture ‚Üí retour accueil -->
            <a href="index.html" class="auth-close" title="Retour √† l'accueil">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </a>
            <div class="auth-header">
                <div class="auth-logo">OP!</div>
                <div class="auth-title">Cr√©ez votre compte gratuit</div>
            </div>
            <div class="auth-benefits">
                <div class="auth-benefit"><span class="auth-benefit-icon">üìö</span> Acc√®s √† tous les guides interactifs</div>
                <div class="auth-benefit"><span class="auth-benefit-icon">üíæ</span> Sauvegarde automatique de ta progression</div>
                <div class="auth-benefit"><span class="auth-benefit-icon">üìä</span> Suivi personnalis√© de tes r√©sultats</div>
            </div>
            <div class="auth-form">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('signup')">Inscription</button>
                    <button class="auth-tab" onclick="switchAuthTab('login')">Connexion</button>
                </div>
                <div class="auth-error" id="auth-error"></div>
                
                <!-- Signup Form -->
                <form id="signup-form" onsubmit="handleSignup(event)">
                    <div class="auth-input-group">
                        <label class="auth-label">Pr√©nom</label>
                        <input type="text" class="auth-input" id="signup-name" required placeholder="Ton pr√©nom">
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="signup-email" required placeholder="ton@email.com">
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-label">Mot de passe</label>
                        <input type="password" class="auth-input" id="signup-password" required minlength="6" placeholder="Minimum 6 caract√®res">
                    </div>
                    <button type="submit" class="auth-submit" id="signup-btn">Cr√©er mon compte</button>
                </form>
                
                <!-- Login Form -->
                <form id="login-form" style="display:none" onsubmit="handleLogin(event)">
                    <div class="auth-input-group">
                        <label class="auth-label">Email</label>
                        <input type="email" class="auth-input" id="login-email" required placeholder="ton@email.com">
                    </div>
                    <div class="auth-input-group">
                        <label class="auth-label">Mot de passe</label>
                        <input type="password" class="auth-input" id="login-password" required placeholder="Ton mot de passe">
                    </div>
                    <button type="submit" class="auth-submit" id="login-btn">Se connecter</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/components.js"></script>
    <script>
        let currentUser = null;
        let userProgressMap = {}; // Stocke la progression par quiz_slug
        
        // ============================================
        // AUTH FUNCTIONS
        // ============================================
        
        function showAuthModal() {
            document.getElementById('auth-overlay').classList.add('visible');
        }
        
        function hideAuthModal() {
            document.getElementById('auth-overlay').classList.remove('visible');
        }
        
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab:${tab === 'signup' ? 'first-child' : 'last-child'}`).classList.add('active');
            document.getElementById('signup-form').style.display = tab === 'signup' ? 'block' : 'none';
            document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('auth-error').classList.remove('visible');
        }
        
        function showAuthError(message) {
            const el = document.getElementById('auth-error');
            el.textContent = message;
            el.classList.add('visible');
        }
        
        function getAuthErrorMessage(error) {
            const messages = {
                'Invalid login credentials': 'Email ou mot de passe incorrect',
                'Email not confirmed': 'V√©rifie ton email pour confirmer ton compte',
                'User already registered': 'Un compte existe d√©j√† avec cet email',
                'Password should be at least 6 characters': 'Le mot de passe doit faire au moins 6 caract√®res'
            };
            return messages[error.message] || error.message || 'Une erreur est survenue';
        }
        
        async function handleSignup(e) {
            e.preventDefault();
            const btn = document.getElementById('signup-btn');
            btn.disabled = true;
            btn.textContent = 'Cr√©ation...';
            
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email, password,
                    options: { data: { name } }
                });
                
                if (error) throw error;
                
                if (data.session) {
                    currentUser = data.user;
                    onAuthSuccess();
                } else {
                    showAuthError('V√©rifie ton email pour confirmer ton inscription.');
                }
            } catch (error) {
                showAuthError(getAuthErrorMessage(error));
            } finally {
                btn.disabled = false;
                btn.textContent = 'Cr√©er mon compte';
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            btn.textContent = 'Connexion...';
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                currentUser = data.user;
                onAuthSuccess();
            } catch (error) {
                showAuthError(getAuthErrorMessage(error));
            } finally {
                btn.disabled = false;
                btn.textContent = 'Se connecter';
            }
        }
        
        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            userProgressMap = {};
            document.getElementById('user-bar').style.display = 'none';
            showAuthModal();
        }
        
        async function onAuthSuccess() {
            hideAuthModal();
            showUserBar();
            await loadUserProgress();
            await loadQuizzes();
        }
        
        function showUserBar() {
            const userName = currentUser?.user_metadata?.name || currentUser?.email?.split('@')[0] || 'Visiteur';
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-bar').style.display = 'flex';
        }

        // ============================================
        // PROGRESS FUNCTIONS
        // ============================================
        
        async function loadUserProgress() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('user_responses')
                    .select('quiz_slug, responses, completed')
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                // Cr√©er un map slug -> progression
                userProgressMap = {};
                data?.forEach(row => {
                    userProgressMap[row.quiz_slug] = {
                        responses: row.responses || {},
                        completed: row.completed || false
                    };
                });
                
                console.log('‚úÖ Progression charg√©e:', Object.keys(userProgressMap).length, 'guides');
            } catch (e) {
                console.error('Erreur chargement progression:', e);
            }
        }

        function getQuizProgress(quizSlug, totalQuestions) {
            const progress = userProgressMap[quizSlug];
            
            // Pas de progression sauvegard√©e
            if (!progress) {
                return { percent: 0, status: 'not-started', currentQuestion: 0 };
            }
            
            // Guide termin√© (depuis Supabase)
            if (progress.completed) {
                return { percent: 100, status: 'completed', currentQuestion: totalQuestions };
            }
            
            // Calculer le pourcentage depuis les r√©ponses
            let answered = 0;
            const responses = progress.responses || {};
            
            // Compter les r√©ponses de type quiz
            Object.keys(responses).forEach(key => {
                if (key.startsWith('quiz_') || key.startsWith('poll_')) {
                    answered++;
                }
            });
            
            // Aussi v√©rifier sequenceProgress
            const seqProgress = responses._sequenceProgress || {};
            Object.values(seqProgress).forEach(seq => {
                if (seq && seq.currentSlide) {
                    answered = Math.max(answered, seq.currentSlide);
                }
            });
            
            const percent = totalQuestions > 0 ? Math.min(Math.round((answered / totalQuestions) * 100), 99) : 0;
            
            return {
                percent,
                status: answered > 0 ? 'in-progress' : 'not-started',
                currentQuestion: answered
            };
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================
        
        function createProgressCircle(percent) {
            const radius = 20;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            const color = percent === 100 ? '#2D403B' : percent > 0 ? '#F2B47E' : '#dee2e0';
            
            return `
                <div class="quiz-card-progress">
                    <svg class="progress-ring" width="52" height="52" viewBox="0 0 52 52">
                        <circle cx="26" cy="26" r="${radius}" fill="none" stroke="#e8e8e8" stroke-width="4"/>
                        <circle cx="26" cy="26" r="${radius}" fill="none" stroke="${color}" stroke-width="4"
                            stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                            transform="rotate(-90 26 26)"/>
                    </svg>
                    <span class="progress-percent">${percent}%</span>
                </div>
            `;
        }

        function countQuestionsFromBlocks(blocks) {
            if (!blocks || !Array.isArray(blocks) || blocks.length === 0) {
                return 0;
            }
            return blocks.filter(b => b.type === 'quiz').length;
        }

        function createQuizCard(quiz, questionCount) {
            const progress = getQuizProgress(quiz.slug, questionCount);
            
            const statusLabels = {
                'not-started': { text: 'Nouveau', class: 'new', btn: 'Commencer' },
                'in-progress': { text: 'En cours', class: 'progress', btn: 'Continuer' },
                'completed': { text: 'Termin√©', class: 'done', btn: 'Refaire' }
            };
            const status = statusLabels[progress.status];

            const imageHtml = quiz.image_url 
                ? `<img src="${quiz.image_url}" alt="${quiz.titre}" loading="lazy">`
                : `<div class="quiz-card-placeholder"><span>üìö</span></div>`;

            const sequences = quiz.sequences || [];
            const levelsBadge = sequences.length > 1 
                ? `<span style="margin-left: 0.5rem; padding: 0.15rem 0.5rem; background: var(--vert-clair, #DFF2B6); border-radius: 12px; font-size: 0.75rem; color: var(--vert-fonce, #2D403B);">üìö ${sequences.length} niveaux</span>` 
                : '';

            return `
                <article class="quiz-card" data-slug="${quiz.slug}" data-status="${progress.status}">
                    <div class="quiz-card-image">
                        ${imageHtml}
                        <span class="quiz-card-badge ${status.class}">${status.text}</span>
                    </div>
                    <div class="quiz-card-body">
                        <h3 class="quiz-card-title">${quiz.titre}${levelsBadge}</h3>
                        ${quiz.sous_titre ? `<p class="quiz-card-subtitle">${quiz.sous_titre}</p>` : ''}
                        <div class="quiz-card-meta">
                            <span>‚ùì ${questionCount} questions</span>
                            <span>‚è±Ô∏è ${quiz.duree || '5 min'}</span>
                        </div>
                        <div class="quiz-card-footer">
                            ${createProgressCircle(progress.percent)}
                            <a href="guide.html?slug=${quiz.slug}" class="quiz-card-btn ${status.class}">
                                ${status.btn}
                                <span class="arrow">‚Üí</span>
                            </a>
                        </div>
                    </div>
                </article>
            `;
        }

        async function loadQuizzes() {
            try {
                const { data: quizzes, error } = await supabaseClient
                    .from('quizzes')
                    .select('*, blocks, sequences')
                    .eq('published', true)
                    .order('ordre', { ascending: true });

                if (error) throw error;

                const { data: questions } = await supabaseClient
                    .from('quiz_questions')
                    .select('quiz_id');

                const questionCountsOld = {};
                questions?.forEach(q => {
                    questionCountsOld[q.quiz_id] = (questionCountsOld[q.quiz_id] || 0) + 1;
                });

                const container = document.getElementById('quiz-list');
                
                if (!quizzes || quizzes.length === 0) {
                    container.innerHTML = `
                        <div class="page-empty">
                            <div class="page-empty-icon">üìö</div>
                            <h3>Aucun guide disponible</h3>
                            <p>Les guides arrivent tr√®s bient√¥t, reste connect√© !</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = quizzes.map(quiz => {
                    let questionCount = countQuestionsFromBlocks(quiz.blocks);
                    if (questionCount === 0) {
                        questionCount = questionCountsOld[quiz.id] || 0;
                    }
                    return createQuizCard(quiz, questionCount);
                }).join('');

                updateStats(quizzes, questionCountsOld);
                setupFilters();

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('quiz-list').innerHTML = `
                    <div class="page-empty">
                        <div class="page-empty-icon">üòï</div>
                        <h3>Oups, une erreur</h3>
                        <p>Impossible de charger les guides. R√©essaie plus tard.</p>
                        <button onclick="loadQuizzes()" class="retry-btn">R√©essayer</button>
                    </div>
                `;
            }
        }

        function updateStats(quizzes, questionCountsOld) {
            let completed = 0;
            let inProgress = 0;

            quizzes.forEach(quiz => {
                let questionCount = countQuestionsFromBlocks(quiz.blocks);
                if (questionCount === 0) {
                    questionCount = questionCountsOld[quiz.id] || 0;
                }
                const p = getQuizProgress(quiz.slug, questionCount);
                if (p.status === 'completed') completed++;
                else if (p.status === 'in-progress') inProgress++;
            });

            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-in-progress').textContent = inProgress;
            document.getElementById('stat-total').textContent = quizzes.length;
        }

        function setupFilters() {
            document.querySelectorAll('.page-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.page-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const filter = btn.dataset.filter;
                    let hasVisible = false;
                    
                    document.querySelectorAll('.quiz-card').forEach(card => {
                        const status = card.dataset.status;
                        const show = filter === 'all' || 
                            (filter === 'in-progress' && status === 'in-progress') ||
                            (filter === 'completed' && status === 'completed');
                        
                        card.style.display = show ? '' : 'none';
                        if (show) hasVisible = true;
                    });

                    const container = document.getElementById('quiz-list');
                    const existingEmpty = container.querySelector('.filter-empty');
                    if (existingEmpty) existingEmpty.remove();

                    if (!hasVisible && filter !== 'all') {
                        const msg = filter === 'in-progress' 
                            ? "Tu n'as aucun guide en cours. Commence-en un !" 
                            : "Tu n'as pas encore termin√© de guide. Lance-toi !";
                        container.insertAdjacentHTML('beforeend', `
                            <div class="filter-empty">
                                <p>${msg}</p>
                            </div>
                        `);
                    }
                });
            });
        }

        // ============================================
        // INIT
        // ============================================
        
        async function init() {
            initSupabase();
            
            // V√©rifier si d√©j√† connect√©
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                showUserBar();
                await loadUserProgress();
                await loadQuizzes();
            } else {
                // Pas connect√© ‚Üí afficher le modal d'auth
                showAuthModal();
                // Charger les quiz quand m√™me (sans progression)
                await loadQuizzes();
            }
        }

        document.addEventListener('componentsLoaded', init);
        setTimeout(() => {
            if (document.getElementById('quiz-list').innerHTML.includes('Chargement')) {
                init();
            }
        }, 1500);
    </script>
</body>
</html>