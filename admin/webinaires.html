<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webinaires - Admin OP!</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="../assets/css/admin-quiz.css">
</head>
<body class="admin-body">
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <img src="../assets/images/logo.png" alt="OP!" class="sidebar-logo">
                <span>Admin OP!</span>
            </div>
            
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    Dashboard
                </a>
                <a href="webinaires.html" class="nav-item active">
                    <span class="nav-icon">ğŸ¥</span>
                    Webinaires
                </a>
                <a href="formations.html" class="nav-item">
                    <span class="nav-icon">ğŸ“š</span>
                    Formations
                </a>
                <a href="quizzes.html" class="nav-item">
                    <span class="nav-icon">ğŸ§ </span>
                    Quiz
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <a href="../index.html" class="nav-item">
                    <span class="nav-icon">ğŸŒ</span>
                    Voir le site
                </a>
                <button id="logout-btn" class="nav-item logout-btn">
                    <span class="nav-icon">ğŸšª</span>
                    DÃ©connexion
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1>Webinaires</h1>
                <button class="btn btn-primary" id="new-webinaire-btn">
                    â• Nouveau webinaire
                </button>
            </header>

            <div class="admin-content">
                <!-- Liste des webinaires -->
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Titre</th>
                                <th>Date</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="webinaires-list">
                            <tr>
                                <td colspan="4" class="loading">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Formulaire -->
    <div class="modal" id="webinaire-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modal-title">Nouveau webinaire</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            
            <form id="webinaire-form" class="admin-form">
                <input type="hidden" id="webinaire-id">
                
                <!-- Informations principales -->
                <div class="form-section">
                    <h3>ğŸ“ Informations gÃ©nÃ©rales</h3>
                    
                    <div class="form-group">
                        <label for="titre">Titre du webinaire *</label>
                        <input type="text" id="titre" name="titre" required placeholder="Ex: Comment parler d'argent avec ses enfants ?">
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" rows="4" placeholder="DÃ©crivez le contenu et les objectifs du webinaire..."></textarea>
                    </div>
                </div>
                
                <!-- Date et horaire -->
                <div class="form-section">
                    <h3>ğŸ“… Date et horaire</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date_heure">Date et heure *</label>
                            <input type="datetime-local" id="date_heure" name="date_heure" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="statut">Statut</label>
                            <select id="statut" name="statut">
                                <option value="a_venir">Ã€ venir</option>
                                <option value="replay">Replay disponible</option>
                                <option value="termine">TerminÃ©</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Attendus -->
                <div class="form-section">
                    <h3>ğŸ¯ Ce que les participants vont apprendre</h3>
                    <p class="section-desc">Listez les points clÃ©s que les participants retiendront de ce webinaire.</p>
                    
                    <div class="attendus-container" id="attendus-container">
                        <!-- Les attendus seront ajoutÃ©s ici dynamiquement -->
                    </div>
                    
                    <button type="button" class="btn btn-secondary btn-sm" id="btn-add-attendu">
                        + Ajouter un point clÃ©
                    </button>
                </div>
                
                <!-- Lien et paramÃ¨tres -->
                <div class="form-section">
                    <h3>ğŸ”— Lien de connexion</h3>
                    
                    <div class="form-group">
                        <label for="lien_meet">Lien Google Meet</label>
                        <input type="url" id="lien_meet" name="lien_meet" placeholder="https://meet.google.com/xxx-xxx-xxx">
                        <small class="form-hint">Ce lien sera envoyÃ© aux inscrits et affichÃ© au moment du webinaire</small>
                    </div>
                </div>
                
                <!-- Image de couverture -->
                <div class="form-section">
                    <h3>ğŸ–¼ï¸ Image de couverture</h3>
                    
                    <div class="image-upload-container">
                        <div class="image-preview" id="image-preview">
                            <img id="preview-img" src="" alt="PrÃ©visualisation" style="display: none;">
                            <div class="image-placeholder" id="image-placeholder">
                                <span class="placeholder-icon">ğŸ“·</span>
                                <span class="placeholder-text">Aucune image</span>
                            </div>
                        </div>
                        
                        <div class="image-upload-actions">
                            <input type="file" id="image-file" accept="image/*" style="display: none;">
                            <input type="hidden" id="image_url" name="image_url">
                            
                            <button type="button" class="btn btn-secondary" id="btn-upload-image">
                                ğŸ“ Choisir une image
                            </button>
                            <button type="button" class="btn btn-outline btn-sm" id="btn-remove-image" style="display: none;">
                                ğŸ—‘ï¸ Supprimer
                            </button>
                            
                            <div class="upload-progress" id="upload-progress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="upload-progress-fill"></div>
                                </div>
                                <span class="progress-text">Upload en cours...</span>
                            </div>
                            
                            <small class="form-hint">Formats acceptÃ©s : JPG, PNG, GIF, WebP (max 5 Mo)</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-btn">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Enregistrer</span>
                        <span class="btn-loader" style="display: none;">Enregistrement...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Confirmation Suppression -->
    <div class="modal" id="delete-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Confirmer la suppression</h2>
                <button class="modal-close" id="delete-modal-close">&times;</button>
            </div>
            <p>ÃŠtes-vous sÃ»r de vouloir supprimer ce webinaire ?</p>
            <div class="form-actions">
                <button class="btn btn-secondary" id="delete-cancel">Annuler</button>
                <button class="btn btn-danger" id="delete-confirm">Supprimer</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <script>
        // Initialiser Supabase
        const client = initSupabase();

        let currentDeleteId = null;
        let attendusCount = 0;

        // Ã‰couter les changements d'authentification
        client.auth.onAuthStateChange((event, session) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                loadWebinaires();
            }
        });

        // Charger les webinaires
        async function loadWebinaires() {
            const { data, error } = await supabaseClient
                .from('webinaires')
                .select('*')
                .order('date_heure', { ascending: false });

            if (error) {
                console.error('Erreur:', error);
                return;
            }

            displayWebinaires(data || []);
        }

        // Afficher les webinaires
        function displayWebinaires(webinaires) {
            const tbody = document.getElementById('webinaires-list');
            
            if (webinaires.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty">Aucun webinaire. CrÃ©ez-en un !</td></tr>';
                return;
            }

            tbody.innerHTML = webinaires.map(w => `
                <tr>
                    <td>
                        <strong>${w.titre}</strong>
                        ${w.description ? `<br><small>${w.description.substring(0, 50)}...</small>` : ''}
                    </td>
                    <td>${w.date_heure ? new Date(w.date_heure).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                    <td><span class="status-badge status-${w.statut}">${formatStatut(w.statut)}</span></td>
                    <td class="actions-cell">
                        <button class="btn-icon" onclick="editWebinaire('${w.id}')" title="Modifier">âœï¸</button>
                        <button class="btn-icon btn-danger" onclick="confirmDelete('${w.id}')" title="Supprimer">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        // Formater le statut
        function formatStatut(statut) {
            const labels = {
                'a_venir': 'Ã€ venir',
                'replay': 'Replay',
                'termine': 'TerminÃ©'
            };
            return labels[statut] || statut;
        }

        // === GESTION DES ATTENDUS ===
        
        function addAttendu(value = '') {
            attendusCount++;
            const container = document.getElementById('attendus-container');
            const div = document.createElement('div');
            div.className = 'attendu-item';
            div.innerHTML = `
                <span class="attendu-icon">âœ…</span>
                <input type="text" class="attendu-input" placeholder="Ex: Comprendre les bases de l'Ã©ducation financiÃ¨re" value="${value}">
                <button type="button" class="btn-icon btn-remove-attendu" onclick="removeAttendu(this)">ğŸ—‘ï¸</button>
            `;
            container.appendChild(div);
        }
        
        function removeAttendu(btn) {
            btn.closest('.attendu-item').remove();
        }
        
        function getAttendus() {
            const inputs = document.querySelectorAll('.attendu-input');
            return Array.from(inputs)
                .map(input => input.value.trim())
                .filter(val => val !== '');
        }
        
        function setAttendus(attendus) {
            const container = document.getElementById('attendus-container');
            container.innerHTML = '';
            attendusCount = 0;
            
            if (attendus && attendus.length > 0) {
                attendus.forEach(att => addAttendu(att));
            } else {
                // Ajouter 2 champs vides par dÃ©faut
                addAttendu();
                addAttendu();
            }
        }
        
        // Bouton ajouter attendu
        document.getElementById('btn-add-attendu').addEventListener('click', () => addAttendu());

        // === GESTION DE L'UPLOAD D'IMAGE ===
        
        let currentImageUrl = null;
        
        // Clic sur le bouton d'upload
        document.getElementById('btn-upload-image').addEventListener('click', () => {
            document.getElementById('image-file').click();
        });
        
        // SÃ©lection d'un fichier
        document.getElementById('image-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // VÃ©rifier la taille (max 5 Mo)
            if (file.size > 5 * 1024 * 1024) {
                alert('L\'image est trop lourde. Maximum 5 Mo.');
                return;
            }
            
            // VÃ©rifier le type
            if (!file.type.startsWith('image/')) {
                alert('Le fichier doit Ãªtre une image.');
                return;
            }
            
            // Afficher la prÃ©visualisation locale
            const reader = new FileReader();
            reader.onload = (e) => {
                showImagePreview(e.target.result);
            };
            reader.readAsDataURL(file);
            
            // Upload vers Supabase Storage
            await uploadImage(file);
        });
        
        // Upload de l'image vers Supabase Storage
        async function uploadImage(file) {
            const progressEl = document.getElementById('upload-progress');
            const progressFill = document.getElementById('upload-progress-fill');
            
            progressEl.style.display = 'block';
            progressFill.style.width = '30%';
            
            try {
                // GÃ©nÃ©rer un nom unique
                const timestamp = Date.now();
                const ext = file.name.split('.').pop();
                const fileName = `webinaire-${timestamp}.${ext}`;
                
                progressFill.style.width = '50%';
                
                // Upload vers Supabase Storage
                const { data, error } = await supabaseClient.storage
                    .from('webinaires')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    console.error('Erreur upload:', error);
                    alert('Erreur lors de l\'upload: ' + error.message);
                    progressEl.style.display = 'none';
                    return;
                }
                
                progressFill.style.width = '80%';
                
                // RÃ©cupÃ©rer l'URL publique
                const { data: urlData } = supabaseClient.storage
                    .from('webinaires')
                    .getPublicUrl(fileName);
                
                currentImageUrl = urlData.publicUrl;
                document.getElementById('image_url').value = currentImageUrl;
                
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 500);
                
                console.log('Image uploadÃ©e:', currentImageUrl);
                
            } catch (err) {
                console.error('Erreur:', err);
                alert('Erreur lors de l\'upload');
                progressEl.style.display = 'none';
            }
        }
        
        // Afficher la prÃ©visualisation
        function showImagePreview(src) {
            const previewImg = document.getElementById('preview-img');
            const placeholder = document.getElementById('image-placeholder');
            const removeBtn = document.getElementById('btn-remove-image');
            
            previewImg.src = src;
            previewImg.style.display = 'block';
            placeholder.style.display = 'none';
            removeBtn.style.display = 'inline-flex';
        }
        
        // Masquer la prÃ©visualisation
        function hideImagePreview() {
            const previewImg = document.getElementById('preview-img');
            const placeholder = document.getElementById('image-placeholder');
            const removeBtn = document.getElementById('btn-remove-image');
            
            previewImg.src = '';
            previewImg.style.display = 'none';
            placeholder.style.display = 'flex';
            removeBtn.style.display = 'none';
            
            document.getElementById('image_url').value = '';
            document.getElementById('image-file').value = '';
            currentImageUrl = null;
        }
        
        // Bouton supprimer image
        document.getElementById('btn-remove-image').addEventListener('click', hideImagePreview);

        // Ouvrir le modal
        function openModal(title = 'Nouveau webinaire') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('webinaire-modal').classList.add('active');
        }

        // Fermer le modal
        function closeModal() {
            document.getElementById('webinaire-modal').classList.remove('active');
            document.getElementById('webinaire-form').reset();
            document.getElementById('webinaire-id').value = '';
            setAttendus(null); // Reset attendus
            hideImagePreview(); // Reset image
        }

        // Nouveau webinaire
        document.getElementById('new-webinaire-btn').addEventListener('click', () => {
            setAttendus(null);
            hideImagePreview();
            openModal('Nouveau webinaire');
        });

        // Fermer modal
        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        document.querySelector('#webinaire-modal .modal-overlay').addEventListener('click', closeModal);

        // Modifier un webinaire
        async function editWebinaire(id) {
            const { data, error } = await supabaseClient
                .from('webinaires')
                .select('*')
                .eq('id', id)
                .single();

            if (error || !data) {
                alert('Erreur lors du chargement');
                return;
            }

            document.getElementById('webinaire-id').value = data.id;
            document.getElementById('titre').value = data.titre || '';
            document.getElementById('description').value = data.description || '';
            document.getElementById('date_heure').value = data.date_heure ? data.date_heure.slice(0, 16) : '';
            document.getElementById('statut').value = data.statut || 'a_venir';
            document.getElementById('lien_meet').value = data.lien_meet || '';
            document.getElementById('image_url').value = data.image_url || '';
            
            // Charger les attendus
            setAttendus(data.attendus || []);
            
            // Charger l'image existante
            if (data.image_url) {
                showImagePreview(data.image_url);
                currentImageUrl = data.image_url;
            } else {
                hideImagePreview();
            }

            openModal('Modifier le webinaire');
        }

        // Soumettre le formulaire
        document.getElementById('webinaire-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btnText = document.querySelector('.btn-text');
            const btnLoader = document.querySelector('.btn-loader');
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';

            const id = document.getElementById('webinaire-id').value;
            const webinaire = {
                titre: document.getElementById('titre').value,
                description: document.getElementById('description').value,
                date_heure: document.getElementById('date_heure').value || null,
                statut: document.getElementById('statut').value,
                lien_meet: document.getElementById('lien_meet').value,
                image_url: document.getElementById('image_url').value,
                attendus: getAttendus()
            };

            let error;
            if (id) {
                // Update
                ({ error } = await supabaseClient.from('webinaires').update(webinaire).eq('id', id));
            } else {
                // Insert
                ({ error } = await supabaseClient.from('webinaires').insert([webinaire]));
            }

            btnText.style.display = 'inline';
            btnLoader.style.display = 'none';

            if (error) {
                alert('Erreur: ' + error.message);
                return;
            }

            closeModal();
            loadWebinaires();
        });

        // Confirmation suppression
        function confirmDelete(id) {
            currentDeleteId = id;
            document.getElementById('delete-modal').classList.add('active');
        }

        document.getElementById('delete-modal-close').addEventListener('click', () => {
            document.getElementById('delete-modal').classList.remove('active');
        });
        document.getElementById('delete-cancel').addEventListener('click', () => {
            document.getElementById('delete-modal').classList.remove('active');
        });

        // Supprimer
        document.getElementById('delete-confirm').addEventListener('click', async () => {
            if (!currentDeleteId) return;

            const { error } = await supabaseClient
                .from('webinaires')
                .delete()
                .eq('id', currentDeleteId);

            if (error) {
                alert('Erreur: ' + error.message);
                return;
            }

            document.getElementById('delete-modal').classList.remove('active');
            currentDeleteId = null;
            loadWebinaires();
        });

        // DÃ©connexion
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>