<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2D403B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Guide - OP! Parents</title>
    <meta name="description" content="Guide d'√©ducation financi√®re pour parents - OP! Parents">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/images/favicon.png" type="image/png">
    
    <style>
        :root {
            --vert-fonce: #2D403B;
            --vert-clair: #DFF2B6;
            --dore: #F0D075;
            --peche: #F5E1DA;
            --blanc: #FFFFFF;
            --gris-50: #F9FAFB;
            --gris-100: #F3F4F6;
            --gris-200: #E5E7EB;
            --gris-300: #D1D5DB;
            --gris-400: #9CA3AF;
            --gris-500: #6B7280;
            --gris-600: #4B5563;
            --gris-700: #374151;
            --gris-800: #1F2937;
            --corail: #BF604B;
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-serif: 'Playfair Display', Georgia, serif;
            
            --max-width: 640px;
            --header-height: 56px;
            --nav-height: 80px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-sans);
            background: var(--gris-50);
            color: var(--gris-800);
            line-height: 1.6;
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
        }
        
        /* ============================================
           LOADING
           ============================================ */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--vert-fonce);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; }
        .loading-logo {
            font-family: var(--font-serif);
            font-size: 3rem;
            font-weight: 700;
            color: var(--dore);
            margin-bottom: 1.5rem;
        }
        .loading-spinner {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: var(--dore);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ============================================
           HEADER + PROGRESS SEGMENTS
           ============================================ */
        .guide-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--blanc);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 8px 12px;
            border-bottom: 1px solid var(--gris-200);
        }
        
        /* Progress segments (style Instagram Stories) */
        .progress-segments {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }
        .progress-segment {
            flex: 1;
            height: 3px;
            background: var(--gris-200);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-segment-fill {
            height: 100%;
            background: var(--vert-fonce);
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-segment.completed .progress-segment-fill { width: 100%; }
        .progress-segment.current .progress-segment-fill { width: 50%; background: var(--dore); }
        
        .header-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-back {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--gris-600);
        }
        .header-back:active { background: var(--gris-100); }
        .header-back svg { width: 22px; height: 22px; }
        
        .header-title {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--gris-800);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-counter {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gris-500);
            white-space: nowrap;
        }
        
        /* ============================================
           HERO
           ============================================ */
        .guide-hero {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, var(--vert-fonce) 0%, var(--vert-fonce) 50%, var(--gris-50) 100%);
            z-index: 50;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }
        .guide-hero.hidden { display: none; }
        
        .hero-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1.5rem;
            text-align: center;
            max-width: var(--max-width);
            margin: 0 auto;
        }
        
        .hero-icon {
            width: 80px;
            height: 80px;
            background: var(--dore);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg);
        }
        
        .hero-category {
            display: inline-block;
            padding: 0.375rem 1rem;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--dore);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }
        
        .hero-title {
            font-family: var(--font-serif);
            font-size: clamp(1.75rem, 6vw, 2.25rem);
            font-weight: 700;
            color: var(--blanc);
            line-height: 1.2;
            margin-bottom: 0.75rem;
        }
        
        .hero-subtitle {
            font-size: 1rem;
            color: rgba(255,255,255,0.75);
            margin-bottom: 1.5rem;
            max-width: 400px;
        }
        
        .hero-meta {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 2rem;
        }
        .hero-meta span { color: var(--blanc); font-weight: 600; }
        
        .hero-image-container {
            width: 100%;
            max-width: 400px;
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        .hero-image-container img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        
        .hero-start-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 280px;
            padding: 1rem 2rem;
            background: var(--dore);
            color: var(--vert-fonce);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .hero-start-btn:active { transform: scale(0.98); }
        .hero-start-btn svg { width: 20px; height: 20px; }
        
        /* ============================================
           MAIN CONTENT - DIAPO MODE
           ============================================ */
        .guide-content {
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            bottom: var(--nav-height);
            display: none;
            overflow: hidden;
        }
        .guide-content.active { display: block; }
        
        .slides-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .slide {
            position: absolute;
            width: calc(100% - 2rem);
            max-width: var(--max-width);
            max-height: 100%;
            overflow-y: auto;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        .slide.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }
        .slide.prev {
            opacity: 0;
            transform: translateX(-100%);
        }
        
        /* Container pour plusieurs blocs dans une slide */
        .slide-blocks {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .slide-blocks > * {
            flex-shrink: 0;
        }
        
        /* ============================================
           NAVIGATION BOTTOM
           ============================================ */
        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: var(--blanc);
            border-top: 1px solid var(--gris-200);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 1rem;
            padding-bottom: env(safe-area-inset-bottom, 0);
            gap: 0.75rem;
            z-index: 100;
        }
        .nav-bottom.active { display: flex; }
        
        .nav-btn {
            height: 48px;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
        }
        .nav-btn svg { width: 20px; height: 20px; }
        
        .nav-btn-prev {
            width: 48px;
            background: var(--gris-100);
            color: var(--gris-600);
        }
        .nav-btn-prev:active { background: var(--gris-200); }
        .nav-btn-prev:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .nav-btn-next {
            flex: 1;
            max-width: 280px;
            background: var(--vert-fonce);
            color: var(--blanc);
            padding: 0 1.5rem;
        }
        .nav-btn-next:active { opacity: 0.9; }
        .nav-btn-next.golden {
            background: var(--dore);
            color: var(--vert-fonce);
        }
        
        /* Tap zones */
        .tap-zone {
            position: fixed;
            top: var(--header-height);
            bottom: var(--nav-height);
            width: 20%;
            z-index: 10;
        }
        .tap-zone-left { left: 0; }
        .tap-zone-right { right: 0; }
        
        /* ============================================
           BLOCK STYLES
           ============================================ */
        .block-section-title {
            padding: 2rem 0;
            text-align: center;
        }
        .section-title-text {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--vert-fonce);
            position: relative;
            display: inline-block;
        }
        .section-title-text::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 4px;
            background: var(--dore);
            border-radius: 2px;
        }
        
        .block-narrative {
            background: var(--blanc);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        .narrative-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 1rem;
        }
        .narrative-content {
            font-size: 1rem;
            color: var(--gris-700);
            line-height: 1.8;
        }
        .narrative-content p { margin-bottom: 1rem; }
        .narrative-content p:last-child { margin-bottom: 0; }
        .narrative-content .dialogue {
            font-style: italic;
            color: var(--corail);
            padding-left: 1rem;
            border-left: 3px solid var(--peche);
            margin: 1rem 0;
        }
        
        .block-info-box {
            background: linear-gradient(135deg, var(--vert-clair) 0%, rgba(223, 242, 182, 0.5) 100%);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            border-left: 4px solid var(--vert-fonce);
        }
        .block-info-box.style-warning {
            background: linear-gradient(135deg, #FEF3C7 0%, rgba(254, 243, 199, 0.5) 100%);
            border-left-color: #F59E0B;
        }
        .block-info-box.style-tip {
            background: linear-gradient(135deg, var(--peche) 0%, rgba(245, 225, 218, 0.5) 100%);
            border-left-color: var(--corail);
        }
        .info-box-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--vert-fonce);
            margin-bottom: 0.75rem;
        }
        .block-info-box.style-warning .info-box-title { color: #92400E; }
        .block-info-box.style-tip .info-box-title { color: var(--corail); }
        .info-box-content {
            font-size: 0.95rem;
            color: var(--gris-700);
            line-height: 1.7;
        }
        
        .block-stat {
            background: var(--vert-fonce);
            border-radius: var(--radius-xl);
            padding: 2rem 1.5rem;
            text-align: center;
        }
        .stat-text {
            font-size: 1.15rem;
            color: var(--blanc);
            line-height: 1.6;
        }
        .stat-source {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.5);
            margin-top: 1rem;
            font-style: italic;
        }
        
        /* Quiz & Poll */
        .block-quiz, .block-poll {
            background: var(--blanc);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        .block-quiz { border: 2px solid var(--dore); }
        .block-poll { border: 2px solid var(--gris-200); }
        
        .quiz-header, .poll-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .quiz-badge {
            padding: 0.25rem 0.75rem;
            background: var(--dore);
            color: var(--vert-fonce);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .poll-badge {
            padding: 0.25rem 0.75rem;
            background: var(--peche);
            color: var(--corail);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .quiz-question, .poll-question {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 1.25rem;
            line-height: 1.4;
        }
        .quiz-options, .poll-options {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }
        .quiz-option, .poll-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: var(--gris-50);
            border: 2px solid var(--gris-200);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .quiz-option:active, .poll-option:active {
            transform: scale(0.98);
        }
        .quiz-option.correct {
            border-color: #10B981;
            background: rgba(16, 185, 129, 0.1);
        }
        .quiz-option.incorrect {
            border-color: #EF4444;
            background: rgba(239, 68, 68, 0.1);
        }
        .quiz-option.disabled, .poll-option.disabled {
            cursor: default;
            opacity: 0.7;
        }
        .poll-option.selected {
            border-color: var(--vert-fonce);
            background: var(--vert-clair);
        }
        .quiz-option-letter {
            width: 28px;
            height: 28px;
            background: var(--gris-200);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--gris-600);
            flex-shrink: 0;
        }
        .quiz-option.correct .quiz-option-letter {
            background: #10B981;
            color: var(--blanc);
        }
        .quiz-option.incorrect .quiz-option-letter {
            background: #EF4444;
            color: var(--blanc);
        }
        .poll-option-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--gris-300);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .poll-option.selected .poll-option-checkbox {
            background: var(--vert-fonce);
            border-color: var(--vert-fonce);
        }
        .poll-option.selected .poll-option-checkbox::after {
            content: '‚úì';
            color: var(--blanc);
            font-size: 0.75rem;
            font-weight: 700;
        }
        .quiz-option-text, .poll-option-text {
            font-size: 0.95rem;
            color: var(--gris-700);
            flex: 1;
        }
        .quiz-explanation {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--vert-clair);
            border-radius: var(--radius-md);
            display: none;
        }
        .quiz-explanation.visible { display: block; }
        .quiz-explanation-title {
            font-weight: 700;
            color: var(--vert-fonce);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .quiz-explanation-text {
            font-size: 0.9rem;
            color: var(--gris-700);
            line-height: 1.6;
        }
        
        /* Poll results */
        .poll-results {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gris-200);
        }
        .poll-result-item { margin-bottom: 0.6rem; }
        .poll-result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }
        .poll-result-text { color: var(--gris-700); }
        .poll-result-percent { font-weight: 700; color: var(--vert-fonce); }
        .poll-result-bar {
            height: 6px;
            background: var(--gris-200);
            border-radius: 3px;
            overflow: hidden;
        }
        .poll-result-fill {
            height: 100%;
            background: var(--vert-fonce);
            border-radius: 3px;
            transition: width 0.8s ease;
        }
        
        /* Focus */
        .block-focus {
            background: var(--blanc);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            border: 2px dashed var(--gris-300);
        }
        .focus-icon { font-size: 2rem; margin-bottom: 0.75rem; }
        .focus-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 0.75rem;
        }
        .focus-content {
            font-size: 0.95rem;
            color: var(--gris-600);
            line-height: 1.7;
        }
        
        /* Table */
        .block-table {
            background: var(--blanc);
            border-radius: var(--radius-xl);
            padding: 1.25rem;
            overflow-x: auto;
        }
        .table-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gris-800);
            margin-bottom: 1rem;
        }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .data-table th {
            background: var(--vert-fonce);
            color: var(--blanc);
            padding: 0.6rem 0.75rem;
            text-align: left;
            font-weight: 600;
        }
        .data-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--gris-200);
            color: var(--gris-700);
        }
        .data-table tr:nth-child(even) { background: var(--gris-50); }
        
        /* Exercise */
        .block-exercise {
            background: linear-gradient(135deg, var(--dore) 0%, #E5C35A 100%);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
        }
        .exercise-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--vert-fonce);
            margin-bottom: 0.5rem;
        }
        .exercise-instructions {
            font-size: 0.9rem;
            color: var(--gris-700);
            margin-bottom: 1rem;
            font-style: italic;
        }
        .exercise-field {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.75rem;
            background: var(--blanc);
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .exercise-field-label { color: var(--gris-700); flex: 1; }
        .exercise-field-input {
            border: none;
            border-bottom: 2px dashed var(--gris-300);
            background: transparent;
            width: 80px;
            padding: 0.25rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--vert-fonce);
            text-align: center;
        }
        .exercise-field-input:focus { outline: none; border-bottom-color: var(--vert-fonce); }
        
        /* Summary */
        .block-summary {
            background: var(--blanc);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            border: 2px solid var(--vert-fonce);
        }
        .summary-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .summary-icon {
            width: 36px;
            height: 36px;
            background: var(--vert-clair);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .summary-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--vert-fonce);
        }
        .summary-list { list-style: none; }
        .summary-list li {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--gris-100);
            font-size: 0.9rem;
            color: var(--gris-700);
        }
        .summary-list li:last-child { border-bottom: none; }
        .summary-list li::before {
            content: '‚úì';
            color: var(--vert-fonce);
            font-weight: 700;
            flex-shrink: 0;
        }
        
        /* CTA */
        .block-cta {
            background: linear-gradient(135deg, var(--vert-fonce) 0%, #1F2E29 100%);
            border-radius: var(--radius-xl);
            padding: 2rem 1.5rem;
            text-align: center;
        }
        .cta-title {
            font-family: var(--font-serif);
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--blanc);
            margin-bottom: 0.75rem;
        }
        .cta-text {
            font-size: 0.95rem;
            color: rgba(255,255,255,0.8);
            margin-bottom: 1.25rem;
        }
        .cta-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            background: var(--dore);
            color: var(--vert-fonce);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 700;
            text-decoration: none;
        }
        
        /* Image */
        .block-image {
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .block-image img { width: 100%; display: block; }
        .block-image figcaption {
            padding: 0.6rem 1rem;
            background: var(--blanc);
            font-size: 0.8rem;
            color: var(--gris-500);
            text-align: center;
        }
        
        /* ============================================
           COMPLETION
           ============================================ */
        .completion-screen {
            position: fixed;
            inset: 0;
            background: var(--vert-fonce);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }
        .completion-screen.visible { opacity: 1; visibility: visible; }
        .completion-content { text-align: center; max-width: 360px; }
        .completion-confetti { font-size: 3.5rem; margin-bottom: 1rem; }
        .completion-title {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--blanc);
            margin-bottom: 0.75rem;
        }
        .completion-text {
            font-size: 1rem;
            color: rgba(255,255,255,0.8);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        .completion-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }
        .completion-stat { text-align: center; }
        .completion-stat-value { font-size: 1.75rem; font-weight: 700; color: var(--dore); }
        .completion-stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.6); }
        .completion-actions { display: flex; flex-direction: column; gap: 0.75rem; }
        .completion-btn {
            padding: 0.875rem 1.5rem;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            border: none;
            text-align: center;
        }
        .completion-btn.primary { background: var(--dore); color: var(--vert-fonce); }
        .completion-btn.secondary {
            background: transparent;
            color: var(--blanc);
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        /* ============================================
           ERROR
           ============================================ */
        .error-screen {
            position: fixed;
            inset: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            background: var(--gris-50);
        }
        .error-screen.visible { display: flex; }
        .error-icon { font-size: 3.5rem; margin-bottom: 1rem; }
        .error-title { font-size: 1.35rem; font-weight: 700; color: var(--gris-800); margin-bottom: 0.5rem; }
        .error-text { color: var(--gris-600); margin-bottom: 1.5rem; }
        .error-btn {
            padding: 0.875rem 1.5rem;
            background: var(--vert-fonce);
            color: var(--blanc);
            border-radius: var(--radius-lg);
            text-decoration: none;
            font-weight: 600;
        }
        
        /* Preview badge */
        .preview-badge {
            position: fixed;
            top: calc(var(--header-height) + 8px);
            right: 8px;
            background: var(--corail);
            color: white;
            padding: 0.35rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 150;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-logo">OP!</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="guide-header" id="guide-header" style="display: none;">
        <div class="progress-segments" id="progress-segments"></div>
        <div class="header-row">
            <button class="header-back" onclick="exitGuide()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="header-title" id="header-title">Guide</div>
            <div class="header-counter" id="header-counter">1/1</div>
        </div>
    </header>

    <!-- Hero -->
    <section class="guide-hero" id="guide-hero">
        <div class="hero-content">
            <div class="hero-icon" id="hero-icon">üí∞</div>
            <span class="hero-category" id="hero-category">Budget</span>
            <h1 class="hero-title" id="hero-title">Titre du guide</h1>
            <p class="hero-subtitle" id="hero-subtitle"></p>
            <div class="hero-meta">
                <span>‚è±Ô∏è <span id="hero-duration">10 min</span></span>
                <span>üìñ <span id="hero-blocks">0</span> slides</span>
            </div>
            <div class="hero-image-container" id="hero-card" style="display: none;">
                <img id="hero-image" src="" alt="">
            </div>
            <button class="hero-start-btn" onclick="startGuide()">
                C'est parti
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
            </button>
        </div>
    </section>

    <!-- Main Content -->
    <main class="guide-content" id="guide-content">
        <div class="tap-zone tap-zone-left" onclick="prevSlide()"></div>
        <div class="tap-zone tap-zone-right" onclick="nextSlide()"></div>
        <div class="slides-container" id="slides-container"></div>
    </main>

    <!-- Navigation -->
    <nav class="nav-bottom" id="nav-bottom">
        <button class="nav-btn nav-btn-prev" id="btn-prev" onclick="prevSlide()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <button class="nav-btn nav-btn-next" id="btn-next" onclick="nextSlide()">
            Suivant
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
        </button>
    </nav>

    <!-- Error -->
    <div class="error-screen" id="error-screen">
        <div class="error-icon">üòï</div>
        <h1 class="error-title">Guide introuvable</h1>
        <p class="error-text">Ce guide n'existe pas ou n'est pas publi√©.</p>
        <a href="formations.html" class="error-btn">‚Üê Retour aux guides</a>
    </div>

    <!-- Completion -->
    <div class="completion-screen" id="completion-screen">
        <div class="completion-content">
            <div class="completion-confetti">üéâ</div>
            <h2 class="completion-title">Bravo !</h2>
            <p class="completion-text" id="completion-text">Tu as termin√© ce guide !</p>
            <div class="completion-stats">
                <div class="completion-stat">
                    <div class="completion-stat-value" id="stat-blocks">0</div>
                    <div class="completion-stat-label">slides</div>
                </div>
                <div class="completion-stat">
                    <div class="completion-stat-value" id="stat-quiz">0/0</div>
                    <div class="completion-stat-label">quiz r√©ussis</div>
                </div>
            </div>
            <div class="completion-actions">
                <a href="formations.html" class="completion-btn primary">D√©couvrir d'autres guides</a>
                <button class="completion-btn secondary" onclick="shareGuide()">Partager</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    
    <script>
        // ============================================
        // STATE
        // ============================================
        let guideData = null;
        let blocks = [];
        let slides = []; // Groupes de blocs par slide
        let currentSlide = 0;
        let quizCorrectCount = 0;
        let quizTotalCount = 0;
        let isPreviewMode = false;
        
        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            initSupabase();
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');
            isPreviewMode = params.get('preview') === 'true';
            if (!slug) { showError(); return; }
            await loadGuide(slug);
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
            if (e.key === 'ArrowLeft') prevSlide();
        });
        
        // Swipe support
        let touchStartX = 0;
        document.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; });
        document.addEventListener('touchend', (e) => {
            const diff = touchStartX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) nextSlide();
                else prevSlide();
            }
        });
        
        // ============================================
        // LOAD GUIDE
        // ============================================
        async function loadGuide(slug) {
            try {
                let query = supabaseClient.from('quizzes').select('*').eq('slug', slug);
                if (!isPreviewMode) query = query.eq('published', true);
                const { data: guide, error } = await query.single();
                
                if (error || !guide) { showError(); return; }
                
                guideData = guide;
                blocks = guide.blocks || [];
                quizTotalCount = blocks.filter(b => b.type === 'quiz').length;
                
                // Grouper les blocs en slides bas√© sur les page-break
                slides = groupBlocksIntoSlides(blocks);
                
                if (!isPreviewMode) {
                    supabaseClient.from('quizzes').update({ view_count: (guide.view_count || 0) + 1 }).eq('id', guide.id);
                }
                
                document.title = `${guide.titre} - OP! Parents`;
                renderHero(guide);
                renderSlides();
                renderProgressSegments();
                
                if (isPreviewMode) showPreviewBadge();
                
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 400);
            } catch (error) {
                console.error('Erreur:', error);
                showError();
            }
        }
        
        // Grouper les blocs en slides (s√©par√©s par page-break)
        function groupBlocksIntoSlides(allBlocks) {
            // V√©rifier s'il y a au moins un page-break
            const hasPageBreaks = allBlocks.some(b => b.type === 'page-break');
            
            // Si pas de page-break, chaque bloc = 1 slide (comportement par d√©faut)
            if (!hasPageBreaks) {
                return allBlocks.map(b => [b]);
            }
            
            // Sinon, grouper par page-break
            const result = [];
            let currentGroup = [];
            
            for (const block of allBlocks) {
                if (block.type === 'page-break') {
                    // Si on a des blocs dans le groupe courant, on les ajoute comme slide
                    if (currentGroup.length > 0) {
                        result.push(currentGroup);
                        currentGroup = [];
                    }
                    // On ignore le page-break lui-m√™me, il ne s'affiche pas
                } else {
                    currentGroup.push(block);
                }
            }
            
            // Ajouter le dernier groupe s'il reste des blocs
            if (currentGroup.length > 0) {
                result.push(currentGroup);
            }
            
            return result;
        }
        
        // ============================================
        // RENDER HERO
        // ============================================
        function renderHero(guide) {
            document.getElementById('header-title').textContent = guide.titre;
            document.getElementById('hero-icon').textContent = guide.icon || 'üìñ';
            document.getElementById('hero-title').textContent = guide.titre;
            document.getElementById('hero-subtitle').textContent = guide.sous_titre || '';
            document.getElementById('hero-duration').textContent = guide.duree || '10 min';
            document.getElementById('hero-blocks').textContent = slides.length;
            
            const categories = { 'budget': 'üí∞ Budget', 'epargne': 'üõ°Ô∏è √âpargne', 'investissement': 'üìà Investissement', 'mindset': 'üß† Mindset', 'famille': 'üë®‚Äçüë©‚Äçüëß Famille' };
            document.getElementById('hero-category').textContent = categories[guide.category] || 'üìñ Guide';
            
            if (guide.image_url) {
                document.getElementById('hero-image').src = guide.image_url;
                document.getElementById('hero-card').style.display = 'block';
            }
        }
        
        // ============================================
        // RENDER PROGRESS SEGMENTS
        // ============================================
        function renderProgressSegments() {
            const container = document.getElementById('progress-segments');
            container.innerHTML = slides.map((_, i) => `
                <div class="progress-segment" data-index="${i}">
                    <div class="progress-segment-fill"></div>
                </div>
            `).join('');
        }
        
        function updateProgressSegments() {
            document.querySelectorAll('.progress-segment').forEach((seg, i) => {
                seg.classList.remove('completed', 'current');
                if (i < currentSlide) seg.classList.add('completed');
                else if (i === currentSlide) seg.classList.add('current');
            });
            document.getElementById('header-counter').textContent = `${currentSlide + 1}/${slides.length}`;
        }
        
        // ============================================
        // RENDER SLIDES
        // ============================================
        function renderSlides() {
            const container = document.getElementById('slides-container');
            container.innerHTML = slides.map((slideBlocks, slideIndex) => `
                <div class="slide" data-index="${slideIndex}">
                    <div class="slide-blocks">
                        ${slideBlocks.map((block, blockIndex) => renderBlock(block, blockIndex)).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function renderBlock(block, index) {
            const data = block.data || {};
            switch (block.type) {
                case 'section-title':
                    return `<div class="block-section-title"><h2 class="section-title-text">${esc(data.title || '')}</h2></div>`;
                case 'narrative':
                    return `<div class="block-narrative">${data.title ? `<div class="narrative-title">${esc(data.title)}</div>` : ''}<div class="narrative-content">${formatNarrative(data.content || '')}</div></div>`;
                case 'info-box':
                    return `<div class="block-info-box style-${data.style || 'default'}">${data.title ? `<div class="info-box-title">${infoIcon(data.style)} ${esc(data.title)}</div>` : ''}<div class="info-box-content">${fmt(data.content || '')}</div></div>`;
                case 'stat':
                    return `<div class="block-stat"><div class="stat-text">${esc(data.stat || '')}</div>${data.source ? `<div class="stat-source">‚Äî ${esc(data.source)}</div>` : ''}</div>`;
                case 'poll':
                    return renderPoll(data, index);
                case 'quiz':
                    return renderQuiz(data, index);
                case 'focus':
                    return `<div class="block-focus"><div class="focus-icon">üîç</div>${data.title ? `<div class="focus-title">${esc(data.title)}</div>` : ''}<div class="focus-content">${fmt(data.content || '')}</div></div>`;
                case 'table':
                    return renderTable(data);
                case 'exercise':
                    return renderExercise(data);
                case 'summary':
                    return `<div class="block-summary"><div class="summary-header"><div class="summary-icon">üìù</div><div class="summary-title">${esc(data.title || '√Ä retenir')}</div></div><ul class="summary-list">${(data.content || '').split('\n').filter(l => l.trim()).map(l => `<li>${esc(l.replace(/^[‚Ä¢\-\*]\s*/, ''))}</li>`).join('')}</ul></div>`;
                case 'cta':
                    return `<div class="block-cta"><h3 class="cta-title">${esc(data.title || 'Passez √† l\'action')}</h3><p class="cta-text">${esc(data.content || '')}</p><a href="${data.link || 'contact.html'}" class="cta-button">${esc(data.buttonText || 'Je me lance')} ‚Üí</a></div>`;
                case 'image':
                    return `<figure class="block-image"><img src="${esc(data.url || '')}" alt="${esc(data.alt || '')}">${data.caption ? `<figcaption>${esc(data.caption)}</figcaption>` : ''}</figure>`;
                default:
                    return `<div class="block-narrative"><p>Bloc non reconnu</p></div>`;
            }
        }
        
        function renderPoll(data, index) {
            const options = data.options || [];
            return `<div class="block-poll" data-answered="false"><div class="poll-header"><span class="poll-badge">üó≥Ô∏è Sondage</span></div><div class="poll-question">${esc(data.question || '')}</div><div class="poll-options">${options.map((o, i) => `<div class="poll-option" onclick="selectPoll(this)"><div class="poll-option-checkbox"></div><span class="poll-option-text">${esc(o.text || '')}</span></div>`).join('')}</div></div>`;
        }
        
        function renderQuiz(data, index) {
            const options = data.options || [];
            return `<div class="block-quiz" data-answered="false"><div class="quiz-header"><span class="quiz-badge">‚ùì Quiz</span></div><div class="quiz-question">${esc(data.question || '')}</div><div class="quiz-options">${options.map((o, i) => `<div class="quiz-option" data-correct="${o.correct ? 'true' : 'false'}" onclick="selectQuiz(this)"><span class="quiz-option-letter">${String.fromCharCode(65 + i)}</span><span class="quiz-option-text">${esc(o.text || '')}</span></div>`).join('')}</div>${data.explanation ? `<div class="quiz-explanation"><div class="quiz-explanation-title">üí° Explication</div><div class="quiz-explanation-text">${fmt(data.explanation)}</div></div>` : ''}</div>`;
        }
        
        function renderTable(data) {
            const rows = (data.data || '').split('\n').filter(r => r.trim());
            if (!rows.length) return '';
            const headers = rows[0].split('|').map(h => h.trim());
            const body = rows.slice(1);
            return `<div class="block-table">${data.title ? `<div class="table-title">${esc(data.title)}</div>` : ''}<table class="data-table"><thead><tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr></thead><tbody>${body.map(r => `<tr>${r.split('|').map(c => `<td>${esc(c.trim())}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
        }
        
        function renderExercise(data) {
            const fields = (data.fields || '').split('\n').filter(f => f.trim());
            return `<div class="block-exercise"><div class="exercise-title">${esc(data.title || '‚úçÔ∏è Exercice')}</div>${data.instructions ? `<div class="exercise-instructions">${esc(data.instructions)}</div>` : ''}<div class="exercise-fields">${fields.map(f => `<div class="exercise-field"><span class="exercise-field-label">${esc(f.split(':')[0].trim())}</span><input type="text" class="exercise-field-input" placeholder="..."></div>`).join('')}</div></div>`;
        }
        
        // ============================================
        // NAVIGATION
        // ============================================
        function startGuide() {
            document.getElementById('guide-hero').classList.add('hidden');
            document.getElementById('guide-header').style.display = 'flex';
            document.getElementById('guide-content').classList.add('active');
            document.getElementById('nav-bottom').classList.add('active');
            currentSlide = 0;
            showSlide(0);
        }
        
        function exitGuide() {
            if (confirm('Quitter ce guide ?')) {
                history.back();
            }
        }
        
        function showSlide(index) {
            const slides = document.querySelectorAll('.slide');
            slides.forEach((slide, i) => {
                slide.classList.remove('active', 'prev');
                if (i === index) slide.classList.add('active');
                else if (i < index) slide.classList.add('prev');
            });
            
            currentSlide = index;
            updateProgressSegments();
            updateNavButtons();
        }
        
        function prevSlide() {
            if (currentSlide > 0) showSlide(currentSlide - 1);
        }
        
        function nextSlide() {
            if (currentSlide < slides.length - 1) {
                showSlide(currentSlide + 1);
            } else {
                showCompletion();
            }
        }
        
        function updateNavButtons() {
            const prevBtn = document.getElementById('btn-prev');
            const nextBtn = document.getElementById('btn-next');
            
            prevBtn.disabled = currentSlide === 0;
            
            if (currentSlide === slides.length - 1) {
                nextBtn.innerHTML = `Terminer <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                nextBtn.classList.add('golden');
            } else {
                nextBtn.innerHTML = `Suivant <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>`;
                nextBtn.classList.remove('golden');
            }
        }
        
        // ============================================
        // QUIZ & POLL INTERACTION
        // ============================================
        function selectQuiz(el) {
            const quiz = el.closest('.block-quiz');
            if (quiz.dataset.answered === 'true') return;
            quiz.dataset.answered = 'true';
            
            const isCorrect = el.dataset.correct === 'true';
            quiz.querySelectorAll('.quiz-option').forEach(o => o.classList.add('disabled'));
            
            if (isCorrect) {
                el.classList.add('correct');
                el.querySelector('.quiz-option-letter').textContent = '‚úì';
                quizCorrectCount++;
            } else {
                el.classList.add('incorrect');
                el.querySelector('.quiz-option-letter').textContent = '‚úó';
                const correct = quiz.querySelector('[data-correct="true"]');
                if (correct) {
                    correct.classList.add('correct');
                    correct.querySelector('.quiz-option-letter').textContent = '‚úì';
                }
            }
            
            const expl = quiz.querySelector('.quiz-explanation');
            if (expl) setTimeout(() => expl.classList.add('visible'), 300);
        }
        
        function selectPoll(el) {
            const poll = el.closest('.block-poll');
            if (poll.dataset.answered === 'true') return;
            poll.dataset.answered = 'true';
            
            poll.querySelectorAll('.poll-option').forEach(o => o.classList.add('disabled'));
            el.classList.add('selected');
            
            // Show fake results
            setTimeout(() => {
                const options = poll.querySelectorAll('.poll-option');
                const results = fakePollResults(options.length);
                let html = '<div class="poll-results">';
                options.forEach((o, i) => {
                    const text = o.querySelector('.poll-option-text').textContent;
                    html += `<div class="poll-result-item"><div class="poll-result-header"><span class="poll-result-text">${esc(text)}</span><span class="poll-result-percent">${results[i]}%</span></div><div class="poll-result-bar"><div class="poll-result-fill" style="width:0%"></div></div></div>`;
                });
                html += '</div>';
                poll.insertAdjacentHTML('beforeend', html);
                
                setTimeout(() => {
                    poll.querySelectorAll('.poll-result-fill').forEach((f, i) => f.style.width = results[i] + '%');
                }, 50);
            }, 300);
        }
        
        function fakePollResults(n) {
            const r = [];
            let rem = 100;
            for (let i = 0; i < n - 1; i++) {
                const v = Math.floor(Math.random() * (rem - (n - i) * 5)) + 5;
                r.push(v);
                rem -= v;
            }
            r.push(rem);
            return r;
        }
        
        // ============================================
        // COMPLETION
        // ============================================
        function showCompletion() {
            document.getElementById('stat-blocks').textContent = slides.length;
            document.getElementById('stat-quiz').textContent = `${quizCorrectCount}/${quizTotalCount}`;
            document.getElementById('completion-screen').classList.add('visible');
        }
        
        // ============================================
        // HELPERS
        // ============================================
        function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function fmt(t) { return esc(t).replace(/\n/g, '<br>'); }
        function formatNarrative(t) { return t.split('\n').filter(p => p.trim()).map(p => p.startsWith('¬´') || p.startsWith('"') ? `<p class="dialogue">${esc(p)}</p>` : `<p>${esc(p)}</p>`).join(''); }
        function infoIcon(s) { return s === 'warning' ? '‚ö†Ô∏è' : s === 'tip' ? 'üí°' : 'üìã'; }
        
        function showError() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('error-screen').classList.add('visible');
        }
        
        function showPreviewBadge() {
            const b = document.createElement('div');
            b.className = 'preview-badge';
            b.textContent = 'üëÅÔ∏è Preview';
            document.body.appendChild(b);
        }
        
        function shareGuide() {
            if (navigator.share && guideData) {
                navigator.share({ title: guideData.titre, text: guideData.sous_titre || 'D√©couvre ce guide !', url: window.location.href });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Lien copi√© !');
            }
        }
    </script>
</body>
</html>