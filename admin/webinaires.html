<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webinaires - Admin OP!</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="../assets/css/admin-quiz.css">
    <style>
        /* Styles suppl√©mentaires pour le formulaire enrichi */
        .form-section {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
        }
        
        .form-section h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--vert-fonce);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .section-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--space-md);
        }
        
        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
        }
        
        /* Attendus / Points cl√©s */
        .attendu-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
            background: var(--white);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
        }
        
        .attendu-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .attendu-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
        }
        
        .attendu-input:focus {
            outline: none;
            border-color: var(--vert-fonce);
        }
        
        .btn-remove-attendu {
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .btn-remove-attendu:hover {
            opacity: 1;
        }
        
        /* Image upload */
        .image-upload-container {
            display: flex;
            gap: var(--space-lg);
            align-items: flex-start;
        }
        
        .image-preview {
            width: 200px;
            height: 120px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-xs);
            color: var(--gray-400);
        }
        
        .placeholder-icon {
            font-size: 2rem;
        }
        
        .placeholder-text {
            font-size: 0.85rem;
        }
        
        .image-upload-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .upload-progress {
            margin-top: var(--space-sm);
        }
        
        .progress-bar {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--vert-fonce);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Intervenant section */
        .speaker-preview {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--gray-200);
            margin-bottom: var(--space-md);
        }
        
        .speaker-preview-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--vert-clair) 0%, var(--peche) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .speaker-preview-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .speaker-preview-info {
            flex: 1;
        }
        
        .speaker-preview-name {
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .speaker-preview-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .speaker-preview-empty {
            color: var(--gray-400);
            font-style: italic;
        }
        
        /* Upload photo intervenant */
        .speaker-upload-container {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
        }
        
        .speaker-upload-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gray-100);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 3px solid var(--gray-200);
        }
        
        .speaker-upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .speaker-upload-placeholder {
            font-size: 2rem;
            color: var(--gray-400);
        }
        
        .speaker-upload-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }
        
        /* Liens conditionnels */
        .conditional-field {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .conditional-field.visible {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Textarea plus grand */
        .textarea-large {
            min-height: 150px;
        }
        
        /* Info box */
        .info-box {
            background: linear-gradient(135deg, var(--vert-clair) 0%, rgba(223, 242, 182, 0.5) 100%);
            border-left: 4px solid var(--vert-fonce);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
        }
        
        .info-box p {
            font-size: 0.9rem;
            color: var(--vert-fonce);
            margin: 0;
        }
        
        /* Tabs pour liens */
        .links-tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        
        .link-tab {
            padding: var(--space-sm) var(--space-md);
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .link-tab:hover {
            border-color: var(--vert-fonce);
        }
        
        .link-tab.active {
            background: var(--vert-fonce);
            border-color: var(--vert-fonce);
            color: var(--white);
        }
    </style>
</head>
<body class="admin-body">
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <img src="../assets/images/logo.png" alt="OP!" class="sidebar-logo">
                <span>Admin OP!</span>
            </div>
            
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    Dashboard
                </a>
                <a href="webinaires.html" class="nav-item active">
                    <span class="nav-icon">üé•</span>
                    Webinaires
                </a>
                <a href="quizzes.html" class="nav-item">
                    <span class="nav-icon">üß†</span>
                    Quiz
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <a href="../index.html" class="nav-item">
                    <span class="nav-icon">üåê</span>
                    Voir le site
                </a>
                <button id="logout-btn" class="nav-item logout-btn">
                    <span class="nav-icon">üö™</span>
                    D√©connexion
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1>Webinaires</h1>
                <button class="btn btn-primary" id="new-webinaire-btn">
                    ‚ûï Nouveau webinaire
                </button>
            </header>

            <div class="admin-content">
                <!-- Liste des webinaires -->
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Titre</th>
                                <th>Intervenant</th>
                                <th>Date</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="webinaires-list">
                            <tr>
                                <td colspan="5" class="loading">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Formulaire -->
    <div class="modal" id="webinaire-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modal-title">Nouveau webinaire</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            
            <form id="webinaire-form" class="admin-form">
                <input type="hidden" id="webinaire-id">
                
                <!-- ============================================
                     SECTION 1 : INFORMATIONS G√âN√âRALES
                     ============================================ -->
                <div class="form-section">
                    <h3>üìù Informations g√©n√©rales</h3>
                    
                    <div class="form-group">
                        <label for="titre">Titre du webinaire *</label>
                        <input type="text" id="titre" name="titre" required placeholder="Ex: Comment parler d'argent avec ses enfants ?">
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description courte</label>
                        <textarea id="description" name="description" rows="3" placeholder="R√©sum√© en 1-2 phrases pour la liste des webinaires..."></textarea>
                        <small class="form-hint">Affich√©e sur la carte du webinaire dans la liste</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="description_longue">Description d√©taill√©e</label>
                        <textarea id="description_longue" name="description_longue" rows="6" class="textarea-large" placeholder="Description compl√®te du webinaire : contexte, objectifs, ce qui sera abord√©..."></textarea>
                        <small class="form-hint">Affich√©e sur la page d√©tail du webinaire</small>
                    </div>
                </div>
                
                <!-- ============================================
                     SECTION 2 : DATE ET STATUT
                     ============================================ -->
                <div class="form-section">
                    <h3>üìÖ Date et statut</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date_heure">Date et heure *</label>
                            <input type="datetime-local" id="date_heure" name="date_heure" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="statut">Statut</label>
                            <select id="statut" name="statut">
                                <option value="a_venir">üìÖ √Ä venir</option>
                                <option value="replay">‚ñ∂Ô∏è Replay disponible</option>
                                <option value="termine">‚úÖ Termin√© (sans replay)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ============================================
                     SECTION 3 : INTERVENANT
                     ============================================ -->
                <div class="form-section">
                    <h3>üë§ Intervenant</h3>
                    <p class="section-desc">Informations sur la personne qui anime le webinaire.</p>
                    
                    <!-- Pr√©visualisation -->
                    <div class="speaker-preview" id="speaker-preview">
                        <div class="speaker-preview-avatar" id="speaker-preview-avatar">
                            üë§
                        </div>
                        <div class="speaker-preview-info">
                            <div class="speaker-preview-name" id="speaker-preview-name">Nom de l'intervenant</div>
                            <div class="speaker-preview-title" id="speaker-preview-title">Titre / Fonction</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="speaker_name">Nom de l'intervenant</label>
                            <input type="text" id="speaker_name" name="speaker_name" placeholder="Ex: Florent Cavaill√®s">
                        </div>
                        
                        <div class="form-group">
                            <label for="speaker_title">Titre / Fonction</label>
                            <input type="text" id="speaker_title" name="speaker_title" placeholder="Ex: Ing√©nieur Patrimonial">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="speaker_bio">Biographie courte</label>
                        <textarea id="speaker_bio" name="speaker_bio" rows="3" placeholder="Quelques lignes sur l'expertise et le parcours de l'intervenant..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Photo de l'intervenant</label>
                        <div class="speaker-upload-container">
                            <div class="speaker-upload-preview" id="speaker-upload-preview">
                                <img id="speaker-preview-img" src="" alt="Photo intervenant" style="display: none;">
                                <div class="speaker-upload-placeholder" id="speaker-upload-placeholder">
                                    <span>üë§</span>
                                </div>
                            </div>
                            
                            <div class="speaker-upload-actions">
                                <input type="file" id="speaker-file" accept="image/*" style="display: none;">
                                <input type="hidden" id="speaker_avatar" name="speaker_avatar">
                                
                                <button type="button" class="btn btn-secondary btn-sm" id="btn-upload-speaker">
                                    üìÅ Choisir une photo
                                </button>
                                <button type="button" class="btn btn-outline btn-sm" id="btn-remove-speaker" style="display: none;">
                                    üóëÔ∏è Supprimer
                                </button>
                                
                                <div class="upload-progress" id="speaker-upload-progress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="speaker-upload-fill"></div>
                                    </div>
                                    <span class="progress-text">Upload en cours...</span>
                                </div>
                                
                                <small class="form-hint">Photo carr√©e recommand√©e (JPG, PNG)</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ============================================
                     SECTION 4 : POINTS CL√âS
                     ============================================ -->
                <div class="form-section">
                    <h3>üéØ Ce que les participants vont apprendre</h3>
                    <p class="section-desc">Listez les points cl√©s que les participants retiendront de ce webinaire.</p>
                    
                    <div class="attendus-container" id="attendus-container">
                        <!-- Les attendus seront ajout√©s ici dynamiquement -->
                    </div>
                    
                    <button type="button" class="btn btn-secondary btn-sm" id="btn-add-attendu">
                        + Ajouter un point cl√©
                    </button>
                </div>
                
                <!-- ============================================
                     SECTION 5 : LIENS
                     ============================================ -->
                <div class="form-section">
                    <h3>üîó Liens</h3>
                    
                    <div class="info-box">
                        <p>üí° <strong>Conseil :</strong> Remplissez les liens selon le statut du webinaire. Le lien d'inscription pour les webinaires √† venir, le lien replay pour les replays disponibles.</p>
                    </div>
                    
                    <!-- Lien d'inscription (pour webinaires √† venir) -->
                    <div class="form-group conditional-field" id="field-inscription">
                        <label for="lien_inscription">üé´ Lien d'inscription</label>
                        <input type="url" id="lien_inscription" name="lien_inscription" placeholder="https://calendly.com/... ou https://forms.google.com/...">
                        <small class="form-hint">Lien vers le formulaire d'inscription (Calendly, Google Forms, etc.)</small>
                    </div>
                    
                    <!-- Lien replay (pour replays) -->
                    <div class="form-group conditional-field" id="field-replay">
                        <label for="lien_replay">‚ñ∂Ô∏è Lien du replay</label>
                        <input type="url" id="lien_replay" name="lien_replay" placeholder="https://youtube.com/watch?v=... ou https://vimeo.com/...">
                        <small class="form-hint">YouTube, Vimeo, Loom ou lien direct vers la vid√©o</small>
                    </div>
                    
                    <!-- Lien Meet (toujours visible) -->
                    <div class="form-group">
                        <label for="lien_meet">üìπ Lien Google Meet / Zoom</label>
                        <input type="url" id="lien_meet" name="lien_meet" placeholder="https://meet.google.com/xxx-xxx-xxx">
                        <small class="form-hint">Lien de connexion pour le jour J (facultatif)</small>
                    </div>
                </div>
                
                <!-- ============================================
                     SECTION 6 : IMAGE DE COUVERTURE
                     ============================================ -->
                <div class="form-section">
                    <h3>üñºÔ∏è Image de couverture</h3>
                    
                    <div class="image-upload-container">
                        <div class="image-preview" id="image-preview">
                            <img id="preview-img" src="" alt="Pr√©visualisation" style="display: none;">
                            <div class="image-placeholder" id="image-placeholder">
                                <span class="placeholder-icon">üì∑</span>
                                <span class="placeholder-text">Aucune image</span>
                            </div>
                        </div>
                        
                        <div class="image-upload-actions">
                            <input type="file" id="image-file" accept="image/*" style="display: none;">
                            <input type="hidden" id="image_url" name="image_url">
                            
                            <button type="button" class="btn btn-secondary" id="btn-upload-image">
                                üìÅ Choisir une image
                            </button>
                            <button type="button" class="btn btn-outline btn-sm" id="btn-remove-image" style="display: none;">
                                üóëÔ∏è Supprimer
                            </button>
                            
                            <div class="upload-progress" id="upload-progress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="upload-progress-fill"></div>
                                </div>
                                <span class="progress-text">Upload en cours...</span>
                            </div>
                            
                            <small class="form-hint">Formats accept√©s : JPG, PNG, GIF, WebP (max 5 Mo)</small>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-btn">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Enregistrer</span>
                        <span class="btn-loader" style="display: none;">Enregistrement...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Confirmation Suppression -->
    <div class="modal" id="delete-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Confirmer la suppression</h2>
                <button class="modal-close" id="delete-modal-close">&times;</button>
            </div>
            <p>√ätes-vous s√ªr de vouloir supprimer ce webinaire ?</p>
            <div class="form-actions">
                <button class="btn btn-secondary" id="delete-cancel">Annuler</button>
                <button class="btn btn-danger" id="delete-confirm">Supprimer</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <script>
        // Initialiser Supabase
        const client = initSupabase();

        let currentDeleteId = null;
        let attendusCount = 0;

        // √âcouter les changements d'authentification
        client.auth.onAuthStateChange((event, session) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                loadWebinaires();
            }
        });

        // Charger les webinaires
        async function loadWebinaires() {
            const { data, error } = await supabaseClient
                .from('webinaires')
                .select('*')
                .order('date_heure', { ascending: false });

            if (error) {
                console.error('Erreur:', error);
                return;
            }

            displayWebinaires(data || []);
        }

        // Afficher les webinaires
        function displayWebinaires(webinaires) {
            const tbody = document.getElementById('webinaires-list');
            
            if (webinaires.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">Aucun webinaire. Cr√©ez-en un !</td></tr>';
                return;
            }

            tbody.innerHTML = webinaires.map(w => `
                <tr>
                    <td>
                        <strong>${w.titre}</strong>
                        ${w.description ? `<br><small>${w.description.substring(0, 50)}...</small>` : ''}
                    </td>
                    <td>${w.speaker_name || '-'}</td>
                    <td>${w.date_heure ? new Date(w.date_heure).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                    <td><span class="status-badge status-${w.statut}">${formatStatut(w.statut)}</span></td>
                    <td class="actions-cell">
                        <button class="btn-icon" onclick="editWebinaire('${w.id}')" title="Modifier">‚úèÔ∏è</button>
                        <a href="../webinaire-detail.html?id=${w.id}" class="btn-icon" target="_blank" title="Voir">üëÅÔ∏è</a>
                        <button class="btn-icon btn-danger" onclick="confirmDelete('${w.id}')" title="Supprimer">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Formater le statut
        function formatStatut(statut) {
            const labels = {
                'a_venir': 'üìÖ √Ä venir',
                'replay': '‚ñ∂Ô∏è Replay',
                'termine': '‚úÖ Termin√©'
            };
            return labels[statut] || statut;
        }

        // === GESTION DES CHAMPS CONDITIONNELS ===
        
        function updateConditionalFields() {
            const statut = document.getElementById('statut').value;
            const fieldInscription = document.getElementById('field-inscription');
            const fieldReplay = document.getElementById('field-replay');
            
            // Afficher/masquer selon le statut
            fieldInscription.classList.toggle('visible', statut === 'a_venir');
            fieldReplay.classList.toggle('visible', statut === 'replay');
        }
        
        // √âcouter le changement de statut
        document.getElementById('statut').addEventListener('change', updateConditionalFields);

        // === GESTION DES ATTENDUS (Points cl√©s) ===
        
        function addAttendu(value = '') {
            attendusCount++;
            const container = document.getElementById('attendus-container');
            const div = document.createElement('div');
            div.className = 'attendu-item';
            div.innerHTML = `
                <span class="attendu-icon">‚úÖ</span>
                <input type="text" class="attendu-input" placeholder="Ex: Comprendre les bases de l'√©ducation financi√®re" value="${value}">
                <button type="button" class="btn-icon btn-remove-attendu" onclick="removeAttendu(this)">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }
        
        function removeAttendu(btn) {
            btn.closest('.attendu-item').remove();
        }
        
        function getAttendus() {
            const inputs = document.querySelectorAll('.attendu-input');
            return Array.from(inputs)
                .map(input => input.value.trim())
                .filter(val => val !== '');
        }
        
        function setAttendus(attendus) {
            const container = document.getElementById('attendus-container');
            container.innerHTML = '';
            attendusCount = 0;
            
            if (attendus && attendus.length > 0) {
                attendus.forEach(att => addAttendu(att));
            } else {
                // Ajouter 2 champs vides par d√©faut
                addAttendu();
                addAttendu();
            }
        }
        
        // Bouton ajouter attendu
        document.getElementById('btn-add-attendu').addEventListener('click', () => addAttendu());

        // === PR√âVISUALISATION INTERVENANT ===
        
        function updateSpeakerPreview() {
            const name = document.getElementById('speaker_name').value || 'Nom de l\'intervenant';
            const title = document.getElementById('speaker_title').value || 'Titre / Fonction';
            const avatar = document.getElementById('speaker_avatar').value;
            
            document.getElementById('speaker-preview-name').textContent = name;
            document.getElementById('speaker-preview-title').textContent = title;
            
            const avatarEl = document.getElementById('speaker-preview-avatar');
            if (avatar) {
                avatarEl.innerHTML = `<img src="${avatar}" alt="${name}">`;
            } else {
                avatarEl.innerHTML = 'üë§';
            }
        }
        
        // √âcouter les changements sur les champs intervenant
        document.getElementById('speaker_name').addEventListener('input', updateSpeakerPreview);
        document.getElementById('speaker_title').addEventListener('input', updateSpeakerPreview);

        // === GESTION DE L'UPLOAD D'IMAGE ===
        
        let currentImageUrl = null;
        
        // Clic sur le bouton d'upload
        document.getElementById('btn-upload-image').addEventListener('click', () => {
            document.getElementById('image-file').click();
        });
        
        // S√©lection d'un fichier
        document.getElementById('image-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // V√©rifier la taille (max 5 Mo)
            if (file.size > 5 * 1024 * 1024) {
                alert('L\'image est trop lourde. Maximum 5 Mo.');
                return;
            }
            
            // V√©rifier le type
            if (!file.type.startsWith('image/')) {
                alert('Le fichier doit √™tre une image.');
                return;
            }
            
            // Afficher la pr√©visualisation locale
            const reader = new FileReader();
            reader.onload = (e) => {
                showImagePreview(e.target.result);
            };
            reader.readAsDataURL(file);
            
            // Upload vers Supabase Storage
            await uploadImage(file);
        });
        
        // Upload de l'image vers Supabase Storage
        async function uploadImage(file) {
            const progressEl = document.getElementById('upload-progress');
            const progressFill = document.getElementById('upload-progress-fill');
            
            progressEl.style.display = 'block';
            progressFill.style.width = '30%';
            
            try {
                // G√©n√©rer un nom unique
                const timestamp = Date.now();
                const ext = file.name.split('.').pop();
                const fileName = `webinaire-${timestamp}.${ext}`;
                
                progressFill.style.width = '50%';
                
                // Upload vers Supabase Storage
                const { data, error } = await supabaseClient.storage
                    .from('webinaires')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    console.error('Erreur upload:', error);
                    alert('Erreur lors de l\'upload: ' + error.message);
                    progressEl.style.display = 'none';
                    return;
                }
                
                progressFill.style.width = '80%';
                
                // R√©cup√©rer l'URL publique
                const { data: urlData } = supabaseClient.storage
                    .from('webinaires')
                    .getPublicUrl(fileName);
                
                currentImageUrl = urlData.publicUrl;
                document.getElementById('image_url').value = currentImageUrl;
                
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 500);
                
                console.log('Image upload√©e:', currentImageUrl);
                
            } catch (err) {
                console.error('Erreur:', err);
                alert('Erreur lors de l\'upload');
                progressEl.style.display = 'none';
            }
        }
        
        // Afficher la pr√©visualisation
        function showImagePreview(src) {
            const previewImg = document.getElementById('preview-img');
            const placeholder = document.getElementById('image-placeholder');
            const removeBtn = document.getElementById('btn-remove-image');
            
            previewImg.src = src;
            previewImg.style.display = 'block';
            placeholder.style.display = 'none';
            removeBtn.style.display = 'inline-flex';
        }
        
        // Masquer la pr√©visualisation
        function hideImagePreview() {
            const previewImg = document.getElementById('preview-img');
            const placeholder = document.getElementById('image-placeholder');
            const removeBtn = document.getElementById('btn-remove-image');
            
            previewImg.src = '';
            previewImg.style.display = 'none';
            placeholder.style.display = 'flex';
            removeBtn.style.display = 'none';
            
            document.getElementById('image_url').value = '';
            document.getElementById('image-file').value = '';
            currentImageUrl = null;
        }
        
        // Bouton supprimer image
        document.getElementById('btn-remove-image').addEventListener('click', hideImagePreview);

        // === GESTION DE L'UPLOAD PHOTO INTERVENANT ===
        
        let currentSpeakerUrl = null;
        
        // Clic sur le bouton d'upload speaker
        document.getElementById('btn-upload-speaker').addEventListener('click', () => {
            document.getElementById('speaker-file').click();
        });
        
        // S√©lection d'un fichier speaker
        document.getElementById('speaker-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // V√©rifier la taille (max 2 Mo pour une photo de profil)
            if (file.size > 2 * 1024 * 1024) {
                alert('L\'image est trop lourde. Maximum 2 Mo.');
                return;
            }
            
            // V√©rifier le type
            if (!file.type.startsWith('image/')) {
                alert('Le fichier doit √™tre une image.');
                return;
            }
            
            // Afficher la pr√©visualisation locale
            const reader = new FileReader();
            reader.onload = (e) => {
                showSpeakerPreview(e.target.result);
            };
            reader.readAsDataURL(file);
            
            // Upload vers Supabase Storage
            await uploadSpeakerImage(file);
        });
        
        // Upload de l'image speaker vers Supabase Storage
        async function uploadSpeakerImage(file) {
            const progressEl = document.getElementById('speaker-upload-progress');
            const progressFill = document.getElementById('speaker-upload-fill');
            
            progressEl.style.display = 'block';
            progressFill.style.width = '30%';
            
            try {
                // G√©n√©rer un nom unique
                const timestamp = Date.now();
                const ext = file.name.split('.').pop();
                const fileName = `speaker-${timestamp}.${ext}`;
                
                progressFill.style.width = '50%';
                
                // Upload vers Supabase Storage (bucket "speakers")
                const { data, error } = await supabaseClient.storage
                    .from('speakers')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    console.error('Erreur upload speaker:', error);
                    alert('Erreur lors de l\'upload: ' + error.message);
                    progressEl.style.display = 'none';
                    return;
                }
                
                progressFill.style.width = '80%';
                
                // R√©cup√©rer l'URL publique
                const { data: urlData } = supabaseClient.storage
                    .from('speakers')
                    .getPublicUrl(fileName);
                
                currentSpeakerUrl = urlData.publicUrl;
                document.getElementById('speaker_avatar').value = currentSpeakerUrl;
                
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 500);
                
                // Mettre √† jour la pr√©visualisation dans la section intervenant
                updateSpeakerPreview();
                
                console.log('Photo intervenant upload√©e:', currentSpeakerUrl);
                
            } catch (err) {
                console.error('Erreur:', err);
                alert('Erreur lors de l\'upload');
                progressEl.style.display = 'none';
            }
        }
        
        // Afficher la pr√©visualisation speaker
        function showSpeakerPreview(src) {
            const previewImg = document.getElementById('speaker-preview-img');
            const placeholder = document.getElementById('speaker-upload-placeholder');
            const removeBtn = document.getElementById('btn-remove-speaker');
            
            previewImg.src = src;
            previewImg.style.display = 'block';
            placeholder.style.display = 'none';
            removeBtn.style.display = 'inline-flex';
        }
        
        // Masquer la pr√©visualisation speaker
        function hideSpeakerPreview() {
            const previewImg = document.getElementById('speaker-preview-img');
            const placeholder = document.getElementById('speaker-upload-placeholder');
            const removeBtn = document.getElementById('btn-remove-speaker');
            
            previewImg.src = '';
            previewImg.style.display = 'none';
            placeholder.style.display = 'flex';
            removeBtn.style.display = 'none';
            
            document.getElementById('speaker_avatar').value = '';
            document.getElementById('speaker-file').value = '';
            currentSpeakerUrl = null;
            
            // Mettre √† jour la pr√©visualisation dans la section intervenant
            updateSpeakerPreview();
        }
        
        // Bouton supprimer photo speaker
        document.getElementById('btn-remove-speaker').addEventListener('click', hideSpeakerPreview);

        // Ouvrir le modal
        function openModal(title = 'Nouveau webinaire') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('webinaire-modal').classList.add('active');
            updateConditionalFields();
            updateSpeakerPreview();
        }

        // Fermer le modal
        function closeModal() {
            document.getElementById('webinaire-modal').classList.remove('active');
            document.getElementById('webinaire-form').reset();
            document.getElementById('webinaire-id').value = '';
            setAttendus(null);
            hideImagePreview();
            hideSpeakerPreview();
            updateSpeakerPreview();
        }

        // Nouveau webinaire
        document.getElementById('new-webinaire-btn').addEventListener('click', () => {
            setAttendus(null);
            hideImagePreview();
            hideSpeakerPreview();
            openModal('Nouveau webinaire');
        });

        // Fermer modal
        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        document.querySelector('#webinaire-modal .modal-overlay').addEventListener('click', closeModal);

        // Modifier un webinaire
        async function editWebinaire(id) {
            const { data, error } = await supabaseClient
                .from('webinaires')
                .select('*')
                .eq('id', id)
                .single();

            if (error || !data) {
                alert('Erreur lors du chargement');
                return;
            }

            // Remplir les champs
            document.getElementById('webinaire-id').value = data.id;
            document.getElementById('titre').value = data.titre || '';
            document.getElementById('description').value = data.description || '';
            document.getElementById('description_longue').value = data.description_longue || '';
            document.getElementById('date_heure').value = data.date_heure ? data.date_heure.slice(0, 16) : '';
            document.getElementById('statut').value = data.statut || 'a_venir';
            
            // Intervenant
            document.getElementById('speaker_name').value = data.speaker_name || '';
            document.getElementById('speaker_title').value = data.speaker_title || '';
            document.getElementById('speaker_bio').value = data.speaker_bio || '';
            document.getElementById('speaker_avatar').value = data.speaker_avatar || '';
            
            // Liens
            document.getElementById('lien_inscription').value = data.lien_inscription || '';
            document.getElementById('lien_replay').value = data.lien_replay || '';
            document.getElementById('lien_meet').value = data.lien_meet || '';
            
            // Image
            document.getElementById('image_url').value = data.image_url || '';
            
            // Charger les attendus (points cl√©s)
            // Compatibilit√© avec l'ancien champ "attendus" et nouveau "points_cles"
            const pointsCles = data.points_cles || data.attendus || [];
            setAttendus(pointsCles);
            
            // Charger l'image existante
            if (data.image_url) {
                showImagePreview(data.image_url);
                currentImageUrl = data.image_url;
            } else {
                hideImagePreview();
            }
            
            // Charger la photo speaker existante
            if (data.speaker_avatar) {
                showSpeakerPreview(data.speaker_avatar);
                currentSpeakerUrl = data.speaker_avatar;
            } else {
                hideSpeakerPreview();
            }

            openModal('Modifier le webinaire');
        }

        // Soumettre le formulaire
        document.getElementById('webinaire-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btnText = document.querySelector('.btn-text');
            const btnLoader = document.querySelector('.btn-loader');
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';

            const id = document.getElementById('webinaire-id').value;
            
            const webinaire = {
                titre: document.getElementById('titre').value,
                description: document.getElementById('description').value,
                description_longue: document.getElementById('description_longue').value,
                date_heure: document.getElementById('date_heure').value || null,
                statut: document.getElementById('statut').value,
                
                // Intervenant
                speaker_name: document.getElementById('speaker_name').value,
                speaker_title: document.getElementById('speaker_title').value,
                speaker_bio: document.getElementById('speaker_bio').value,
                speaker_avatar: document.getElementById('speaker_avatar').value,
                
                // Liens
                lien_inscription: document.getElementById('lien_inscription').value,
                lien_replay: document.getElementById('lien_replay').value,
                lien_meet: document.getElementById('lien_meet').value,
                
                // Image et points cl√©s
                image_url: document.getElementById('image_url').value,
                points_cles: getAttendus()
            };

            let error;
            if (id) {
                // Update
                ({ error } = await supabaseClient.from('webinaires').update(webinaire).eq('id', id));
            } else {
                // Insert
                ({ error } = await supabaseClient.from('webinaires').insert([webinaire]));
            }

            btnText.style.display = 'inline';
            btnLoader.style.display = 'none';

            if (error) {
                alert('Erreur: ' + error.message);
                return;
            }

            closeModal();
            loadWebinaires();
        });

        // Confirmation suppression
        function confirmDelete(id) {
            currentDeleteId = id;
            document.getElementById('delete-modal').classList.add('active');
        }

        document.getElementById('delete-modal-close').addEventListener('click', () => {
            document.getElementById('delete-modal').classList.remove('active');
        });
        document.getElementById('delete-cancel').addEventListener('click', () => {
            document.getElementById('delete-modal').classList.remove('active');
        });

        // Supprimer
        document.getElementById('delete-confirm').addEventListener('click', async () => {
            if (!currentDeleteId) return;

            const { error } = await supabaseClient
                .from('webinaires')
                .delete()
                .eq('id', currentDeleteId);

            if (error) {
                alert('Erreur: ' + error.message);
                return;
            }

            document.getElementById('delete-modal').classList.remove('active');
            currentDeleteId = null;
            loadWebinaires();
        });

        // D√©connexion
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>