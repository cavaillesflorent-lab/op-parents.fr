<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - OP! Parents</title>
    <meta name="description" content="D√©couvre ton profil financier gr√¢ce √† nos quiz interactifs. Teste ton mindset et progresse √† ton rythme.">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/style-responsive.css">
</head>
<body>
    <!-- HEADER -->
    <div id="header-placeholder"></div>

    <main>
        <!-- HERO -->
        <section class="page-hero">
            <div class="page-hero-content">
                
                <h1>Quel parent √™tes-vous face √† l'argent ?</h1>
                <p>Des quiz rapides pour comprendre vos r√©flexes financiers et savoir par o√π commencer.</p>
            </div>
        </section>

        <!-- STATS -->
        <section class="page-stats-section">
            <div class="page-stats">
                <div class="page-stat">
                    <div class="page-stat-icon">‚úÖ</div>
                    <div class="page-stat-info">
                        <span class="page-stat-value" id="stat-completed">0</span>
                        <span class="page-stat-label">Termin√©s</span>
                    </div>
                </div>
                <div class="page-stat-divider"></div>
                <div class="page-stat">
                    <div class="page-stat-icon">‚è≥</div>
                    <div class="page-stat-info">
                        <span class="page-stat-value" id="stat-in-progress">0</span>
                        <span class="page-stat-label">En cours</span>
                    </div>
                </div>
                <div class="page-stat-divider"></div>
                <div class="page-stat">
                    <div class="page-stat-icon">üìö</div>
                    <div class="page-stat-info">
                        <span class="page-stat-value" id="stat-total">0</span>
                        <span class="page-stat-label">Disponibles</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- FILTRES -->
        <section class="page-filters-section">
            <div class="container">
                <div class="page-filters">
                    <button class="page-filter-btn active" data-filter="all">Tous les quiz</button>
                    <button class="page-filter-btn" data-filter="in-progress">En cours</button>
                    <button class="page-filter-btn" data-filter="completed">Termin√©s</button>
                </div>
            </div>
        </section>

        <!-- LISTE -->
        <section class="page-list-section">
            <div class="container">
                <div class="quiz-grid" id="quiz-list">
                    <div class="loading-state">
                        <div class="quiz-loading-spinner"></div>
                        <p>Chargement des quiz...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA -->
        <section class="page-cta-section">
            <div class="container">
                <div class="page-cta-card">
                    <div class="page-cta-content">
                        <h2>Tu veux aller plus loin ?</h2>
                        <p>D√©couvre nos webinaires pour approfondir ta transformation financi√®re avec des experts.</p>
                    </div>
                    <a href="webinaires.html" class="page-cta-btn">
                        Voir les webinaires
                        <span class="arrow">‚Üí</span>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/components.js"></script>
    <script>
        let currentUser = null;
        let userProgressMap = {}; // Stocke la progression par quiz_slug

        /**
         * R√©cup√®re la progression d'un quiz depuis les donn√©es charg√©es
         */
        function getQuizProgress(quizSlug, totalQuestions) {
            const progress = userProgressMap[quizSlug];
            
            // Pas de progression sauvegard√©e
            if (!progress) {
                return { percent: 0, status: 'not-started', currentQuestion: 0 };
            }
            
            // Quiz termin√© (depuis Supabase)
            if (progress.completed) {
                return { percent: 100, status: 'completed', currentQuestion: totalQuestions };
            }
            
            // Calculer le pourcentage depuis les r√©ponses
            let answered = 0;
            const responses = progress.responses || {};
            
            // Compter les r√©ponses de type quiz
            Object.keys(responses).forEach(key => {
                if (key.startsWith('quiz_') || key.startsWith('poll_')) {
                    answered++;
                }
            });
            
            // Aussi v√©rifier sequenceProgress
            const seqProgress = responses._sequenceProgress || {};
            Object.values(seqProgress).forEach(seq => {
                if (seq && seq.currentSlide) {
                    answered = Math.max(answered, seq.currentSlide);
                }
            });
            
            const percent = totalQuestions > 0 ? Math.min(Math.round((answered / totalQuestions) * 100), 99) : 0;
            
            return {
                percent,
                status: answered > 0 ? 'in-progress' : 'not-started',
                currentQuestion: answered
            };
        }

        function createProgressCircle(percent) {
            const radius = 20;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            const color = percent === 100 ? '#2D403B' : percent > 0 ? '#F2B47E' : '#dee2e0';
            
            return `
                <div class="quiz-card-progress">
                    <svg class="progress-ring" width="52" height="52" viewBox="0 0 52 52">
                        <circle cx="26" cy="26" r="${radius}" fill="none" stroke="#e8e8e8" stroke-width="4"/>
                        <circle cx="26" cy="26" r="${radius}" fill="none" stroke="${color}" stroke-width="4"
                            stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                            transform="rotate(-90 26 26)"/>
                    </svg>
                    <span class="progress-percent">${percent}%</span>
                </div>
            `;
        }

        /**
         * Compte le nombre de questions/slides dans un quiz
         */
        function countQuestionsFromBlocks(blocks) {
            if (!blocks || !Array.isArray(blocks) || blocks.length === 0) {
                return 0;
            }
            
            // Compter les blocs de type quiz
            return blocks.filter(b => b.type === 'quiz').length;
        }

        function createQuizCard(quiz, questionCount) {
            const progress = getQuizProgress(quiz.slug, questionCount);
            
            const statusLabels = {
                'not-started': { text: 'Nouveau', class: 'new', btn: 'Commencer' },
                'in-progress': { text: 'En cours', class: 'progress', btn: 'Continuer' },
                'completed': { text: 'Termin√©', class: 'done', btn: 'Refaire' }
            };
            const status = statusLabels[progress.status];

            const imageHtml = quiz.image_url 
                ? `<img src="${quiz.image_url}" alt="${quiz.titre}" loading="lazy">`
                : `<div class="quiz-card-placeholder"><span>üß†</span></div>`;

            // Afficher le nombre de niveaux si plusieurs s√©quences
            const sequences = quiz.sequences || [];
            const levelsBadge = sequences.length > 1 
                ? `<span style="margin-left: 0.5rem; padding: 0.15rem 0.5rem; background: var(--vert-clair, #DFF2B6); border-radius: 12px; font-size: 0.75rem; color: var(--vert-fonce, #2D403B);">üìö ${sequences.length} niveaux</span>` 
                : '';

            return `
                <article class="quiz-card" data-slug="${quiz.slug}" data-status="${progress.status}">
                    <div class="quiz-card-image">
                        ${imageHtml}
                        <span class="quiz-card-badge ${status.class}">${status.text}</span>
                    </div>
                    <div class="quiz-card-body">
                        <h3 class="quiz-card-title">${quiz.titre}${levelsBadge}</h3>
                        ${quiz.sous_titre ? `<p class="quiz-card-subtitle">${quiz.sous_titre}</p>` : ''}
                        <div class="quiz-card-meta">
                            <span>‚ùì ${questionCount} questions</span>
                            <span>‚è±Ô∏è ${quiz.duree || '5 min'}</span>
                        </div>
                        <div class="quiz-card-footer">
                            ${createProgressCircle(progress.percent)}
                            <a href="guide.html?slug=${quiz.slug}" class="quiz-card-btn ${status.class}">
                                ${status.btn}
                                <span class="arrow">‚Üí</span>
                            </a>
                        </div>
                    </div>
                </article>
            `;
        }

        /**
         * Charge la progression de l'utilisateur depuis Supabase
         */
        async function loadUserProgress() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('user_responses')
                    .select('quiz_slug, responses, completed')
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                // Cr√©er un map slug -> progression
                data?.forEach(row => {
                    userProgressMap[row.quiz_slug] = {
                        responses: row.responses || {},
                        completed: row.completed || false
                    };
                });
                
                console.log('‚úÖ Progression charg√©e:', Object.keys(userProgressMap).length, 'quiz');
            } catch (e) {
                console.error('Erreur chargement progression:', e);
            }
        }

        async function loadQuizzes() {
            try {
                initSupabase();
                
                // V√©rifier l'authentification
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    await loadUserProgress();
                }
                
                // Charger les quiz publi√©s avec blocks et sequences
                const { data: quizzes, error } = await supabaseClient
                    .from('quizzes')
                    .select('*, blocks, sequences')
                    .eq('published', true)
                    .order('ordre', { ascending: true });

                if (error) throw error;

                // Charger aussi le nombre de questions depuis quiz_questions (fallback ancien syst√®me)
                const { data: questions } = await supabaseClient
                    .from('quiz_questions')
                    .select('quiz_id');

                const questionCountsOld = {};
                questions?.forEach(q => {
                    questionCountsOld[q.quiz_id] = (questionCountsOld[q.quiz_id] || 0) + 1;
                });

                const container = document.getElementById('quiz-list');
                
                if (!quizzes || quizzes.length === 0) {
                    container.innerHTML = `
                        <div class="page-empty">
                            <div class="page-empty-icon">üß†</div>
                            <h3>Aucun quiz disponible</h3>
                            <p>Les quiz arrivent tr√®s bient√¥t, reste connect√© !</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = quizzes.map(quiz => {
                    // Priorit√©: compter depuis blocks JSONB, sinon fallback sur quiz_questions
                    let questionCount = countQuestionsFromBlocks(quiz.blocks);
                    if (questionCount === 0) {
                        questionCount = questionCountsOld[quiz.id] || 0;
                    }
                    return createQuizCard(quiz, questionCount);
                }).join('');

                updateStats(quizzes, questionCountsOld);
                setupFilters();

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('quiz-list').innerHTML = `
                    <div class="page-empty">
                        <div class="page-empty-icon">üòï</div>
                        <h3>Oups, une erreur</h3>
                        <p>Impossible de charger les quiz. R√©essaie plus tard.</p>
                        <button onclick="loadQuizzes()" class="retry-btn">R√©essayer</button>
                    </div>
                `;
            }
        }

        function updateStats(quizzes, questionCountsOld) {
            let completed = 0;
            let inProgress = 0;

            quizzes.forEach(quiz => {
                let questionCount = countQuestionsFromBlocks(quiz.blocks);
                if (questionCount === 0) {
                    questionCount = questionCountsOld[quiz.id] || 0;
                }
                const p = getQuizProgress(quiz.slug, questionCount);
                if (p.status === 'completed') completed++;
                else if (p.status === 'in-progress') inProgress++;
            });

            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-in-progress').textContent = inProgress;
            document.getElementById('stat-total').textContent = quizzes.length;
        }

        function setupFilters() {
            document.querySelectorAll('.page-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.page-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const filter = btn.dataset.filter;
                    let hasVisible = false;
                    
                    document.querySelectorAll('.quiz-card').forEach(card => {
                        const status = card.dataset.status;
                        const show = filter === 'all' || 
                            (filter === 'in-progress' && status === 'in-progress') ||
                            (filter === 'completed' && status === 'completed');
                        
                        card.style.display = show ? '' : 'none';
                        if (show) hasVisible = true;
                    });

                    const container = document.getElementById('quiz-list');
                    const existingEmpty = container.querySelector('.filter-empty');
                    if (existingEmpty) existingEmpty.remove();

                    if (!hasVisible && filter !== 'all') {
                        const msg = filter === 'in-progress' 
                            ? "Tu n'as aucun quiz en cours. Commence-en un !" 
                            : "Tu n'as pas encore termin√© de quiz. Lance-toi !";
                        container.insertAdjacentHTML('beforeend', `
                            <div class="filter-empty">
                                <p>${msg}</p>
                            </div>
                        `);
                    }
                });
            });
        }

        document.addEventListener('componentsLoaded', loadQuizzes);
        setTimeout(() => {
            if (document.getElementById('quiz-list').innerHTML.includes('Chargement')) {
                loadQuizzes();
            }
        }, 1500);
    </script>
</body>
</html>