<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation - OP! √âducation financi√®re des parents</title>
    <meta name="description" content="D√©couvrez cette formation sur la gestion financi√®re familiale.">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <!-- HEADER (charg√© dynamiquement) -->
    <div id="header-placeholder"></div>

    <!-- CONTENU FORMATION -->
    <section class="formation-detail-section">
        <div class="container">
            <nav class="breadcrumb">
                <a href="index.html">Accueil</a> &gt; 
                <a href="formations.html">Formations</a> &gt; 
                <span id="breadcrumb-title">Chargement...</span>
            </nav>

            <div class="formation-detail" id="formation-detail">
                <div class="loading-state">
                    <p>Chargement de la formation...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- FOOTER (charg√© dynamiquement) -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/components.js"></script>
    <script>
        // R√©cup√©rer l'ID de la formation depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const formationId = urlParams.get('id');

        // Attendre que les composants soient charg√©s
        document.addEventListener('componentsLoaded', () => {
            initSupabase();
            loadFormation();
        });

        // Charger la formation
        async function loadFormation() {
            if (!formationId) {
                window.location.href = 'formations.html';
                return;
            }

            // Charger la formation
            const { data: formation, error } = await supabaseClient
                .from('formations')
                .select('*')
                .eq('id', formationId)
                .eq('published', true)
                .single();

            if (error || !formation) {
                document.getElementById('formation-detail').innerHTML = `
                    <div class="error-state">
                        <p>Formation non trouv√©e.</p>
                        <a href="formations.html" class="btn btn-primary">Voir toutes les formations</a>
                    </div>
                `;
                return;
            }

            // Charger les modules
            const { data: modules } = await supabaseClient
                .from('modules')
                .select('*')
                .eq('formation_id', formationId)
                .order('ordre', { ascending: true });

            displayFormation(formation, modules || []);
        }

        // Afficher la formation
        function displayFormation(formation, modules) {
            document.title = `${formation.titre} - OP!`;
            document.getElementById('breadcrumb-title').textContent = formation.titre;

            const container = document.getElementById('formation-detail');
            container.innerHTML = `
                <div class="formation-header">
                    ${formation.image_url ? `<img src="${formation.image_url}" alt="${formation.titre}" class="formation-hero-image">` : ''}
                    <h1>${formation.titre}</h1>
                    <p class="formation-description">${formation.description || ''}</p>
                </div>

                <div class="modules-list">
                    <h2>Contenu de la formation</h2>
                    ${modules.length === 0 ? '<p class="empty">Aucun module disponible.</p>' : ''}
                    ${modules.map((module, index) => `
                        <div class="module-item" data-index="${index}">
                            <div class="module-header" onclick="toggleModule(${index})">
                                <span class="module-number">${index + 1}</span>
                                <h3>${module.titre}</h3>
                                <span class="module-type">${getTypeLabel(module.type)}</span>
                                <span class="module-toggle">‚ñº</span>
                            </div>
                            <div class="module-content" id="module-content-${index}">
                                ${renderModuleContent(module)}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="formation-cta">
                    <a href="formations.html" class="btn btn-secondary">‚Üê Retour aux formations</a>
                </div>
            `;
        }

        // Type de module
        function getTypeLabel(type) {
            const labels = {
                'video': 'üé• Vid√©o',
                'pdf': 'üìÑ PDF',
                'texte': 'üìù Texte'
            };
            return labels[type] || type;
        }

        // Contenu du module
        function renderModuleContent(module) {
            switch (module.type) {
                case 'video':
                    const videoUrl = module.contenu_url || '';
                    // Convertir URL YouTube en embed
                    let embedUrl = videoUrl;
                    if (videoUrl.includes('youtube.com/watch')) {
                        const videoId = new URL(videoUrl).searchParams.get('v');
                        embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    } else if (videoUrl.includes('youtu.be/')) {
                        const videoId = videoUrl.split('youtu.be/')[1];
                        embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    }
                    return `
                        <div class="video-container">
                            <iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                        </div>
                    `;
                case 'pdf':
                    return `
                        <div class="pdf-container">
                            <a href="${module.contenu_url}" target="_blank" class="btn btn-primary">
                                üìÑ T√©l√©charger le PDF
                            </a>
                        </div>
                    `;
                case 'texte':
                    return `
                        <div class="text-content">
                            ${module.contenu_texte || ''}
                        </div>
                    `;
                default:
                    return '<p>Contenu non disponible</p>';
            }
        }

        // Toggle module
        function toggleModule(index) {
            const content = document.getElementById(`module-content-${index}`);
            const item = document.querySelector(`.module-item[data-index="${index}"]`);
            
            content.classList.toggle('open');
            item.classList.toggle('expanded');
        }
    </script>
</body>
</html>